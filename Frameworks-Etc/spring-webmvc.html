<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2019-03-22 周五 01:08 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spring Web MVC</title>
<meta name="generator" content="Org mode">
<meta name="author" content="unname">
<link rel='stylesheet' href='/asset/common.css' />
<script src='https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js'></script>
<script src='https://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
<script src='/asset/common.js'></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Spring Web MVC</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8d99729">1. 基本配置</a></li>
<li><a href="#orga84e408">2. DispatcherServlet</a></li>
<li><a href="#org5f5d6f6">3. Controller</a>
<ul>
<li><a href="#orgeb9cd52">3.1. Hello, World</a></li>
<li><a href="#org0048550">3.2. RequestMapping</a></li>
<li><a href="#orgdbd272d">3.3. Handler 参数</a></li>
<li><a href="#orgfbd0030">3.4. Handler 返回</a></li>
<li><a href="#orgff04097">3.5. reqeust data bind to Collection</a>
<ul>
<li><a href="#orgf692307">3.5.1. via FormBean</a></li>
<li><a href="#org88ef04e">3.5.2. via FormBean with Validation</a></li>
<li><a href="#orgbecb932">3.5.3. via Ajax and RequestBody</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgbd19a86">4. DataBinding/Conversion (类型转换)</a>
<ul>
<li><a href="#orgf6e76f0">4.1. 第一种方法：利用内置的 CustomDateEditor</a></li>
<li><a href="#org38b7b82">4.2. 第二种方法：实现自定义 Converter</a></li>
<li><a href="#org666293e">4.3. 第三种方法：使用 @DateTimeFormat 注解</a></li>
</ul>
</li>
<li><a href="#org84eb173">5. DataBinding/Validation (验证)</a>
<ul>
<li><a href="#org30441e4">5.1. JSR-303</a></li>
<li><a href="#orgd1a2d9a">5.2. JSR303 例子</a>
<ul>
<li><a href="#orgc68e743">5.2.1. 一个订单类</a></li>
<li><a href="#orgf62ff4c">5.2.2. 也可以自定义验证器</a></li>
</ul>
</li>
<li><a href="#org8d3635b">5.3. Spring Validator 接口</a></li>
</ul>
</li>
<li><a href="#org440faf2">6. Exception (异常处理)</a>
<ul>
<li><a href="#orgcacdd60">6.1. 使用默认的 DefaultHandlerExceptionResolver 异常处理类</a></li>
<li><a href="#org5bbdf74">6.2. 编程式异常处理</a></li>
<li><a href="#orgd29c5e5">6.3. 自定义 HandlerExceptionResolver，用于全局异常处理</a></li>
<li><a href="#org585e455">6.4. 使用注解的方式 @ExceptionHandler/@ControllerAdvice</a></li>
</ul>
</li>
<li><a href="#orgc743c7f">7. View (视图渲染，服务端渲染)</a>
<ul>
<li><a href="#org196e127">7.1. ViewResolver</a></li>
<li><a href="#org9ed37c6">7.2. Spring JSP Taglib</a></li>
<li><a href="#orgb127db0">7.3. Thymeleaf</a></li>
</ul>
</li>
<li><a href="#org6f6bdd1">8. I18N (国际化)</a></li>
<li><a href="#org1575ae9">9. Theme (主题)</a></li>
<li><a href="#org6d00599">10. File Upload/Download (文件上传、下载)</a>
<ul>
<li><a href="#orgb5dd841">10.1. Upload</a></li>
<li><a href="#org4c13c75">10.2. Download</a></li>
<li><a href="#org1e450aa">10.3. 示例</a></li>
</ul>
</li>
<li><a href="#orgadada0c">11. CORS (Cross Origin Resources Share) 跨域</a>
<ul>
<li><a href="#org4816590">11.1. CorsFilter</a></li>
<li><a href="#org3bb037c">11.2. &lt;mvc:cors&gt;</a></li>
<li><a href="#orgb4c2e33">11.3. @CrossOrigin</a></li>
</ul>
</li>
<li><a href="#org130964b">12. RESTful/前后端分离</a>
<ul>
<li><a href="#org3b5984a">12.1. 编码问题</a></li>
<li><a href="#orgdc78c76">12.2. 跨域问题</a></li>
<li><a href="#org9448e3e">12.3. 结果封装</a></li>
<li><a href="#org1979542">12.4. 统一异常处理</a></li>
</ul>
</li>
<li><a href="#orgdd9d9c7">13. Task TODO</a>
<ul>
<li><a href="#org80108e4">13.1. <span class="done DONE">DONE</span> task</a></li>
<li><a href="#org58c01ce">13.2. <span class="done DONE">DONE</span> sub-task<code>[2/2]</code></a>
<ul>
<li><a href="#orgf177c9d">13.2.1. <span class="done DONE">DONE</span> 任务需要分类</a></li>
<li><a href="#org06108ca">13.2.2. <span class="done DONE">DONE</span> 任务需要制定优先级</a></li>
</ul>
</li>
<li><a href="#org53ed97e">13.3. <span class="todo TODO">TODO</span> 任务示例<code>[1/5]</code></a></li>
</ul>
</li>
</ul>
</div>
</nav>



<section id="outline-container-org8d99729" class="outline-2">
<h2 id="org8d99729"><span class="section-number-2">1</span> 基本配置</h2>
<div class="outline-text-2" id="text-1">
<p>
在 Web.xml 中配置前端控制器，让 Spring MVC 拦截处理所有的请求:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">servlet</span>&gt;
  &lt;<span class="org-function-name">servlet-name</span>&gt;web&lt;/<span class="org-function-name">servlet-name</span>&gt;
  &lt;<span class="org-function-name">servlet-class</span>&gt;org.springframework.web.servlet.DispatcherServlet&lt;/<span class="org-function-name">servlet-class</span>&gt;
  &lt;<span class="org-function-name">init-param</span>&gt;
    &lt;<span class="org-function-name">param-name</span>&gt;contextConfigLocation&lt;/<span class="org-function-name">param-name</span>&gt;
    &lt;<span class="org-function-name">param-value</span>&gt;classpath:spring/web-mvc.xml&lt;/<span class="org-function-name">param-value</span>&gt;
  &lt;/<span class="org-function-name">init-param</span>&gt;
  &lt;<span class="org-function-name">load-on-startup</span>&gt;1&lt;/<span class="org-function-name">load-on-startup</span>&gt;
&lt;/<span class="org-function-name">servlet</span>&gt;
&lt;<span class="org-function-name">servlet-mapping</span>&gt;
  &lt;<span class="org-function-name">servlet-name</span>&gt;web&lt;/<span class="org-function-name">servlet-name</span>&gt;
  &lt;<span class="org-function-name">url-pattern</span>&gt;/&lt;/<span class="org-function-name">url-pattern</span>&gt;
&lt;/<span class="org-function-name">servlet-mapping</span>&gt;
</pre>
</div>

<p>
Spring MVC 在启动的时候会初始化容器，所以需要通过 xml 配置其容器的初始化。Spring-Mvc.xml:
</p>
<div class="org-src-container">
<pre class="src src-sgml"><span class="org-comment-delimiter">&lt;!--</span><span class="org-comment">&#21551;&#29992;&#27880;&#35299;&#25195;&#25551;</span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-sgml-namespace">context</span>:<span class="org-function-name">component-scan</span> <span class="org-variable-name">base-package</span>=<span class="org-string">"com.nf147.post.controller"</span> /&gt;

<span class="org-comment-delimiter">&lt;!--</span><span class="org-comment">&#21551;&#29992; mvc &#30340;&#24120;&#29992;&#27880;&#35299;</span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">annotation-driven</span> <span class="org-variable-name">enable-matrix-variables</span>=<span class="org-string">"true"</span> /&gt;

<span class="org-comment-delimiter">&lt;!--</span><span class="org-comment">&#23558;&#25152;&#26377;&#30340;&#38745;&#24577;&#36164;&#28304;&#20132;&#36824; Servlet &#22788;&#29702;</span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">default-servlet-handler</span> /&gt;

<span class="org-comment-delimiter">&lt;!--</span><span class="org-comment">&#37197;&#32622;&#36820;&#22238;&#39029;&#38754;</span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.web.servlet.view.InternalResourceViewResolver"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"viewClass"</span> <span class="org-variable-name">value</span>=<span class="org-string">"org.springframework.web.servlet.view.JstlView"</span> /&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"prefix"</span> <span class="org-variable-name">value</span>=<span class="org-string">"/WEB-INF/jsp/"</span> /&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"suffix"</span> <span class="org-variable-name">value</span>=<span class="org-string">".jsp"</span> /&gt;
&lt;/<span class="org-function-name">bean</span>&gt;
</pre>
</div>
</div>
</section>

<section id="outline-container-orga84e408" class="outline-2">
<h2 id="orga84e408"><span class="section-number-2">2</span> DispatcherServlet</h2>
<div class="outline-text-2" id="text-2">
<p>
前端控制器，所有来自客户端的请求，都会交由它去处理。
</p>
</div>
</section>

<section id="outline-container-org5f5d6f6" class="outline-2">
<h2 id="org5f5d6f6"><span class="section-number-2">3</span> Controller</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgeb9cd52" class="outline-3">
<h3 id="orgeb9cd52"><span class="section-number-3">3.1</span> Hello, World</h3>
<div class="outline-text-3" id="text-3-1">
<p>
<b>传统方式</b>，使用 Controller 接口:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-comment-delimiter">// </span><span class="org-comment">1. &#23454;&#29616; Controller &#25509;&#21475;&#65292;&#24403;&#28982;&#20063;&#21487;&#20197;&#30452;&#25509;&#20351;&#29992;&#20854;&#20869;&#32622;&#30340;&#23454;&#29616;&#31867;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">2. &#37325;&#20889; handleRequest &#26041;&#27861;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#24847;&#65292;&#26041;&#27861;&#30340;&#36820;&#22238;&#20540;&#26159; ModelAndView</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">FooController</span> <span class="org-keyword">implements</span> <span class="org-type">Controller</span> {
    <span class="org-c-annotation">@Override</span>
    <span class="org-keyword">public</span> <span class="org-type">ModelAndView</span> <span class="org-function-name">handlerRequest</span>(<span class="org-type">HttpServletRequest</span> <span class="org-variable-name">request</span>, <span class="org-type">HttpServletResponse</span> <span class="org-variable-name">response</span>) <span class="org-keyword">throws</span> <span class="org-type">Exception</span> {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">ModelAndView</span>(<span class="org-string">"home"</span>, <span class="org-string">"msg"</span>, <span class="org-string">"hello, this is from Controller interface"</span>); <span class="org-comment-delimiter">// </span><span class="org-comment">&#36820;&#22238; home &#39029;&#38754;&#65292;&#25658;&#24102; ${msg} &#25968;&#25454;</span>
    }
}
<span class="org-comment-delimiter">// </span><span class="org-comment">&lt;bean name="/foo" class="imdemo.controllers.FooController" /&gt;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">curl http://localhost:8888/foo</span>
</pre>
</div>

<p>
<b>注解方式</b>，可让定义变得简单:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Controller</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">FooController</span> {
    <span class="org-c-annotation">@RequestMapping</span>(<span class="org-string">"/a"</span>)
    <span class="org-keyword">public</span> <span class="org-type">ModelAndView</span> <span class="org-function-name">aaa</span>() {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">ModelAndView</span>(<span class="org-string">"home"</span>, <span class="org-string">"msg"</span>, <span class="org-string">"hello, this is from Controller interface"</span>);
    }
    <span class="org-c-annotation">@RequestMapping</span>(<span class="org-string">"/b"</span>)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">bbb</span>(<span class="org-type">Model</span> <span class="org-variable-name">model</span>) {
        model.addAttribute(<span class="org-string">"msg"</span>, <span class="org-string">"hello, this is from Controller interface"</span>);
        <span class="org-keyword">return</span> <span class="org-string">"home"</span>;
    }
}
<span class="org-comment-delimiter">// </span><span class="org-comment">&#19981;&#38656;&#35201;&#23454;&#29616;&#25509;&#21475;&#65292;&#31616;&#21333;&#65292;&#35299;&#32806;&#21512;&#65307;&#19968;&#20010; Controller &#31867;&#21487;&#20197;&#26377;&#22810;&#20010; handler</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#21478;&#27880;&#24847;&#65292;&#38656;&#35201;&#22312;&#37197;&#32622;&#20013;&#21551;&#29992; Component-Scan</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org0048550" class="outline-3">
<h3 id="org0048550"><span class="section-number-3">3.2</span> RequestMapping</h3>
<div class="outline-text-3" id="text-3-2">
<p>
使用 @RequestMapping 来为 handler 绑定映射:
</p>
<pre class="example">
@RequestMapping(value='/foo', method='GET‘, headers=, params=,)
</pre>

<p>
示例:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Controller</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">BookController</span> {
    <span class="org-c-annotation">@Autowired</span> <span class="org-keyword">private</span> <span class="org-type">BookService</span> <span class="org-variable-name">bookService</span>;

    <span class="org-c-annotation">@RequestMapping</span>(value=<span class="org-string">"/books"</span>)
    <span class="org-keyword">public</span> <span class="org-type">ModelAndView</span> <span class="org-function-name">books</span> () {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">ModelAndView</span>(<span class="org-string">"home"</span>, <span class="org-string">"books"</span>, bookService.findAll());
    }

    <span class="org-c-annotation">@RequestMapping</span>(value = <span class="org-string">"/book/{publishDate}"</span>, method = <span class="org-constant">RequestMethod</span>.GET)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">getId</span>(<span class="org-c-annotation">@RequestParam</span> <span class="org-c-annotation">@DateTimeFormat</span>(iso = <span class="org-constant">DateTimeFormat</span>.<span class="org-constant">ISO</span>.DATE) <span class="org-type">Date</span> <span class="org-variable-name">publishDate</span>, <span class="org-type">Model</span> <span class="org-variable-name">model</span>) {
        model.addAttribute(<span class="org-string">"books"</span>, bookService.findByPublishDate(publishDate));
        <span class="org-keyword">return</span> <span class="org-string">"home"</span>;
    }

    <span class="org-c-annotation">@PostMapping</span>(value = <span class="org-string">"/book"</span>)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">insert</span>(<span class="org-c-annotation">@Valid</span> <span class="org-type">Book</span> <span class="org-variable-name">book</span>, <span class="org-type">BindingResult</span> <span class="org-variable-name">result</span>, <span class="org-type">RedirectAttributes</span> <span class="org-variable-name">attributes</span>) {
        <span class="org-keyword">if</span> (result.hasErrors()) {
            <span class="org-keyword">return</span> <span class="org-string">"input"</span>;
        }
        attributes.addAttribute(<span class="org-string">"book"</span>, bookService.createBook(book));
        <span class="org-keyword">return</span> <span class="org-string">"redirect: /books"</span>;
    }

    <span class="org-c-annotation">@DeleteMapping</span>(value = <span class="org-string">"/book/{id}"</span>)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">delete</span>(<span class="org-type">int</span> <span class="org-variable-name">id</span>) {
        bookService.deleteById(id);
        <span class="org-keyword">return</span> <span class="org-string">"home"</span>;
    }

    <span class="org-c-annotation">@GetMapping</span>(<span class="org-string">"/book/{p1}/{p2}"</span>)
    <span class="org-c-annotation">@ResponseBody</span>
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">bookPV</span>(<span class="org-c-annotation">@PathVariable</span> <span class="org-type">int</span> <span class="org-variable-name">p1</span>, <span class="org-c-annotation">@PathVariable</span> <span class="org-type">int</span> <span class="org-variable-name">p2</span>, <span class="org-type">ModelMap</span> <span class="org-variable-name">map</span>) {
        <span class="org-keyword">return</span> String.valueOf(p1 + p2);
    }

    <span class="org-c-annotation">@GetMapping</span>(value = <span class="org-string">"/book/{id:\\d{6}}-{name:[a-z]{3}}"</span>)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">bookWildcard</span>(<span class="org-c-annotation">@PathVariable</span> <span class="org-type">int</span> <span class="org-variable-name">id</span>, <span class="org-c-annotation">@PathVariable</span> <span class="org-type">String</span> <span class="org-variable-name">name</span>, <span class="org-type">Model</span> <span class="org-variable-name">model</span>) {
        model.addAttribute(<span class="org-string">"message"</span>, <span class="org-string">"id: "</span> + id + <span class="org-string">" name:"</span> + name);
        <span class="org-keyword">return</span> <span class="org-string">"debug"</span>;
    }

    <span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#24847;&#65292;&#27492;&#21151;&#33021;&#38656;&#35201;&#22312;&#37197;&#32622;&#25991;&#20214;&#20013;&#21551;&#29992;</span>
    <span class="org-c-annotation">@GetMapping</span>(value = <span class="org-string">"/books/{id}"</span>) <span class="org-comment-delimiter">// </span><span class="org-comment">GET /books/42;q=11;r=22</span>
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">findBook</span>(<span class="org-c-annotation">@PathVariable</span> <span class="org-type">String</span> <span class="org-variable-name">id</span>, <span class="org-c-annotation">@MatrixVariable</span> <span class="org-type">int</span> <span class="org-variable-name">q</span>) {
        <span class="org-comment-delimiter">// </span><span class="org-comment">id == 42</span>
        <span class="org-comment-delimiter">// </span><span class="org-comment">q == 11</span>
    }
}
<span class="org-comment-delimiter">// </span><span class="org-comment">@GetMapping/@PostMapping/@PutMapping/@DeleteMapping/@PatchMapping</span>
</pre>
</div>

<p>
另外，可以使用 @RequestMapping 的参数对请求、响应进行控制:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-comment-delimiter">// </span><span class="org-comment">&#35831;&#27714;&#20869;&#23481;&#31867;&#22411;&#24517;&#39035;&#20026; text/html</span>
<span class="org-c-annotation">@RequestMapping</span>(value=<span class="org-string">"/aaa"</span>, consumes=<span class="org-string">"text/html"</span>);
<span class="org-comment-delimiter">// </span><span class="org-comment">&#23458;&#25143;&#31471;&#25509;&#25910; json &#19988;&#32534;&#30721;&#20026; utf-8</span>
<span class="org-c-annotation">@RequestMapping</span>(value=<span class="org-string">"/bbb"</span>, produces=<span class="org-string">"application/json; charset=UTF-8"</span>);
<span class="org-comment-delimiter">// </span><span class="org-comment">&#35831;&#27714;&#30340;&#21442;&#25968;&#24517;&#39035;&#21253;&#21547; id=215 &#19982; name &#19981;&#31561;&#20110; abc</span>
<span class="org-c-annotation">@RequestMapping</span>(value=<span class="org-string">"/ccc"</span>, params={<span class="org-string">"id=215"</span>, <span class="org-string">"name!=abc"</span>});
<span class="org-comment-delimiter">// </span><span class="org-comment">&#35831;&#27714;&#22836;&#37096;&#20449;&#24687;&#20013;&#24517;&#39035;&#21253;&#21547; Host=localhost:8888</span>
<span class="org-c-annotation">@RequestMapping</span>(value=<span class="org-string">"/ddd"</span>, headers=<span class="org-string">"Host=localhost:8888"</span>);
</pre>
</div>

<p>
本身浏览器支持 GET/POST 方法，为了能使用 DELETE 等请求，需要配置 web.xml:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">filter</span>&gt;
  &lt;<span class="org-function-name">filter-name</span>&gt;hmf&lt;/<span class="org-function-name">filter-name</span>&gt;
  &lt;<span class="org-function-name">filter-class</span>&gt;org.springframework.web.filter.HiddenHttpMethodFilter&lt;/<span class="org-function-name">filter-class</span>&gt;
&lt;/<span class="org-function-name">filter</span>&gt;
&lt;<span class="org-function-name">filter-mapping</span>&gt;
  &lt;<span class="org-function-name">filter-name</span>&gt;hmf&lt;/<span class="org-function-name">filter-name</span>&gt;
  &lt;<span class="org-function-name">url-pattern</span>&gt;/*&lt;/<span class="org-function-name">url-pattern</span>&gt;
&lt;/<span class="org-function-name">filter-mapping</span>&gt;
</pre>
</div>

<p>
然后在 form 表单中添加一个隐藏域 _method="delete"，就可以通过 post 方法模拟 delete 请求了。
也可以通过 form:form 标签简化此操作。
</p>

<p>
当然，ajax 提交自身支持各种 http 方法，就不需要这个过滤器了。
</p>
</div>
</div>

<div id="outline-container-orgdbd272d" class="outline-3">
<h3 id="orgdbd272d"><span class="section-number-3">3.3</span> Handler 参数</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Spring 会根据 handler 参数的类型签名创建并注入相应实例:
</p>
<ul class="org-ul">
<li><code>ServletRequest/ServletResponse/HttpSession/InputStream/OutputStream</code> / <code>Locale/TimeZone/Principal</code></li>
<li><code>WebRequest/NativeWebRequest/HttpMethod/HttpEntity/UriComponentsBuilder/MultipartFile</code></li>
<li><code>Map/Model/ModelMap/RedirectAttributes</code> / <code>Errors/BindingResult</code></li>
</ul>

<p>
对于添加了相关注解的参数，会按照定义进行相关的 Data Binding:
</p>
<ul class="org-ul">
<li><code>@RequestHeader/@CookieValue/@RequestPart</code></li>
<li><code>@ModelAttribute/@SessionAttribute/@RequestAttribute</code></li>
<li><code>@RequestParam/@PathVariable/@MatrixVariable</code></li>
</ul>

<p>
如果参数跟上述的任何一种都不匹配，那么它会根据 <code>BeanUtils#isSimpleProperty</code> 判断:
</p>
<ul class="org-ul">
<li>如果是简单类型，那么它会被解析为 @RequestParam</li>
<li>如果是复杂类型，那么它会被解析为 @ModelAttribute</li>
</ul>

<p>
数据绑定的基本规则，示例如下:
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">描述</th>
<th scope="col" class="org-left">示例</th>
<th scope="col" class="org-left">测试</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><b>基本类型</b></td>
<td class="org-left">按名字进行匹配</td>
<td class="org-left"><code>handler(int id, String title)</code></td>
<td class="org-left">GET /x?id=3&amp;title=hello</td>
</tr>

<tr>
<td class="org-left"><b>普通对象</b></td>
<td class="org-left">通过反射赋值</td>
<td class="org-left"><code>handler(Post post)</code></td>
<td class="org-left">GET /x?id=3&amp;title=hello</td>
</tr>

<tr>
<td class="org-left"><b>复杂对象</b></td>
<td class="org-left">对象里包含对象</td>
<td class="org-left"><code>handler(Post post)</code></td>
<td class="org-left">GET /x?id=3&amp;author.name=luxun</td>
</tr>

<tr>
<td class="org-left"><b>List集合</b></td>
<td class="org-left">使用 [n]</td>
<td class="org-left"><code>handler(FormBean posts)</code></td>
<td class="org-left">POST /x?y[0].id=3&amp;y[1].title=hello</td>
</tr>

<tr>
<td class="org-left"><b>Map集合</b></td>
<td class="org-left">使用 [key]</td>
<td class="org-left"><code>handler(FormBean posts)</code></td>
<td class="org-left">POST /x?y[i].id=3&amp;y[i].title=hello</td>
</tr>
</tbody>
</table>

<hr>

<p>
<b>@ModelAttribute</b>:
</p>

<p>
可以把注解 @ModelAttribute 作用于函数的参数（或者函数上），将其强制转换为 ModelAttribute:
</p>
<ul class="org-ul">
<li>如果在 Model 中已经存在此实例，直接使用</li>
<li>如果在 Model 中没有此实例，那么先在 Model 里创建一个新的，再使用</li>
</ul>

<p>
如果将 @ModelAttribute 放置到方法上:
</p>
<ul class="org-ul">
<li>这个方法将会在 Controller 的任何 handler 调用前都会被执行。[复用]</li>
<li>方法的返回结果，将会被放入到 Model 中。[可用来预备数据]</li>
</ul>
</div>
</div>

<div id="outline-container-orgfbd0030" class="outline-3">
<h3 id="orgfbd0030"><span class="section-number-3">3.4</span> Handler 返回</h3>
<div class="outline-text-3" id="text-3-4">
<p>
主要的返回方式有:
</p>
<ul class="org-ul">
<li><code>ModelAndView/Model/Map/View/String/void</code> / <code>DeferredResult/Callable/ListenableFuture</code></li>
<li><code>@ResponseBody/@ResponseStatus/ResponseEntity</code> / <code>ResponseBodyEmitter/SseEmitter/StreamingResponseBody</code></li>
</ul>

<p>
Spring 提供了两种方法将资源转换为发送给客户端的表述形式:
</p>
<ol class="org-ol">
<li><code>Content Negotiation</code>，选择一个视图，将模型渲染为呈现给客户端的表述形式；</li>
<li><code>Message Conversion</code>，通过一个消息转换器将返回的对象转换为呈现给客户端的表述形式</li>
</ol>

<p>
默认情况下，使用的是第一种方式进行结果渲染:
</p>
<ul class="org-ul">
<li>如果不指定视图，那么将会用请求 url 作为默认视图名</li>
<li>返回结果都会统一被合并为一个 ModelAndView 对象，之后通过 viewResolver 进行选择性渲染</li>
</ul>

<hr>

<p>
重定向与转发:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">RedirectView</span>(<span class="org-string">"xxx"</span>);
<span class="org-keyword">return</span> <span class="org-string">"redirect: /xxx"</span>;
<span class="org-keyword">return</span> <span class="org-string">"forward: /xxx"</span>;
</pre>
</div>

<p>
重定向后，如果想让一些数据在下一次请求中有效，则需要使用 RedirectAttributes:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@RequestMapping</span>(<span class="org-string">"/"</span>)
<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">aaa</span> (<span class="org-type">RedirectAttributes</span> <span class="org-variable-name">attributes</span>) {
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558;&#20250;&#20351;&#29992; url &#37325;&#20889;&#26041;&#24335;&#12290;&#22312;&#19979;&#19968;&#20010;&#39029;&#38754;&#20013;&#65292;&#20351;&#29992; ${param.msg} &#35775;&#38382;</span>
    attributes.addAttribute(<span class="org-string">"msg"</span>, <span class="org-string">"url parameter"</span>);

    <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558;&#20250;&#23558;&#25968;&#25454;&#20445;&#23384;&#22312; session &#20013;&#65292;&#19979;&#19968;&#27425;&#35831;&#27714;&#21518;&#28165;&#38500;&#25481;&#65292;&#20351;&#29992; ${gsm} &#35775;&#38382;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#24847;&#65292;&#36825;&#31181;&#26041;&#24335;&#65292;&#38656;&#35201;&#36716;&#21457;&#21040;&#19968;&#20010;&#26032;&#30340; handler &#35831;&#27714;&#65292;&#19981;&#33021;&#26159;&#19968;&#20010; jsp</span>
    attributes.addFlashAttribute(<span class="org-string">"gsm"</span>, <span class="org-string">"session parameter"</span>);

    <span class="org-keyword">return</span> <span class="org-string">"redirect: /xxx"</span>;
}
</pre>
</div>

<hr>

<p>
如果想使用第二种方式，即直接响应内容而非渲染视图，手段有很多:
</p>
<ol class="org-ol">
<li>在 handler 上添加 <code>@ResponseBody</code> 注解</li>
<li>在 Controller 上添加 <code>@RestController</code> 注解</li>
<li>让 handler 直接返回一个 <code>HttpEntity</code> 对象</li>
<li>当然，如果在 handler 里调用了输出流，也可以导致第一种方式失效</li>
</ol>

<p>
然后，<code>MessageConversion</code> 会根据请求的 Accept 头以及路径中的 jar 包，选择合适的转换器对数据进行转换，比如 <code>MappingJacksonHttpMessageConverter</code>。
</p>

<p>
可以使用这种方式，结合 ajax+json 实现 RESTful 风格的编程，实现前后端的分离。
</p>
</div>
</div>

<div id="outline-container-orgff04097" class="outline-3">
<h3 id="orgff04097"><span class="section-number-3">3.5</span> reqeust data bind to Collection</h3>
<div class="outline-text-3" id="text-3-5">
</div>
<div id="outline-container-orgf692307" class="outline-4">
<h4 id="orgf692307"><span class="section-number-4">3.5.1</span> via FormBean</h4>
<div class="outline-text-4" id="text-3-5-1">
<p>
客户端:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span class="org-function-name">form</span> <span class="org-variable-name">action</span>=<span class="org-string">"/book"</span> <span class="org-variable-name">method</span>=<span class="org-string">"post"</span>&gt;
  &lt;<span class="org-function-name">div</span>&gt;
    &lt;<span class="org-function-name">input</span> <span class="org-variable-name">name</span>=<span class="org-string">"books[0].name"</span>&gt;
    &lt;<span class="org-function-name">input</span> <span class="org-variable-name">name</span>=<span class="org-string">"books[0].price"</span>&gt;
  &lt;/<span class="org-function-name">div</span>&gt;
  &lt;<span class="org-function-name">div</span>&gt;
    &lt;<span class="org-function-name">input</span> <span class="org-variable-name">name</span>=<span class="org-string">"books[1].name"</span>&gt;
    &lt;<span class="org-function-name">input</span> <span class="org-variable-name">name</span>=<span class="org-string">"books[1].price"</span>&gt;
  &lt;/<span class="org-function-name">div</span>&gt;
  &lt;<span class="org-function-name">input</span> <span class="org-variable-name">type</span>=<span class="org-string">"submit"</span>&gt;
&lt;/<span class="org-function-name">form</span>&gt;
</pre>
</div>

<p>
服务端:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@GetMapping</span>(value = <span class="org-string">"/book"</span>)
<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">input</span>() {
    <span class="org-keyword">return</span> <span class="org-string">"input"</span>;
}

<span class="org-c-annotation">@PostMapping</span>(value = <span class="org-string">"/book"</span>)
<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">add</span>(<span class="org-type">FormBean</span> <span class="org-variable-name">fb</span>) {
    <span class="org-keyword">return</span> <span class="org-string">"home"</span>;
}
</pre>
</div>

<p>
必须一个 FormBean 作为中间数据载体，FormBean 又称 VO
</p>
</div>
</div>

<div id="outline-container-org88ef04e" class="outline-4">
<h4 id="org88ef04e"><span class="section-number-4">3.5.2</span> via FormBean with Validation</h4>
<div class="outline-text-4" id="text-3-5-2">
<p>
如果想要捕获错误，并回显，需要改造。
</p>

<p>
客户端:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span class="org-sgml-namespace">form</span>:<span class="org-function-name">form</span> <span class="org-variable-name">action</span>=<span class="org-string">"/book"</span> <span class="org-variable-name">method</span>=<span class="org-string">"post"</span> <span class="org-variable-name">modelAttribute</span>=<span class="org-string">"formBean"</span>&gt;
  &lt;<span class="org-function-name">div</span>&gt;
    &lt;<span class="org-sgml-namespace">form</span>:<span class="org-function-name">input</span> <span class="org-variable-name">path</span>=<span class="org-string">"books[0].name"</span> /&gt;
    &lt;<span class="org-sgml-namespace">form</span>:<span class="org-function-name">input</span> <span class="org-variable-name">path</span>=<span class="org-string">"books[0].price"</span> /&gt;
    &lt;<span class="org-sgml-namespace">form</span>:<span class="org-function-name">errors</span> <span class="org-variable-name">path</span>=<span class="org-string">"books[0]*"</span> <span class="org-variable-name">element</span>=<span class="org-string">"footer"</span> /&gt;
  &lt;/<span class="org-function-name">div</span>&gt;
  &lt;<span class="org-function-name">div</span>&gt;
    &lt;<span class="org-sgml-namespace">form</span>:<span class="org-function-name">input</span> <span class="org-variable-name">path</span>=<span class="org-string">"books[1].name"</span> /&gt;
    &lt;<span class="org-sgml-namespace">form</span>:<span class="org-function-name">input</span> <span class="org-variable-name">path</span>=<span class="org-string">"books[1].price"</span> /&gt;
    &lt;<span class="org-sgml-namespace">form</span>:<span class="org-function-name">errors</span> <span class="org-variable-name">path</span>=<span class="org-string">"books[1]*"</span> <span class="org-variable-name">element</span>=<span class="org-string">"footer"</span> /&gt;
  &lt;/<span class="org-function-name">div</span>&gt;
  &lt;<span class="org-function-name">input</span> <span class="org-variable-name">type</span>=<span class="org-string">"submit"</span>&gt;
&lt;/<span class="org-sgml-namespace">form</span>:<span class="org-function-name">form</span>&gt;
</pre>
</div>

<p>
服务端:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@GetMapping</span>(value = <span class="org-string">"/book"</span>)
<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">input</span>(<span class="org-type">FormBean</span> <span class="org-variable-name">fb</span>) {
    <span class="org-keyword">return</span> <span class="org-string">"input"</span>;
}

<span class="org-c-annotation">@PostMapping</span>(value = <span class="org-string">"/book"</span>)
<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">add</span>(<span class="org-type">FormBean</span> <span class="org-variable-name">fb</span>, <span class="org-type">BindingResult</span> <span class="org-variable-name">result</span>) {
    <span class="org-keyword">return</span> result.hasErrors() ? <span class="org-string">"input"</span> : <span class="org-string">"home"</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbecb932" class="outline-4">
<h4 id="orgbecb932"><span class="section-number-4">3.5.3</span> via Ajax and RequestBody</h4>
<div class="outline-text-4" id="text-3-5-3">
<p>
客户端:
</p>
<div class="org-src-container">
<pre class="src src-js">fetch(<span class="org-string">'/book'</span>, {
    method:<span class="org-string">'POST'</span>,
    headers: { <span class="org-string">"Content-Type"</span>: <span class="org-string">"application/json"</span> },
    body: JSON.stringify([{<span class="org-string">"name"</span>: <span class="org-string">"peace"</span>, <span class="org-string">"price"</span>: <span class="org-string">"32"</span>},{<span class="org-string">"name"</span>: <span class="org-string">"kkkk"</span>, <span class="org-string">"price"</span>: <span class="org-string">"21"</span>}])
}).then(resp =&gt; resp.text()).then(console.log).<span class="org-keyword">catch</span>(console.error);
</pre>
</div>

<p>
服务端:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@ResponseBody</span>
<span class="org-c-annotation">@PostMapping</span>(<span class="org-string">"/book"</span>)
<span class="org-keyword">public</span> <span class="org-type">int</span> <span class="org-function-name">add</span>(<span class="org-c-annotation">@RequestBody</span> <span class="org-type">List</span>&lt;<span class="org-type">Book</span>&gt; <span class="org-variable-name">books</span>) {
    dao.save(books);
    <span class="org-keyword">return</span> 1;
}
</pre>
</div>

<p>
注意，这种方式，不能使用 BindingResult 的方式捕获异常（因为不是 Modelattribute..），所以，只能靠捕获异常，比如捕获 <code>HttpMessageNotReadableException</code> 等。
</p>
</div>
</div>
</div>
</section>

<section id="outline-container-orgbd19a86" class="outline-2">
<h2 id="orgbd19a86"><span class="section-number-2">4</span> DataBinding/Conversion (类型转换)</h2>
<div class="outline-text-2" id="text-4">
<p>
三种方式:
</p>
<ol class="org-ol">
<li>PropertyEditor</li>
<li>Convertor</li>
<li>Formatter</li>
</ol>

<p>
日期转换为例。
</p>
</div>

<div id="outline-container-orgf6e76f0" class="outline-3">
<h3 id="orgf6e76f0"><span class="section-number-3">4.1</span> 第一种方法：利用内置的 CustomDateEditor</h3>
<div class="outline-text-3" id="text-4-1">
<p>
首先，在我们的 Controller 的 InitBinder 里面，注册 CustomEditor
</p>

<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@InitBinder</span>
<span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">init</span> (<span class="org-type">WebDataBinder</span> <span class="org-variable-name">binder</span>) {
    <span class="org-type">CustomDateEditor</span> <span class="org-variable-name">dateEditor</span> = <span class="org-keyword">new</span> <span class="org-type">CustomDateEditor</span>(<span class="org-keyword">new</span> <span class="org-type">SimpleDateFormat</span>(<span class="org-string">"yyyy-MM-dd"</span>), <span class="org-constant">true</span>);
    binder.registerCustomEditor(Date.<span class="org-keyword">class</span>, dateEditor);
}
</pre>
</div>

<p>
然后，就可以正常转换了。
</p>
</div>
</div>

<div id="outline-container-org38b7b82" class="outline-3">
<h3 id="org38b7b82"><span class="section-number-3">4.2</span> 第二种方法：实现自定义 Converter</h3>
<div class="outline-text-3" id="text-4-2">
<p>
定义:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">MyDateConverter</span> <span class="org-keyword">implements</span> <span class="org-type">Converter</span>&lt;<span class="org-type">String</span>, <span class="org-type">Date</span>&gt; {
    <span class="org-keyword">public</span> <span class="org-type">Date</span> <span class="org-function-name">convert</span>(<span class="org-type">String</span> <span class="org-variable-name">datestr</span>) {
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#21482;&#26159;&#31034;&#20363;&#65292;&#23454;&#38469;&#35201;&#32771;&#34385;&#26356;&#22810;&#65292;&#27604;&#22914;&#24322;&#24120;&#22788;&#29702;&#31561;</span>
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">SimpleDateFormat</span>(<span class="org-string">"yyyy-MM-dd"</span>).parse(<span class="org-string">"2011-10-23"</span>);
    }
}
</pre>
</div>

<p>
然后配置并注册 ConversionService:
</p>
<div class="org-src-container">
<pre class="src src-xml"><span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">bean</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"conversionService"</span> <span class="org-nxml-attribute-local-name">class</span>=<span class="org-string">"org.springframework.context.support.ConversionServiceFactoryBean"</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">property</span> <span class="org-nxml-attribute-local-name">name</span>=<span class="org-string">"converters"</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">set</span><span class="org-nxml-tag-delimiter">&gt;</span>
      <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-local-name">bean</span> <span class="org-nxml-attribute-local-name">class</span>=<span class="org-string">"imdemo.converter.MyDateConverter"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
    <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">set</span><span class="org-nxml-tag-delimiter">&gt;</span>
  <span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">property</span><span class="org-nxml-tag-delimiter">&gt;</span>
<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-tag-slash">/</span><span class="org-nxml-element-local-name">bean</span><span class="org-nxml-tag-delimiter">&gt;</span>

<span class="org-nxml-tag-delimiter">&lt;</span><span class="org-nxml-element-prefix">mvc</span><span class="org-nxml-element-colon">:</span><span class="org-nxml-element-local-name">annotation-driven</span> <span class="org-nxml-attribute-local-name">conversion-service</span>=<span class="org-string">"conversionService"</span> <span class="org-nxml-tag-slash">/</span><span class="org-nxml-tag-delimiter">&gt;</span>
</pre>
</div>

<p>
这样就可以了。所有的 yyyy-MM-yy 之类的字符串就可以正常自动转换成 Date 对象了。
</p>
</div>
</div>

<div id="outline-container-org666293e" class="outline-3">
<h3 id="org666293e"><span class="section-number-3">4.3</span> 第三种方法：使用 @DateTimeFormat 注解</h3>
<div class="outline-text-3" id="text-4-3">
<p>
在 model 上，增加相应注解：
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">class</span> <span class="org-type">Book</span> {
  <span class="org-c-annotation">@DateTimeFormat</span>(pattern = <span class="org-string">"yyyy-MM-dd"</span>)
  <span class="org-keyword">private</span> <span class="org-type">Date</span> <span class="org-variable-name">created_at</span>;
}
</pre>
</div>

<p>
就可以了。
</p>

<p>
另外，如果想让返回的 JSON 对象中能够准确处理时间类型，需要用到 @JsonFormat 注解
</p>

<p>
Spring 还内置了一些 Formatter 实现:
</p>
<ul class="org-ul">
<li>NumberFormatter，处理数字类型(比如 1, 000, 1000 格式的数据)</li>
<li>PercentFormatter，处理百分号数字</li>
<li>CurrencyFormatter，处理货币类型</li>
</ul>
</div>
</div>
</section>

<section id="outline-container-org84eb173" class="outline-2">
<h2 id="org84eb173"><span class="section-number-2">5</span> DataBinding/Validation (验证)</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org30441e4" class="outline-3">
<h3 id="org30441e4"><span class="section-number-3">5.1</span> JSR-303</h3>
<div class="outline-text-3" id="text-5-1">
<p>
JSR-303 是 java 官方推出的一套 Validation 接口。
</p>

<p>
hibernate 给出了一个完整实现:
</p>
<pre class="example">
complie "org.hibernate:hibernate-validator:5.4.0.Final"
</pre>

<p>
引入 jar 包后，添加验证逻辑，它使用的是一系列注解:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">book</span> {
    <span class="org-c-annotation">@notnull</span>
    <span class="org-c-annotation">@size</span>(min = 3, max = 10)
    <span class="org-keyword">private</span> <span class="org-type">string</span> <span class="org-variable-name">name</span>;

    <span class="org-c-annotation">@range</span>(min = 10, max = 100)
    <span class="org-keyword">private</span> <span class="org-type">int</span> <span class="org-variable-name">count</span>;
}
</pre>
</div>

<p>
最后，只要在 Controller 的相关字段上添加 <code>@Valid</code> 注解即可启用验证:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">submit</span>(<span class="org-c-annotation">@Valid</span> <span class="org-type">Book</span> <span class="org-variable-name">book</span>, <span class="org-type">Errors</span> <span class="org-variable-name">errors</span>) {
    <span class="org-keyword">if</span> (errors.hasErrors()) {
        <span class="org-keyword">return</span> <span class="org-string">"input"</span>;
    }
    System.out.println(<span class="org-string">"normal flow"</span>);
    <span class="org-keyword">return</span> <span class="org-string">"home"</span>;
}
</pre>
</div>

<p>
Bean Validation 中内置的 constraint:
</p>
<ul class="org-ul">
<li><code>@Null</code>   被注释的元素必须为 null</li>
<li><code>@NotNull</code>    被注释的元素必须不为 null</li>
<li><code>@AssertTrue</code>     被注释的元素必须为 true</li>
<li><code>@AssertFalse</code>    被注释的元素必须为 false</li>
<li><code>@Min(value)</code>     被注释的元素必须是一个数字，其值必须大于等于指定的最小值</li>
<li><code>@Max(value)</code>     被注释的元素必须是一个数字，其值必须小于等于指定的最大值</li>
<li><code>@DecimalMin(value)</code>  被注释的元素必须是一个数字，其值必须大于等于指定的最小值</li>
<li><code>@DecimalMax(value)</code>  被注释的元素必须是一个数字，其值必须小于等于指定的最大值</li>
<li><code>@Size(max=, min=)</code>   被注释的元素的大小必须在指定的范围内</li>
<li><code>@Digits(integer, fraction)</code>     被注释的元素必须是一个数字，其值必须在可接受的范围内</li>
<li><code>@Past</code>   被注释的元素必须是一个过去的日期</li>
<li><code>@Future</code>     被注释的元素必须是一个将来的日期</li>
<li><code>@Pattern(regex=,flag=)</code>  被注释的元素必须符合指定的正则表达式</li>
</ul>

<p>
Hibernate Validator 附加的 constraint:
</p>
<ul class="org-ul">
<li><code>@NotBlank</code>   验证字符串非null，且长度必须大于0</li>
<li><code>@Email</code>  被注释的元素必须是电子邮箱地址</li>
<li><code>@Length(min=,max=)</code>  被注释的字符串的大小必须在指定的范围内</li>
<li><code>@NotEmpty</code>   被注释的字符串的必须非空</li>
<li><code>@Range(min=,max=,message=)</code>  被注释的元素必须在合适的范围内</li>
</ul>

<p>
另，自定义 JSR303 验证器，只需要:
</p>
<ol class="org-ol">
<li>定义验证注解</li>
<li>增加验证器(ConstraintValidator)</li>
<li>正常使用</li>
</ol>
</div>
</div>

<div id="outline-container-orgd1a2d9a" class="outline-3">
<h3 id="orgd1a2d9a"><span class="section-number-3">5.2</span> JSR303 例子</h3>
<div class="outline-text-3" id="text-5-2">
</div>
<div id="outline-container-orgc68e743" class="outline-4">
<h4 id="orgc68e743"><span class="section-number-4">5.2.1</span> 一个订单类</h4>
<div class="outline-text-4" id="text-5-2-1">
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Order</span> {

    <span class="org-comment-delimiter">// </span><span class="org-comment">&#24517;&#39035;&#26159; 10 &#20301;</span>
    <span class="org-c-annotation">@NotBlank</span>
    <span class="org-c-annotation">@Size</span>(min = 10, max = 10)
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">orderId</span>;

    <span class="org-c-annotation">@NotBlank</span>
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">customer</span>;

    <span class="org-c-annotation">@Email</span>
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">email</span>;

    <span class="org-c-annotation">@Pattern</span>(regexp = <span class="org-string">"^[0-9]{11}$"</span>) <span class="org-comment-delimiter">//</span><span class="org-comment">?</span>
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">telephone</span>;

    <span class="org-c-annotation">@NotBlank</span>
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">address</span>;

    <span class="org-comment-delimiter">// </span><span class="org-comment">created paid shipped closed</span>
    <span class="org-c-annotation">@NotEmpty</span>
    <span class="org-c-annotation">@Pattern</span>(regexp = <span class="org-string">"^(created|paid|shipped|closed)$"</span>)
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">status</span>;

    <span class="org-c-annotation">@DateTimeFormat</span>(pattern = <span class="org-string">"yyyy-MM-dd"</span>)
    <span class="org-c-annotation">@NotNull</span>
    <span class="org-c-annotation">@Past</span>
    <span class="org-keyword">private</span> <span class="org-type">Date</span> <span class="org-variable-name">createDate</span>;

    <span class="org-c-annotation">@NotNull</span>
    <span class="org-c-annotation">@Valid</span>
    <span class="org-keyword">private</span> <span class="org-type">Product</span> <span class="org-variable-name">product</span>;
}

<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Product</span> {
    <span class="org-c-annotation">@NotBlank</span>
    <span class="org-keyword">private</span> <span class="org-type">String</span> <span class="org-variable-name">name</span>;

    <span class="org-comment-delimiter">//</span><span class="org-comment">@Range(max = 100000, min = 10)</span>
    <span class="org-c-annotation">@Min</span>(100)
    <span class="org-c-annotation">@Max</span>(10000)
    <span class="org-keyword">private</span> <span class="org-type">Float</span> <span class="org-variable-name">price</span>;

    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">getName</span>() {
        <span class="org-keyword">return</span> name;
    }
}

<span class="org-comment-delimiter">///////////////////////////////////////</span>

<span class="org-c-annotation">@Controller</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">OrderController</span> {
    <span class="org-c-annotation">@RequestMapping</span>(value = <span class="org-string">"/order"</span>, method = <span class="org-constant">RequestMethod</span>.POST)
    <span class="org-c-annotation">@ResponseBody</span>
    <span class="org-keyword">public</span> <span class="org-type">Order</span> <span class="org-function-name">order</span> (<span class="org-c-annotation">@Valid</span> <span class="org-c-annotation">@RequestBody</span> <span class="org-type">Order</span> <span class="org-variable-name">order</span>, <span class="org-type">BindingResult</span> <span class="org-variable-name">result</span>) {
        <span class="org-keyword">return</span> order;
    }
}
</pre>
</div>

<p>
客户端调用测试:
</p>
<div class="org-src-container">
<pre class="src src-js">fetch(<span class="org-string">'/order'</span>, {
    method: <span class="org-string">'post'</span>,
    headers: { <span class="org-string">'Content-Type'</span>: <span class="org-string">'application/json'</span> },
    body: JSON.stringify({
        orderId: <span class="org-string">'1234567888'</span>,
        customer: <span class="org-string">'tom'</span>,
        telephone: <span class="org-string">'10000000000'</span>,
        address: <span class="org-string">'hello, zhuhai'</span>,
        email: <span class="org-string">'232@ksdjfk.com'</span>,
        createDate: <span class="org-string">'2014-12-11'</span>,
        status: <span class="org-string">'paid'</span>,
        product: {
            name: <span class="org-string">'ipone'</span>,
            price: 9000
        }
    })
}).then(resp =&gt; resp.json())
    .then(console.log)
    .<span class="org-keyword">catch</span>(console.error);

</pre>
</div>
</div>
</div>

<div id="outline-container-orgf62ff4c" class="outline-4">
<h4 id="orgf62ff4c"><span class="section-number-4">5.2.2</span> 也可以自定义验证器</h4>
<div class="outline-text-4" id="text-5-2-2">
<p>
最简单的，组合已有的验证器:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Min</span>(100)
<span class="org-c-annotation">@Max</span>(10000)
<span class="org-c-annotation">@Target</span>({ METHOD, <span class="org-type">FIELD</span>, <span class="org-type">ANNOTATION_TYPE</span>, <span class="org-type">CONSTRUCTOR</span>, <span class="org-type">PARAMETER</span>, TYPE_USE })
<span class="org-c-annotation">@Retention</span>(<span class="org-type">RUNTIME</span>)
<span class="org-c-annotation">@Documented</span>
<span class="org-c-annotation">@Constraint</span>(validatedBy = { })
<span class="org-keyword">public</span> <span class="org-keyword">@interface</span> <span class="org-type">Price</span> {
    <span class="org-type">Class</span>&lt;?&gt;[] <span class="org-function-name">groups</span>() <span class="org-keyword">default</span> { };
    <span class="org-type">Class</span>&lt;? <span class="org-keyword">extends</span> <span class="org-type">Payload</span>&gt;[] <span class="org-function-name">payload</span>() <span class="org-keyword">default</span> { };
}
</pre>
</div>

<p>
也可以自己实现相同逻辑:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Target</span>({<span class="org-constant">ElementType</span>.ANNOTATION_TYPE, <span class="org-constant">ElementType</span>.<span class="org-type">METHOD</span>, <span class="org-constant">ElementType</span>.FIELD})
<span class="org-c-annotation">@Retention</span>(<span class="org-constant">RetentionPolicy</span>.<span class="org-type">RUNTIME</span>)
<span class="org-c-annotation">@Constraint</span>(validatedBy =  PriceRangeValidator.<span class="org-keyword">class</span> )
<span class="org-keyword">public</span> <span class="org-keyword">@interface</span> <span class="org-type">PriceRange</span> {
    <span class="org-type">String</span> <span class="org-function-name">message</span>() <span class="org-keyword">default</span> <span class="org-string">"&#20215;&#26684;&#19981;&#21512;&#29702;"</span>;
    <span class="org-type">float</span> <span class="org-function-name">min</span>() <span class="org-keyword">default</span> 0;
    <span class="org-type">float</span> <span class="org-function-name">max</span>() <span class="org-keyword">default</span> 10000;

    <span class="org-type">Class</span>&lt;?&gt;[] <span class="org-function-name">groups</span>() <span class="org-keyword">default</span> { };
    <span class="org-type">Class</span>&lt;? <span class="org-keyword">extends</span> <span class="org-type">Payload</span>&gt;[] <span class="org-function-name">payload</span>() <span class="org-keyword">default</span> { };
}

<span class="org-keyword">class</span> <span class="org-type">PriceRangeValidator</span> <span class="org-keyword">implements</span> <span class="org-type">ConstraintValidator</span>&lt;<span class="org-type">PriceRange</span>, <span class="org-type">Float</span>&gt; {
    <span class="org-keyword">private</span> <span class="org-type">float</span> <span class="org-variable-name">min</span>, <span class="org-variable-name">max</span>;

    <span class="org-c-annotation">@Override</span>
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">initialize</span>(<span class="org-type">PriceRange</span> <span class="org-variable-name">constraintAnnotation</span>) {
        min = constraintAnnotation.min();
        max = constraintAnnotation.max();
    }

    <span class="org-c-annotation">@Override</span>
    <span class="org-keyword">public</span> <span class="org-type">boolean</span> <span class="org-function-name">isValid</span>(<span class="org-type">Float</span> <span class="org-variable-name">price</span>, <span class="org-type">ConstraintValidatorContext</span> <span class="org-variable-name">context</span>) {
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#35760;&#36733;&#25968;&#25454;&#24211;&#65292;&#22806;&#37096; xml</span>
        <span class="org-keyword">return</span> price &gt;= min &amp;&amp; price &lt;= max;
    }
}
</pre>
</div>

<p>
@CellPhone:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Target</span>({<span class="org-constant">ElementType</span>.ANNOTATION_TYPE, <span class="org-constant">ElementType</span>.<span class="org-type">METHOD</span>, <span class="org-constant">ElementType</span>.FIELD})
<span class="org-c-annotation">@Retention</span>(<span class="org-constant">RetentionPolicy</span>.<span class="org-type">RUNTIME</span>)
<span class="org-c-annotation">@Constraint</span>(validatedBy = CellPhoneValidator.<span class="org-keyword">class</span>)
<span class="org-keyword">public</span> <span class="org-keyword">@interface</span> <span class="org-type">CellPhone</span> {
    <span class="org-type">String</span> <span class="org-function-name">message</span>() <span class="org-keyword">default</span> <span class="org-string">"&#19981;&#26159;&#21512;&#27861;&#30340;&#25163;&#26426;&#32534;&#21495;&#65292;&#24212;&#35813;&#26159;11&#20301;"</span>;

    <span class="org-type">Class</span>&lt;?&gt;[] <span class="org-function-name">groups</span>() <span class="org-keyword">default</span> {};

    <span class="org-type">Class</span>&lt;? <span class="org-keyword">extends</span> <span class="org-type">Payload</span>&gt;[] <span class="org-function-name">payload</span>() <span class="org-keyword">default</span> {};
}

<span class="org-keyword">class</span> <span class="org-type">CellPhoneValidator</span> <span class="org-keyword">implements</span> <span class="org-type">ConstraintValidator</span>&lt;<span class="org-type">CellPhone</span>, <span class="org-type">String</span>&gt; {
    <span class="org-c-annotation">@Override</span>
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">initialize</span>(<span class="org-type">CellPhone</span> <span class="org-variable-name">constraintAnnotation</span>) {
    }

    <span class="org-c-annotation">@Override</span>
    <span class="org-keyword">public</span> <span class="org-type">boolean</span> <span class="org-function-name">isValid</span>(<span class="org-type">String</span> <span class="org-variable-name">value</span>, <span class="org-type">ConstraintValidatorContext</span> <span class="org-variable-name">context</span>) {
        <span class="org-keyword">return</span> value != <span class="org-constant">null</span> &amp;&amp; Pattern.matches(<span class="org-string">"^[0-9]{11}$"</span>, value);
    }
}
</pre>
</div>

<p>
@OrderStatus:
</p>
<div class="org-src-container">
<pre class="src src-java">Target({<span class="org-constant">ElementType</span>.ANNOTATION_TYPE, <span class="org-constant">ElementType</span>.METHOD, <span class="org-constant">ElementType</span>.FIELD})
<span class="org-c-annotation">@Retention</span>(<span class="org-constant">RetentionPolicy</span>.RUNTIME)
<span class="org-c-annotation">@NotEmpty</span>
<span class="org-c-annotation">@Constraint</span>(validatedBy =  OrderStatusValidator.<span class="org-keyword">class</span> )
<span class="org-keyword">public</span> <span class="org-keyword">@interface</span> OrderStatus {
    <span class="org-type">String</span> <span class="org-function-name">message</span>() <span class="org-keyword">default</span> <span class="org-string">"&#19981;&#26159;&#21512;&#27861;&#30340;&#29366;&#24577;&#65292;&#21482;&#33021;&#26159; created/paid/shipped/closed &#20013;&#30340;&#19968;&#20010;"</span>;

    <span class="org-type">Class</span>&lt;?&gt;[] <span class="org-function-name">groups</span>() <span class="org-keyword">default</span> { };
    <span class="org-type">Class</span>&lt;? <span class="org-keyword">extends</span> <span class="org-type">Payload</span>&gt;[] <span class="org-function-name">payload</span>() <span class="org-keyword">default</span> { };
}

<span class="org-keyword">class</span> <span class="org-type">OrderStatusValidator</span> <span class="org-keyword">implements</span> <span class="org-type">ConstraintValidator</span>&lt;<span class="org-type">OrderStatus</span>, <span class="org-type">String</span>&gt; {
    <span class="org-c-annotation">@Override</span>
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">initialize</span>(<span class="org-type">OrderStatus</span> <span class="org-variable-name">constraintAnnotation</span>) {
    }

    <span class="org-c-annotation">@Override</span>
    <span class="org-keyword">public</span> <span class="org-type">boolean</span> <span class="org-function-name">isValid</span>(<span class="org-type">String</span> <span class="org-variable-name">status</span>, <span class="org-type">ConstraintValidatorContext</span> <span class="org-variable-name">context</span>) {
        <span class="org-keyword">return</span> Arrays.asList(<span class="org-string">"created"</span>, <span class="org-string">"paid22"</span>, <span class="org-string">"shipped"</span>, <span class="org-string">"closed"</span>).contains(status);
    }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8d3635b" class="outline-3">
<h3 id="org8d3635b"><span class="section-number-3">5.3</span> Spring Validator 接口</h3>
<div class="outline-text-3" id="text-5-3">
<p>
这是 Spring 验证的标准接口。使用分 <b>3</b> 步:
</p>
<ol class="org-ol">
<li>定义实现类</li>
<li>注册(配置到 Controller 或通过配置文件配置到全局)</li>
<li>配合 @Validated 注解使用</li>
</ol>

<p>
基本过程: 
</p>
<span style="font-size:4em;color:red;">略</span><br><br><br>
</div>
</div>
</section>

<section id="outline-container-org440faf2" class="outline-2">
<h2 id="org440faf2"><span class="section-number-2">6</span> Exception (异常处理)</h2>
<div class="outline-text-2" id="text-6">
</div>
<div id="outline-container-orgcacdd60" class="outline-3">
<h3 id="orgcacdd60"><span class="section-number-3">6.1</span> 使用默认的 DefaultHandlerExceptionResolver 异常处理类</h3>
</div>
<div id="outline-container-org5bbdf74" class="outline-3">
<h3 id="org5bbdf74"><span class="section-number-3">6.2</span> 编程式异常处理</h3>
<div class="outline-text-3" id="text-6-2">
<p>
在代码中，使用 try&#x2026;catch 的方式，将所有（相关的）异常，全都处理妥当。
</p>

<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">add</span>(<span class="org-type">Emp</span> <span class="org-variable-name">emp</span>, <span class="org-type">Model</span> <span class="org-variable-name">model</span>) {
    <span class="org-keyword">try</span> {
        empService.addEmp(emp);
    } <span class="org-keyword">catch</span> (<span class="org-type">DbException</span> <span class="org-variable-name">e</span>) {
        model.addAttribute(<span class="org-string">"msg"</span>, e);
        <span class="org-keyword">return</span> <span class="org-string">"warn"</span>;
    } <span class="org-keyword">catch</span> (<span class="org-type">DataException</span> <span class="org-variable-name">e</span>) {
        model.addAttribute(<span class="org-string">"msg"</span>, e.getMessage());
        <span class="org-keyword">return</span> <span class="org-string">"input"</span>;
    } <span class="org-keyword">catch</span> (<span class="org-type">MyBatisSystemException</span> <span class="org-variable-name">e</span>) {
        <span class="org-keyword">return</span> <span class="org-string">"unknown err"</span>;
    } <span class="org-keyword">catch</span> (<span class="org-type">Exception</span> <span class="org-variable-name">e</span>) {
        <span class="org-keyword">return</span> <span class="org-string">"unknown err"</span>;
    }

    <span class="org-keyword">return</span> <span class="org-string">"success"</span>;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd29c5e5" class="outline-3">
<h3 id="orgd29c5e5"><span class="section-number-3">6.3</span> 自定义 HandlerExceptionResolver，用于全局异常处理</h3>
<div class="outline-text-3" id="text-6-3">
<p>
首先，定义一个 MyExceptionResolver 异常处理类:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">MyExceptionResolver</span> <span class="org-keyword">extends</span> <span class="org-type">AbstractHandlerExceptionResolver</span> {
    <span class="org-c-annotation">@Override</span>
    <span class="org-keyword">protected</span> <span class="org-type">ModelAndView</span> <span class="org-function-name">doResolveException</span>(<span class="org-type">HttpServletRequest</span> <span class="org-variable-name">request</span>, <span class="org-type">HttpServletResponse</span> <span class="org-variable-name">response</span>, <span class="org-type">Object</span> <span class="org-variable-name">handler</span>, <span class="org-type">Exception</span> <span class="org-variable-name">ex</span>) {
        <span class="org-keyword">if</span> (ex <span class="org-keyword">instanceof</span> DbException) {
            <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">ModelAndView</span>(<span class="org-string">"shujukucuowu"</span>);
        } <span class="org-keyword">else</span> <span class="org-keyword">if</span> (ex <span class="org-keyword">instanceof</span> TypeMismatchException) {
            <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">ModelAndView</span>(<span class="org-string">"shujukucuowu"</span>);
        }
        <span class="org-keyword">return</span> <span class="org-constant">null</span>;
    }
}
</pre>
</div>

<p>
然后，将其在 xml 中注册:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"exceptionResolver"</span> <span class="org-variable-name">class</span>=<span class="org-string">"com.nf147.test01.exceptionhandler.MyExceptionResolver"</span> /&gt;
</pre>
</div>

<p>
然后，容器启动的时候，就不会将 DefaultHandlerExceptionResolver 的实例放到容器里了。
</p>

<p>
于是，容器里就只有这一个 HandlerExceptionResolver 处理类了。
</p>
</div>
</div>

<div id="outline-container-org585e455" class="outline-3">
<h3 id="org585e455"><span class="section-number-3">6.4</span> 使用注解的方式 @ExceptionHandler/@ControllerAdvice</h3>
<div class="outline-text-3" id="text-6-4">
<p>
使用 @ExceptionHandler 进行类内异常处理:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Controller</span>
<span class="org-c-annotation">@RequestMapping</span>(<span class="org-string">"/eee"</span>)
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Emp3Controller</span> {

    <span class="org-c-annotation">@Autowired</span>
    <span class="org-keyword">private</span> <span class="org-type">EmpService</span> <span class="org-variable-name">empService</span>;

    <span class="org-c-annotation">@RequestMapping</span>(method = <span class="org-constant">RequestMethod</span>.POST, produces = <span class="org-string">"text/plain; charset=UTF-8"</span>)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">add</span>(<span class="org-type">Emp</span> <span class="org-variable-name">emp</span>, <span class="org-type">Model</span> <span class="org-variable-name">model</span>) <span class="org-keyword">throws</span> <span class="org-type">Exception</span> {
        empService.addEmp(emp);
        <span class="org-keyword">return</span> <span class="org-string">"success"</span>;
    }

    <span class="org-c-annotation">@RequestMapping</span>(method = <span class="org-constant">RequestMethod</span>.GET)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">selectAll</span>(<span class="org-type">Model</span> <span class="org-variable-name">model</span>) {
        <span class="org-type">List</span>&lt;<span class="org-type">Emp</span>&gt; <span class="org-variable-name">empList</span> = empService.selectAll();
        model.addAttribute(<span class="org-string">"empList"</span>, empList);
        <span class="org-keyword">return</span> <span class="org-string">"emp_index"</span>;
    }



    <span class="org-comment-delimiter">// </span><span class="org-comment">&#19979;&#38754;&#36825;&#20123;&#27880;&#35299;&#65292;&#21482;&#33021;&#20316;&#29992;&#20110;&#26412;&#31867;&#20043;&#20013;</span>

    <span class="org-c-annotation">@ExceptionHandler</span>(DbException.<span class="org-keyword">class</span>)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">handlerDbException</span> (<span class="org-type">Exception</span> <span class="org-variable-name">ex</span>, <span class="org-type">Model</span> <span class="org-variable-name">model</span>, <span class="org-type">WebRequest</span> <span class="org-variable-name">request</span>) {
        model.addAttribute(<span class="org-string">"err"</span>, ex.getMessage());
        <span class="org-keyword">return</span> <span class="org-string">"err1"</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">&#40664;&#35748;&#36820;&#22238; status 200</span>
    }

    <span class="org-c-annotation">@ExceptionHandler</span>(DataException.<span class="org-keyword">class</span>)
    <span class="org-c-annotation">@ResponseStatus</span>(value = <span class="org-constant">HttpStatus</span>.NOT_FOUND, reason = <span class="org-string">"&#25968;&#25454;&#24211;&#30340;&#38169;&#35823;"</span>)
    <span class="org-keyword">public</span> <span class="org-type">ModelAndView</span> <span class="org-function-name">handlerDbException2</span> () {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">ModelAndView</span>(<span class="org-string">"err2"</span>);
    }

    <span class="org-c-annotation">@ExceptionHandler</span>(Exception.<span class="org-keyword">class</span>)
    <span class="org-keyword">public</span> <span class="org-type">ResponseEntity</span> <span class="org-function-name">handlerDbException4</span> () {
        <span class="org-keyword">return</span> ResponseEntity.status(333).body(<span class="org-string">"dkfjs"</span>);
    }
}

</pre>
</div>


<p>
配合 @ControllerAdvice 使用:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Component</span>
<span class="org-c-annotation">@ControllerAdvice</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">AllControllerAdvice</span> {
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#36825;&#20010;&#22788;&#29702;&#65292;&#23545;&#25152;&#26377;&#30340; Controller &#37117;&#20250;&#26377;&#25928;</span>
    <span class="org-c-annotation">@ExceptionHandler</span>(Exception.<span class="org-keyword">class</span>)
    <span class="org-c-annotation">@ResponseStatus</span>(value = <span class="org-constant">HttpStatus</span>.URI_TOO_LONG)
    <span class="org-c-annotation">@ResponseBody</span>
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">handlerDbException3</span> () {
        <span class="org-keyword">return</span> <span class="org-string">"ksjfksd"</span>;
    }

    <span class="org-c-annotation">@ExceptionHandler</span>(RuntimeException.<span class="org-keyword">class</span>)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">handlerDbException4</span> () {
        <span class="org-keyword">return</span> <span class="org-string">"runtime"</span>;
    }
}
</pre>
</div>
</div>
</div>
</section>


<section id="outline-container-orgc743c7f" class="outline-2">
<h2 id="orgc743c7f"><span class="section-number-2">7</span> View (视图渲染，服务端渲染)</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org196e127" class="outline-3">
<h3 id="org196e127"><span class="section-number-3">7.1</span> ViewResolver</h3>
<div class="outline-text-3" id="text-7-1">
<p>
可以同时配置多个视图解析器。
</p>

<p>
Spring MVC 内部，支持内置的 JSP 解析，还支持经典的 FreeMaker。
</p>

<p>
另外一个比较推荐使用的模板引擎是 Thymeleaf。
</p>
</div>
</div>

<div id="outline-container-org9ed37c6" class="outline-3">
<h3 id="org9ed37c6"><span class="section-number-3">7.2</span> Spring JSP Taglib</h3>
<div class="outline-text-3" id="text-7-2">
<p>
通过这些标签，可以节省非常多的逻辑。比如，在 form 表单上，他们提供了:
</p>
<ul class="org-ul">
<li>回显输入</li>
<li>渲染错误信息</li>
</ul>

<p>
相关的标签有很多，比如:
</p>
<ul class="org-ul">
<li>form:form</li>
<li>form:input</li>
<li>form:error</li>
<li>spring:message</li>
<li>form:select&#x2026;</li>
</ul>
</div>
</div>

<div id="outline-container-orgb127db0" class="outline-3">
<h3 id="orgb127db0"><span class="section-number-3">7.3</span> Thymeleaf</h3>
<div class="outline-text-3" id="text-7-3">
<p>
优点:
</p>
<ul class="org-ul">
<li>语法简单</li>
<li>便与调试</li>
<li>其他我不说了</li>
</ul>

<p>
比如 Thymeleaf 的语法如下:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span class="org-function-name">table</span>&gt;
  &lt;<span class="org-function-name">thead</span>&gt;
    &lt;<span class="org-function-name">tr</span>&gt;
      &lt;<span class="org-function-name">th</span> <span class="org-sgml-namespace">th</span>:<span class="org-variable-name">text</span>=<span class="org-string">"#{msgs.headers.name}"</span>&gt;Name&lt;/<span class="org-function-name">th</span>&gt;
      &lt;<span class="org-function-name">th</span> <span class="org-sgml-namespace">th</span>:<span class="org-variable-name">text</span>=<span class="org-string">"#{msgs.headers.price}"</span>&gt;Price&lt;/<span class="org-function-name">th</span>&gt;
    &lt;/<span class="org-function-name">tr</span>&gt;
  &lt;/<span class="org-function-name">thead</span>&gt;
  &lt;<span class="org-function-name">tbody</span>&gt;
    &lt;<span class="org-function-name">tr</span> <span class="org-sgml-namespace">th</span>:<span class="org-variable-name">each</span>=<span class="org-string">"prod: ${allProducts}"</span>&gt;
      &lt;<span class="org-function-name">td</span> <span class="org-sgml-namespace">th</span>:<span class="org-variable-name">text</span>=<span class="org-string">"${prod.name}"</span>&gt;Oranges&lt;/<span class="org-function-name">td</span>&gt;
      &lt;<span class="org-function-name">td</span> <span class="org-sgml-namespace">th</span>:<span class="org-variable-name">text</span>=<span class="org-string">"${#numbers.formatDecimal(prod.price, 1, 2)}"</span>&gt;0.99&lt;/<span class="org-function-name">td</span>&gt;
    &lt;/<span class="org-function-name">tr</span>&gt;
  &lt;/<span class="org-function-name">tbody</span>&gt;
&lt;/<span class="org-function-name">table</span>&gt;
</pre>
</div>
</div>
</div>
</section>

<section id="outline-container-org6f6bdd1" class="outline-2">
<h2 id="org6f6bdd1"><span class="section-number-2">8</span> I18N (国际化)</h2>
<div class="outline-text-2" id="text-8">
<p>
<b>Internationalization</b> 的缩写。
</p>

<p>
Spring 提供了两个接口用于国际化文件处理:
</p>
<ol class="org-ol">
<li><code>MessageSource</code>，用于加载资源文件</li>
<li><code>MessageResolver</code>，用于解析用户所处的位置(Locale)</li>
</ol>

<p>
如果想使用资源文件，只需要在容器里注册一个 MessageSource 的实例即可。
一般情况下，使用 Spring 内置的 ReloadableResourceBundleMessageSource 实现:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"messageSource"</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.context.support.ReloadableResourceBundleMessageSource"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"basename"</span> <span class="org-variable-name">value</span>=<span class="org-string">"classpath:messages"</span> /&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"defaultEncoding"</span> <span class="org-variable-name">value</span>=<span class="org-string">"GBK"</span> /&gt;
&lt;/<span class="org-function-name">bean</span>&gt;
</pre>
</div>

<p>
然后在 classpath 下面创建 <b>messages[_zh].properties</b> 文件:
</p>
<div class="org-src-container">
<pre class="src src-conf"><span class="org-variable-name">xxx</span>=23232323
<span class="org-variable-name">yyy.xxx</span>=ksdjfk
<span class="org-variable-name">err.aaa</span>=ksdfjjjjj
</pre>
</div>

<p>
接下来就可以使用了:
</p>
<ul class="org-ul">
<li>在 JSP 中: <code>&lt;spring:message code="xxx" /&gt;</code></li>
<li>在验证器中: <code>errors.reject("err.aaa");</code></li>
</ul>

<hr>

<p>
如果想在 JSR303 验证中使用 message 文件加载错误信息，那么就需要额外配置下内置验证器了:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">annotation-driven</span> <span class="org-variable-name">validator</span>=<span class="org-string">"myValidator"</span> /&gt;

&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"myValidator"</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.validation.beanvalidation.LocalValidatorFactoryBean"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"providerClass"</span> <span class="org-variable-name">value</span>=<span class="org-string">"org.hibernate.validator.HibernateValidator"</span> /&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"validationMessageSource"</span> <span class="org-variable-name">ref</span>=<span class="org-string">"messageSource"</span> /&gt;
&lt;/<span class="org-function-name">bean</span>&gt;
</pre>
</div>

<p>
然后就可以了:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Range</span>(min = 10, max = 100, message = {err.xxx})
<span class="org-type">Float</span> <span class="org-variable-name">price</span>;
</pre>
</div>

<hr>

<p>
默认情况下，Spring 使用 AcceptHeaderLocaleResolver 来解析用户的区域。
它本质是调用 <code>request.getLocale()</code> 方法，通过 <code>Accept-Language</code> 来获取的区域。
</p>

<p>
如果，这种自动确定区域的方式不适合你，那么你需要亲自注册一个 LocaleResolver 来制定 Locale 策略。
可选的策略有 <code>SessionLocaleResolver/CookieLocaleResolver/FixedLocaleResolver</code>:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"localeResolver"</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.web.servlet.i18n.SessionLocaleResolver"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"defaultLocale"</span> <span class="org-variable-name">value</span>=<span class="org-string">"zh"</span>/&gt;
&lt;/<span class="org-function-name">bean</span>&gt;
</pre>
</div>

<p>
就这样就可以了。下面是一键切换语言的示例:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Autowired</span>
<span class="org-keyword">private</span> <span class="org-type">LocaleResolver</span> <span class="org-variable-name">localeResolver</span>;

<span class="org-c-annotation">@GetMapping</span>(<span class="org-string">"/change-locale/{loc}"</span>)
<span class="org-c-annotation">@ResponseBody</span>
<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">changeLocale</span> (<span class="org-c-annotation">@PathVariable</span>(<span class="org-string">"loc"</span>) <span class="org-type">String</span> <span class="org-variable-name">localeStr</span>, <span class="org-type">HttpServletRequest</span> <span class="org-variable-name">req</span>, <span class="org-type">HttpServletResponse</span> <span class="org-variable-name">resp</span>) {
    <span class="org-type">Locale</span> <span class="org-variable-name">locale</span> = <span class="org-keyword">new</span> <span class="org-type">Locale</span>(localeStr);
    localeResolver.setLocale(req, resp, locale);
    <span class="org-keyword">return</span> <span class="org-string">"success"</span>;
}

<span class="org-comment-delimiter">// </span><span class="org-comment">http://localhost:8080/change-locale/zh</span>
</pre>
</div>
</div>
</section>

<section id="outline-container-org1575ae9" class="outline-2">
<h2 id="org1575ae9"><span class="section-number-2">9</span> Theme (主题)</h2>
<div class="outline-text-2" id="text-9">
<p>
主题指得是一系列的 css 以及影响页面显示效果的图片等资源的集合。
</p>

<p>
Spring 中可以根据不同情况加载不同主题。它的实现方式跟 i18n <b>绝对雷同</b>。
</p>

<p>
两个主要接口:
</p>
<ul class="org-ul">
<li><code>ThemeResolver</code> 用于确定要使用的主题的名字(theme name)</li>
<li><code>ThemeSource</code> 用于加载主题文件(通过 theme name)</li>
</ul>

<p>
所以，要启用主题，只需要注入一个 ThemeSource 的实现，比如，内置的 <code>ResouceBundleThemeSource</code>:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"themeSource"</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.ui.context.support.ResourceBundleThemeSource"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"basenamePrefix"</span> <span class="org-variable-name">value</span>=<span class="org-string">"themes."</span> /&gt; <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#21738;&#20010;&#21253;&#19979;&#65292;&#40664;&#35748;&#26159; classpath &#26681;&#30446;&#24405;&#65292;&#27880;&#24847;&#65292;&#26159;&#21253;&#21517;&#30340;&#20889;&#27861;-&gt;</span>
<span class="org-comment">&lt;/bean&gt;</span>

<span class="org-comment">&lt;!-- &#12304;&#21487;&#36873;&#12305; </span><span class="org-comment-delimiter">--&gt;</span>
<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#20351;&#29992;&#30340;&#26159; FixedThemeResolver &#26469;&#30830;&#23450;&#20027;&#39064;&#21517;&#23383;&#65292;&#40664;&#35748;&#21517;&#23383;&#20026; theme </span><span class="org-comment-delimiter">--&gt;</span>
<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#21487;&#20197;&#26681;&#25454;&#23454;&#38469;&#24773;&#20917;&#37197;&#32622;&#20026; SessionThemeResovler/CookieThemeResolver </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"themeResolver"</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.web.servlet.theme.SessionThemeResolver"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"defaultThemeName"</span> <span class="org-variable-name">value</span>=<span class="org-string">"girl"</span> /&gt; <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#40664;&#35748;&#20027;&#39064;&#25991;&#20214;&#30340;&#21517;&#23383;&#26159; "girl"&#65292;&#22914;&#26524;&#19981;&#35774;&#32622;&#65292;&#21517;&#20026; 'theme' </span><span class="org-comment-delimiter">--&gt;</span>
&lt;/<span class="org-function-name">bean</span>&gt;
</pre>
</div>

<p>
然后，在 classpath 下面的 themes 文件夹下添加 theme.properties 或 girl.properties 文件:
</p>
<div class="org-src-container">
<pre class="src src-conf"><span class="org-variable-name">style</span>=/css/pink.css
<span class="org-variable-name">body.color</span>=red
<span class="org-variable-name">footer.bg.image</span>=/image/background.png
<span class="org-variable-name">global.font.family</span>=&#23435;&#20307;
</pre>
</div>

<p>
随后，就可以在 jsp 文件中使用上面配置的这些资源信息了:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span class="org-function-name">html</span>&gt;
  &lt;<span class="org-function-name">head</span>&gt;
    &lt;<span class="org-function-name">link</span> <span class="org-variable-name">rel</span>=<span class="org-string">"stylesheet"</span> <span class="org-variable-name">href</span>=<span class="org-string">"&lt;spring:theme code="</span>style<span class="org-string">" /&gt;"</span>&gt;
  &lt;/<span class="org-function-name">head</span>&gt;

  &lt;<span class="org-function-name">body</span> <span class="org-variable-name">style</span>=<span class="org-string">"color: &lt;spring:theme code="</span>body.color<span class="org-string">" /&gt;"</span>&gt;
    &#27491;&#25991;&#20869;&#23481;
  &lt;/<span class="org-function-name">body</span>&gt;
&lt;/<span class="org-function-name">html</span>&gt;
</pre>
</div>

<p>
所以如果使用不同的主题文件，页面上的 css 元素就不会相同，就能得到不同渲染效果的页面。
</p>

<p>
就这么简单。
</p>

<p>
如果想在页面上一键切换主题，那么跟上面一键切换语言是同样的逻辑。略。
</p>
</div>
</section>

<section id="outline-container-org6d00599" class="outline-2">
<h2 id="org6d00599"><span class="section-number-2">10</span> File Upload/Download (文件上传、下载)</h2>
<div class="outline-text-2" id="text-10">
</div>
<div id="outline-container-orgb5dd841" class="outline-3">
<h3 id="orgb5dd841"><span class="section-number-3">10.1</span> Upload</h3>
<div class="outline-text-3" id="text-10-1">
<p>
SpringMVC 中，文件的上传是通过 <code>MultipartResolver</code> 实现的，所以要实现上传，只要注册相应的 MultipartResolver 即可。
</p>

<p>
MultipartResolver 的实现类有两个：
</p>
<ol class="org-ol">
<li><code>CommonsMultipartResolver</code> (需要 Apache 的 commons-fileupload 支持，它能在比较旧的 servlet 版本中使用，兼容性好)</li>
<li><code>StandardServletMultipartResolver</code> (不需要第三方 jar 包支持，它使用 servlet 内置的上传功能，但是只能在 Servlet 3 以上的版本使用)</li>
</ol>

<p>
<b>以 StandardServletMultipartResolver 为例，使用步骤如下。</b>
</p>

<p>
首先，在 web.xml 中为 DispatcherServlet 配置 Multipart:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">servlet</span>&gt;
  &lt;<span class="org-function-name">servlet-name</span>&gt;mvc&lt;/<span class="org-function-name">servlet-name</span>&gt;
  &lt;<span class="org-function-name">servlet-class</span>&gt;org.springframework.web.servlet.DispatcherServlet&lt;/<span class="org-function-name">servlet-class</span>&gt;

  &lt;<span class="org-function-name">multipart-config</span>&gt;
    &lt;<span class="org-function-name">max-file-size</span>&gt;5242880&lt;/<span class="org-function-name">max-file-size</span>&gt;        <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#19978;&#20256;&#25991;&#20214;&#30340;&#22823;&#23567;&#38480;&#21046;&#65292;&#27604;&#22914;&#19979;&#38754;&#34920;&#31034; 5 M </span><span class="org-comment-delimiter">--&gt;</span>
    &lt;<span class="org-function-name">max-request-size</span>&gt;10485760&lt;/<span class="org-function-name">max-request-size</span>&gt; <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#19968;&#27425;&#34920;&#21333;&#25552;&#20132;&#20013;&#25991;&#20214;&#30340;&#22823;&#23567;&#38480;&#21046;&#65292;&#24517;&#39035;&#19979;&#38754;&#20195;&#34920; 10 M </span><span class="org-comment-delimiter">--&gt;</span>
    &lt;<span class="org-function-name">file-size-threshold</span>&gt;0&lt;/<span class="org-function-name">file-size-threshold</span>&gt;  <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#22810;&#22823;&#30340;&#25991;&#20214;&#20250;&#34987;&#33258;&#21160;&#20445;&#23384;&#21040;&#30828;&#30424;&#19978;&#12290;0 &#20195;&#34920;&#25152;&#26377; </span><span class="org-comment-delimiter">--&gt;</span>
  &lt;/<span class="org-function-name">multipart-config</span>&gt;
&lt;/<span class="org-function-name">servlet</span>&gt;
</pre>
</div>

<p>
其次，在 spring 中注册 MultipartResolver:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"multipartResolver"</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.web.multipart.support.StandardServletMultipartResolver"</span> /&gt;
</pre>
</div>

<p>
然后，就可以使用了，比如，表单:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;<span class="org-sgml-namespace">form</span>:<span class="org-function-name">form</span> <span class="org-variable-name">action</span>=<span class="org-string">"/file/upload"</span> <span class="org-variable-name">method</span>=<span class="org-string">"post"</span> <span class="org-variable-name">enctype</span>=<span class="org-string">"multipart/form-data"</span>&gt;
  &lt;<span class="org-function-name">input</span> <span class="org-variable-name">type</span>=<span class="org-string">"file"</span> <span class="org-variable-name">name</span>=<span class="org-string">"mfile"</span> /&gt;
  &lt;<span class="org-function-name">input</span> <span class="org-variable-name">name</span>=<span class="org-string">"desc"</span> <span class="org-variable-name">placeholder</span>=<span class="org-string">"&#25991;&#20214;&#25551;&#36848;"</span> /&gt;
  &lt;<span class="org-function-name">input</span> <span class="org-variable-name">type</span>=<span class="org-string">"submit"</span> <span class="org-variable-name">value</span>=<span class="org-string">"&#19978;&#20256;"</span> /&gt;
&lt;/<span class="org-sgml-namespace">form</span>:<span class="org-function-name">form</span>&gt;
</pre>
</div>

<p>
提交后，就可以在 Controller 里这样处理了：
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@PostMapping</span>(<span class="org-string">"/upload"</span>)
<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">upload</span>(<span class="org-type">MultipartFile</span> <span class="org-variable-name">mfile</span>) <span class="org-keyword">throws</span> <span class="org-type">Exception</span> {
    <span class="org-type">String</span> <span class="org-variable-name">savePath</span> = <span class="org-string">"xxx"</span>;
    <span class="org-keyword">if</span>(<span class="org-negation-char">!</span>mfile.isEmpty()) {
        mfile.transferTo(<span class="org-keyword">new</span> <span class="org-type">File</span>(savePath + mfile.getOriginalFilename()));
    }
    <span class="org-keyword">return</span> <span class="org-string">"file/index"</span>;
}
</pre>
</div>

<p>
另外可以用 @RequestPart/@RequestParam 注解 MultipartFile 参数。
</p>
</div>
</div>

<div id="outline-container-org4c13c75" class="outline-3">
<h3 id="org4c13c75"><span class="section-number-3">10.2</span> Download</h3>
<div class="outline-text-3" id="text-10-2">
<p>
使用 ResponseEntity 可以让下载变得简单:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@GetMapping</span>(value = <span class="org-string">"/download"</span>)
<span class="org-type">ResponseEntity</span>&lt;<span class="org-type">InputStreamResource</span>&gt; <span class="org-function-name">downloadFile</span>() <span class="org-keyword">throws</span> <span class="org-type">IOException</span> {
    <span class="org-type">FileSystemResource</span> <span class="org-variable-name">file</span> = <span class="org-keyword">new</span> <span class="org-type">FileSystemResource</span>(<span class="org-string">"/home/vip/logo.png"</span>);

    <span class="org-type">HttpHeaders</span> <span class="org-variable-name">headers</span> = <span class="org-keyword">new</span> <span class="org-type">HttpHeaders</span>();
    headers.setCacheControl(<span class="org-string">"no-cache, no-store, must-revalidate"</span>);
    headers.setContentType(<span class="org-constant">MediaType</span>.APPLICATION_OCTET_STREAM);
    headers.setContentLength(file.contentLength());
    headers.setContentDispositionFormData(<span class="org-string">"attachment"</span>, file.getFilename());

    <span class="org-keyword">return</span> ResponseEntity.ok().headers(headers).body(<span class="org-keyword">new</span> <span class="org-type">InputStreamResource</span>(file.getInputStream()));
}
</pre>
</div>



<p>
0.1 代码规范
0.1 异常处理
0.1 没有进行有效过滤
0.1 对于过去学习内容的遗忘
0.1 审题不仔细
</p>
</div>
</div>

<div id="outline-container-org1e450aa" class="outline-3">
<h3 id="org1e450aa"><span class="section-number-3">10.3</span> 示例</h3>
<div class="outline-text-3" id="text-10-3">
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@PostMapping</span>(<span class="org-string">"/book"</span>)
<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">imageshangchuan</span>(<span class="org-type">MultipartFile</span> <span class="org-variable-name">ufile</span>, <span class="org-type">Model</span> <span class="org-variable-name">model</span>, <span class="org-type">HttpServletRequest</span> <span class="org-variable-name">request</span>, <span class="org-c-annotation">@Valid</span> <span class="org-type">Book</span> <span class="org-variable-name">book</span>, <span class="org-type">BindingResult</span> <span class="org-variable-name">bookResult</span>) {
    <span class="org-keyword">if</span> (bookResult.hasErrors()) {
        <span class="org-keyword">return</span> <span class="org-string">"book_input"</span>;
    }

    <span class="org-type">List</span>&lt;<span class="org-type">String</span>&gt; <span class="org-variable-name">errors</span> = <span class="org-keyword">new</span> <span class="org-type">ArrayList</span>&lt;&gt;();
    <span class="org-keyword">if</span> (ufile.isEmpty()) {
        errors.add(<span class="org-string">"&#25991;&#20214;&#20026;&#31354;&#38169;&#35823;"</span>);
    }
    <span class="org-keyword">if</span> (ufile.getSize() &gt; 1024 * 1024 * 5) {
        errors.add(<span class="org-string">"&#25991;&#20214;&#36229;&#20986;&#22823;&#23567;&#65292;&#35831;&#37325;&#26032;&#36873;&#25321;&#65281;"</span>);
    }
    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>ufile.getContentType().contains(<span class="org-string">"image/"</span>)) {
        errors.add(<span class="org-string">"&#21482;&#20801;&#35768;&#19978;&#20256;&#22270;&#29255;&#25991;&#20214;&#65281;"</span>);
    }
    <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>errors.isEmpty()) {
        model.addAttribute(<span class="org-string">"errs"</span>, errors);
        <span class="org-keyword">return</span> <span class="org-string">"book_input"</span>;
    }

    <span class="org-type">String</span> <span class="org-variable-name">basePath</span> = request.getServletContext().getRealPath(<span class="org-string">"/img"</span>);
    <span class="org-type">String</span> <span class="org-variable-name">relativePath</span>; <span class="org-comment-delimiter">// </span><span class="org-comment">&#22270;&#29255;&#30340;&#20445;&#23384;&#36335;&#24452;</span>
    <span class="org-keyword">try</span> {
        relativePath = makeRelativePath(ufile.getOriginalFilename());
        <span class="org-type">File</span> <span class="org-variable-name">target</span> = <span class="org-keyword">new</span> <span class="org-type">File</span>(basePath + relativePath);
        target.getParentFile().mkdir();
        ufile.transferTo(target);
    } <span class="org-keyword">catch</span> (<span class="org-type">IOException</span> <span class="org-variable-name">e</span>) {
        model.addAttribute(<span class="org-string">"err"</span>, <span class="org-string">"&#25991;&#20214;&#19978;&#20256;&#22833;&#36133;&#65292;&#35831;&#37325;&#35797;&#65281;"</span>);
        <span class="org-keyword">return</span> <span class="org-string">"book_input"</span>;
    }

    book.setCover(relativePath);
    <span class="org-keyword">try</span> {
        System.out.println(<span class="org-string">"&#23545;"</span> + book + <span class="org-string">"&#36827;&#34892;&#20445;&#23384;&#31561;&#25805;&#20316;"</span>);
    } <span class="org-keyword">catch</span> (<span class="org-type">Exception</span> <span class="org-variable-name">e</span>) {
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#23454;&#38469;&#19994;&#21153;&#20013;&#65292;&#35201;&#32771;&#34385;&#24322;&#24120;&#30340;&#22788;&#29702;</span>
        model.addAttribute(<span class="org-string">"err"</span>, <span class="org-string">"something"</span>);
        <span class="org-keyword">return</span> <span class="org-string">"book_input"</span>;
    }
    <span class="org-keyword">return</span> <span class="org-string">"book_home"</span>;
}

<span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">makeRelativePath</span>(<span class="org-type">String</span> <span class="org-variable-name">fileName</span>) {
    <span class="org-type">Date</span> <span class="org-variable-name">now</span> = <span class="org-keyword">new</span> <span class="org-type">Date</span>();
    <span class="org-type">String</span>[] <span class="org-variable-name">fileNames</span> = splitFileString(fileName);
    <span class="org-keyword">return</span> String.format(<span class="org-string">"%s%s%supload_%s_%s.%s"</span>,
                         File.separator,
                         <span class="org-keyword">new</span> <span class="org-type">SimpleDateFormat</span>(<span class="org-string">"yyyyMMdd"</span>).format(now),
                         File.separator,
                         fileNames[0],
                         <span class="org-keyword">new</span> <span class="org-type">SimpleDateFormat</span>(<span class="org-string">"hhmmss"</span>).format(now),
                         fileNames[1]
                         );
}

<span class="org-keyword">public</span> <span class="org-type">String</span>[] <span class="org-function-name">splitFileString</span>(<span class="org-type">String</span> <span class="org-variable-name">fileName</span>) {
    <span class="org-type">int</span> <span class="org-variable-name">dotPos</span> = fileName.lastIndexOf(<span class="org-string">"."</span>);
    <span class="org-type">String</span> <span class="org-variable-name">ext</span> = fileName.substring(dotPos + 1);
    <span class="org-type">String</span> <span class="org-variable-name">name</span> = fileName.substring(0, dotPos);
    <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">String</span>[]{name, ext};
}
</pre>
</div>
</div>
</div>
</section>




<section id="outline-container-orgadada0c" class="outline-2">
<h2 id="orgadada0c"><span class="section-number-2">11</span> CORS (Cross Origin Resources Share) 跨域</h2>
<div class="outline-text-2" id="text-11">
<p>
Spring 提供了三种方式:
</p>
<ol class="org-ol">
<li><code>CorsFilter</code> 过滤器</li>
<li><code>&lt;mvc:cors&gt;</code> Bean</li>
<li><code>@CrossOrigin</code> 注解</li>
</ol>

<p>
这三种方式，本质上都是用来配置 CorsConfiguration。
</p>
</div>

<div id="outline-container-org4816590" class="outline-3">
<h3 id="org4816590"><span class="section-number-3">11.1</span> CorsFilter</h3>
<div class="outline-text-3" id="text-11-1">
<p>
首先，依赖 CorsFilter 创建自己的过滤器:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">MyCorsFilter</span> <span class="org-keyword">extends</span> <span class="org-type">CorsFilter</span> {
    <span class="org-keyword">public</span> <span class="org-function-name">MyCorsFilter</span>() {
        <span class="org-keyword">super</span>(configurationSource());
    }

    <span class="org-keyword">private</span> <span class="org-keyword">static</span> <span class="org-type">UrlBasedCorsConfigurationSource</span> <span class="org-function-name">configurationSource</span>() {
        <span class="org-type">UrlBasedCorsConfigurationSource</span> <span class="org-variable-name">source</span> = <span class="org-keyword">new</span> <span class="org-type">UrlBasedCorsConfigurationSource</span>();

        <span class="org-type">CorsConfiguration</span> <span class="org-variable-name">config</span> = <span class="org-keyword">new</span> <span class="org-type">CorsConfiguration</span>();
        config.setAllowedOrigins(Collections.singletonList(<span class="org-string">"http://domain.com"</span>));
        config.setAllowCredentials(<span class="org-constant">true</span>);

        <span class="org-type">CorsConfiguration</span> <span class="org-variable-name">config2</span> = <span class="org-keyword">new</span> <span class="org-type">CorsConfiguration</span>();
        config2.setAllowedOrigins(Collections.singletonList(<span class="org-string">"http://domain.com"</span>));
        config2.setAllowCredentials(<span class="org-constant">true</span>);

        source.registerCorsConfiguration(<span class="org-string">"/**"</span>, config);
        source.registerCorsConfiguration(<span class="org-string">"/xxx"</span>, config2);

        <span class="org-keyword">return</span> source;
    }
}
</pre>
</div>

<p>
然后，将其注册为一个过滤器即可。
</p>
</div>
</div>

<div id="outline-container-org3bb037c" class="outline-3">
<h3 id="org3bb037c"><span class="section-number-3">11.2</span> &lt;mvc:cors&gt;</h3>
<div class="outline-text-3" id="text-11-2">
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">cors</span>&gt;
  &lt;<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">mapping</span> <span class="org-variable-name">path</span>=<span class="org-string">"/xxx"</span>
               <span class="org-variable-name">allowed-origins</span>=<span class="org-string">"http://localhost:7070"</span>
               <span class="org-variable-name">allowed-methods</span>=<span class="org-string">"GET, POST"</span>
               <span class="org-variable-name">allowed-headers</span>=<span class="org-string">"Accept-Charset, Accept, Content-Type"</span>
               <span class="org-variable-name">allow-credentials</span>=<span class="org-string">"true"</span> /&gt;
  &lt;<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">mapping</span> <span class="org-variable-name">path</span>=<span class="org-string">"/yyy/*"</span>
               <span class="org-variable-name">allowed-origins</span>=<span class="org-string">"*"</span>
               <span class="org-variable-name">allowed-methods</span>=<span class="org-string">"*"</span>
               <span class="org-variable-name">allowed-headers</span>=<span class="org-string">"*"</span> /&gt;
&lt;/<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">cors</span>&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb4c2e33" class="outline-3">
<h3 id="orgb4c2e33"><span class="section-number-3">11.3</span> @CrossOrigin</h3>
<div class="outline-text-3" id="text-11-3">
<div class="org-src-container">
<pre class="src src-java"><span class="org-comment-delimiter">// </span><span class="org-comment">&#23558;&#36328;&#22495;&#35774;&#32622;&#22312;&#31867;&#19978;&#65292;&#37027;&#20040;&#25152;&#26377;&#30340; mapping &#37117;&#20250;&#20351;&#29992;&#36825;&#20010;&#31574;&#30053;</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&#22914;&#26524;&#19981;&#21152;&#21442;&#25968;&#65292;&#37027;&#20040;&#23558;&#20250;&#20351;&#29992;&#37197;&#32622;&#20013;&#30340;&#40664;&#35748;&#21442;&#25968;</span>
<span class="org-c-annotation">@CrossOrigin</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">CORSController</span> {
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">cors</span>(<span class="org-c-annotation">@RequestParam</span>(defaultValue = <span class="org-string">"callback"</span>) <span class="org-type">String</span> <span class="org-variable-name">callback</span>, <span class="org-type">HttpServletResponse</span> <span class="org-variable-name">response</span>) {
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#26368;&#21407;&#22987;&#30340;&#26041;&#24335;&#65292;&#25163;&#21160;&#20889;&#35831;&#27714;&#22836;</span>
        response.setHeader(<span class="org-string">"Access-Control-Allow-Origin"</span>, <span class="org-string">"http://192.168.163.1:8081"</span>);
        <span class="org-keyword">return</span> callback + <span class="org-string">"('hello')"</span>;
    }


    <span class="org-comment-delimiter">// </span><span class="org-comment">&#23558;&#36328;&#22495;&#35774;&#32622;&#22312;&#26041;&#27861;&#19978;</span>
    <span class="org-c-annotation">@RequestMapping</span>(<span class="org-string">"/cors"</span>)
    <span class="org-c-annotation">@CrossOrigin</span>(origins = {<span class="org-string">"http://localhost:8080"</span>, <span class="org-string">"http://remotehost:82323"</span>},
                 methods = {<span class="org-constant">RequestMethod</span>.GET, <span class="org-constant">RequestMethod</span>.POST},
                 allowedHeaders = {<span class="org-string">"Content-Type"</span>, <span class="org-string">"skfjksdjfk"</span>},
                 allowCredentials = <span class="org-string">"true"</span>,
                 maxAge = 1898978
                 )
    <span class="org-c-annotation">@RequestMapping</span>(<span class="org-string">"/rrr"</span>)
    <span class="org-keyword">public</span> <span class="org-type">String</span> <span class="org-function-name">rrr</span>(<span class="org-c-annotation">@RequestParam</span>(defaultValue = <span class="org-string">"callback"</span>) <span class="org-type">String</span> <span class="org-variable-name">callback</span>) {
        <span class="org-keyword">return</span> callback + <span class="org-string">"('rrr')"</span>;
    }
}

</pre>
</div>
</div>
</div>
</section>

<section id="outline-container-org130964b" class="outline-2">
<h2 id="org130964b"><span class="section-number-2">12</span> RESTful/前后端分离</h2>
<div class="outline-text-2" id="text-12">
</div>
<div id="outline-container-org3b5984a" class="outline-3">
<h3 id="org3b5984a"><span class="section-number-3">12.1</span> 编码问题</h3>
<div class="outline-text-3" id="text-12-1">
<p>
如何设置，才能避免乱码？
</p>

<p>
Producer/Consumer (生产/消费模式)。
</p>

<div class="org-src-container">
<pre class="src src-java"><span class="org-comment-delimiter">// </span><span class="org-comment">&#35831;&#27714;&#20869;&#23481;&#31867;&#22411;&#24517;&#39035;&#20026; text/html</span>
<span class="org-c-annotation">@RequestMapping</span>(value=<span class="org-string">"/aaa"</span>, consumes=<span class="org-string">"text/html"</span>);

<span class="org-comment-delimiter">// </span><span class="org-comment">&#23458;&#25143;&#31471;&#25509;&#25910; json &#19988;&#32534;&#30721;&#20026; utf-8</span>
<span class="org-c-annotation">@RequestMapping</span>(value=<span class="org-string">"/bbb"</span>, produces=<span class="org-string">"application/json; charset=UTF-8"</span>);
</pre>
</div>

<p>
全局设置的方式:
</p>
<div class="org-src-container">
<pre class="src src-sgml"><span class="org-comment-delimiter">&lt;!--</span><span class="org-comment">&#21551;&#29992; mvc &#30340;&#24120;&#29992;&#27880;&#35299;</span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">annotation-driven</span> <span class="org-variable-name">validator</span>=<span class="org-string">"myValidator"</span> <span class="org-variable-name">conversion-service</span>=<span class="org-string">"conversionService"</span>&gt;
    &lt;<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">message-converters</span>&gt;
        <span class="org-comment-delimiter">&lt;!--</span><span class="org-comment">@ResponseBody &#30340; UTF-8 &#32534;&#30721;</span><span class="org-comment-delimiter">--&gt;</span>
        &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.http.converter.StringHttpMessageConverter"</span>&gt;
            &lt;<span class="org-function-name">constructor-arg</span> <span class="org-variable-name">value</span>=<span class="org-string">"UTF-8"</span>/&gt;
        &lt;/<span class="org-function-name">bean</span>&gt;

        <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">Fail On Empty Beans... </span><span class="org-comment-delimiter">--&gt;</span>
        &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.http.converter.json.MappingJackson2HttpMessageConverter"</span>&gt;
            &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"objectMapper"</span>&gt;
                &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.http.converter.json.Jackson2ObjectMapperFactoryBean"</span>&gt;
                    &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"failOnEmptyBeans"</span> <span class="org-variable-name">value</span>=<span class="org-string">"false"</span>/&gt;
                &lt;/<span class="org-function-name">bean</span>&gt;
            &lt;/<span class="org-function-name">property</span>&gt;
        &lt;/<span class="org-function-name">bean</span>&gt;
    &lt;/<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">message-converters</span>&gt;
&lt;/<span class="org-sgml-namespace">mvc</span>:<span class="org-function-name">annotation-driven</span>&gt;
</pre>
</div>

<p>
@JsonFormat/@JsonIgnore/&#x2026;
</p>
</div>
</div>

<div id="outline-container-orgdc78c76" class="outline-3">
<h3 id="orgdc78c76"><span class="section-number-3">12.2</span> 跨域问题</h3>
<div class="outline-text-3" id="text-12-2">
<p>
@Cors
</p>
</div>
</div>

<div id="outline-container-org9448e3e" class="outline-3">
<h3 id="org9448e3e"><span class="section-number-3">12.3</span> 结果封装</h3>
</div>


<div id="outline-container-org1979542" class="outline-3">
<h3 id="org1979542"><span class="section-number-3">12.4</span> 统一异常处理</h3>
</div>
</section>


<section id="outline-container-orgdd9d9c7" class="outline-2">
<h2 id="orgdd9d9c7"><span class="section-number-2">13</span> Task TODO</h2>
<div class="outline-text-2" id="text-13">
</div>
<div id="outline-container-org80108e4" class="outline-3">
<h3 id="org80108e4"><span class="section-number-3">13.1</span> <span class="done DONE">DONE</span> task</h3>
<div class="outline-text-3" id="text-13-1">
<ul class="org-ul">
<li>要学会从产品的角度考虑问题</li>
<li>要学会站在用户体验的角度进行设计</li>
<li>要根据自己的兴趣和擅长，进行针对性思考学习</li>
<li>麻雀虽小，五脏俱全，管中窥豹，可见一斑</li>
</ul>
</div>
</div>

<div id="outline-container-org58c01ce" class="outline-3">
<h3 id="org58c01ce"><span class="section-number-3">13.2</span> <span class="done DONE">DONE</span> sub-task<code>[2/2]</code></h3>
<div class="outline-text-3" id="text-13-2">
</div>
<div id="outline-container-orgf177c9d" class="outline-4">
<h4 id="orgf177c9d"><span class="section-number-4">13.2.1</span> <span class="done DONE">DONE</span> 任务需要分类</h4>
</div>
<div id="outline-container-org06108ca" class="outline-4">
<h4 id="org06108ca"><span class="section-number-4">13.2.2</span> <span class="done DONE">DONE</span> 任务需要制定优先级</h4>
</div>
</div>

<div id="outline-container-org53ed97e" class="outline-3">
<h3 id="org53ed97e"><span class="section-number-3">13.3</span> <span class="todo TODO">TODO</span> 任务示例<code>[1/5]</code></h3>
<div class="outline-text-3" id="text-13-3">
<ul class="org-ul">
<li class="on"><code>[X]</code> 需求分析</li>
<li class="off"><code>[&#xa0;]</code> 软件详细设计</li>
<li class="off"><code>[&#xa0;]</code> 编码实现</li>
<li class="off"><code>[&#xa0;]</code> 测试</li>
<li class="off"><code>[&#xa0;]</code> 部署发布</li>
</ul>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: unname</p>
<p class="date">Created: 2019-03-22 周五 01:08</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
