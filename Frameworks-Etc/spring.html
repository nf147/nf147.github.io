<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2018-12-18 Tue 07:19 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Spring Framework</title>
<meta name="generator" content="Org mode">
<meta name="author" content="孙悟空">
<link rel='stylesheet' href='/asset/common.css' />
<script src='https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js'></script>
<script src='https://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
<script src='/asset/common.js'></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">Spring Framework</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org647e25c">1. vs. 工厂模式</a></li>
<li><a href="#orgbedddb2">2. 接口</a></li>
<li><a href="#org64d7018">3. 配置</a>
<ul>
<li><a href="#orgacd61ef">3.1. 传统的方式 xml</a></li>
<li><a href="#orgdaf4698">3.2. 基于 Java 的方式进行配置</a></li>
<li><a href="#orgc89bd36">3.3. 混合双打</a></li>
</ul>
</li>
<li><a href="#orgbfc911f">4. 装配 (Wiring)</a>
<ul>
<li><a href="#org04c06e1">4.1. Wiring in XML</a></li>
<li><a href="#org4d36aa6">4.2. Wiring in JavaConfig</a></li>
<li><a href="#org580d7b1">4.3. Wiring with Annotation</a></li>
</ul>
</li>
<li><a href="#orgff8392d">5. 生命周期 (Lifecycle)</a></li>
<li><a href="#orgd96689a">6. 面向切面编程 (AOP, Aspect Oriten Program)</a></li>
<li><a href="#org80086d2">7. 概念</a></li>
<li><a href="#org847d884">8. 使用 @AspectJ 注解</a></li>
<li><a href="#orgef39585">9. 使用 XML 配置的示例</a></li>
</ul>
</div>
</nav>


<section id="outline-container-org647e25c" class="outline-2">
<h2 id="org647e25c"><span class="section-number-2">1</span> vs. 工厂模式</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">ServiceFactory</span> {
    <span class="org-keyword">public</span> <span class="org-type">Object</span> <span class="org-function-name">getServiceObject</span> (<span class="org-type">String</span> <span class="org-variable-name">name</span>) {
        <span class="org-keyword">if</span> (name.equals(<span class="org-string">"bs"</span>)) {
            <span class="org-type">A</span> <span class="org-variable-name">a</span> = <span class="org-keyword">new</span> <span class="org-type">A</span>();
            <span class="org-type">B</span> <span class="org-variable-name">b</span> = <span class="org-keyword">new</span> <span class="org-type">B</span>(a); <span class="org-comment-delimiter">// </span><span class="org-comment">&#26500;&#36896;&#22120;</span>
            <span class="org-type">MyBatiscConnection</span> <span class="org-variable-name">conn</span> = <span class="org-keyword">new</span> <span class="org-type">MyBatiscConnection</span>();
            <span class="org-type">LogUtil</span> <span class="org-variable-name">log</span> = <span class="org-keyword">new</span> <span class="org-type">LogUtil</span>();
            <span class="org-type">BookService</span> <span class="org-variable-name">bookservice</span> = <span class="org-keyword">new</span> <span class="org-type">BookService</span>();

            b.setA(a); <span class="org-comment-delimiter">// </span><span class="org-comment">setter</span>
            conn.setB(b);
            bookservice.setConn(conn);
            LogUtil.setConn(conn);
            bookservice.setLogger(log);

            <span class="org-keyword">return</span> bookservice;
        }
    }
}

<span class="org-function-name">main</span> () {
    <span class="org-type">ServiceFactory</span> <span class="org-variable-name">sf</span> = <span class="org-keyword">new</span> <span class="org-type">ServiceFactory</span>();

    <span class="org-type">BookService</span> <span class="org-variable-name">bookservice</span> = sf.getServiceObject(<span class="org-string">"bs"</span>);
    bookservice.sellBook();
}
</pre>
</div>

<p>
将工厂模式切割，分为解析程序和 xml 文件。
</p>

<p>
xml 暴露出来，用来<b>描述</b>工厂需要实例化的类以及他们之间的关系。
</p>

<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-function-name">xml</span>&gt;
  <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#20043;&#21069;&#21629;&#20196;&#65307;&#25551;&#36848; </span><span class="org-comment-delimiter">--&gt;</span>
  &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"a"</span> <span class="org-variable-name">class</span>=<span class="org-string">"xxx.yyy.A"</span> /&gt;
  &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"b"</span> <span class="org-variable-name">class</span>=<span class="org-string">"xxx.yyy.B"</span>&gt;
    &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"a"</span> <span class="org-variable-name">bean</span>=<span class="org-string">"a"</span> /&gt;
  &lt;/<span class="org-function-name">bean</span>&gt;
  &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"conn"</span> <span class="org-variable-name">class</span>=<span class="org-string">"xxx.yyy.MyBConn"</span>&gt;
    &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"b"</span> <span class="org-variable-name">bean</span>=<span class="org-string">"b"</span> /&gt;
  &lt;/<span class="org-function-name">bean</span>&gt;
  &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"log"</span> <span class="org-variable-name">class</span>=<span class="org-string">"xxx.yyy.LogUtil"</span>&gt;
    &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"conn"</span> <span class="org-variable-name">bean</span>=<span class="org-string">"conn"</span> /&gt;
  &lt;/<span class="org-function-name">bean</span>&gt;
  &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"bookservice"</span> <span class="org-variable-name">class</span>=<span class="org-string">"xxx.BookService"</span>&gt;
    &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"conn"</span> <span class="org-variable-name">bean</span>=<span class="org-string">"conn"</span> /&gt;
    &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"log"</span> <span class="org-variable-name">bean</span>=<span class="org-string">"log"</span> /&gt;
  &lt;/<span class="org-function-name">bean</span>&gt;
&lt;/<span class="org-function-name">xml</span>&gt;
</pre>
</div>
</div>
</section>

<section id="outline-container-orgbedddb2" class="outline-2">
<h2 id="orgbedddb2"><span class="section-number-2">2</span> 接口</h2>
<div class="outline-text-2" id="text-2">
<p>
最核心的 jar 包:
</p>
<ul class="org-ul">
<li>spring-core</li>
<li>spring-bean</li>
<li>spring-context</li>
</ul>

<p>
最核心的接口是 <code>BeanFactory</code>，它用来描述 IOC 容器:
</p>


<figure>
<img src="img/clip_2018-12-13_03-01-52.png" alt="clip_2018-12-13_03-01-52.png">

</figure>

<p>
它很干净，很纯粹，最主要的方法是 <code>getBean</code> 用来给调用方返回一个实例化好的对象。
</p>

<p>
在实际运用中，需要一些周边功能，比如加载资源/国际化/等等，Spring 为此提供了 <code>ApplicatinContext</code>
接口。它本身是 BeanFactory 的一个实现:
</p>


<figure>
<img src="img/clip_2018-12-13_03-04-54.png" alt="clip_2018-12-13_03-04-54.png">

</figure>

<p>
可以看到，ApplicationContext 除了实现了 BeanFactory，还实现了其他一些实用的接口。因此，它是在 Spring 中操作一切的核心。
</p>

<p>
这是<b>门面模式</b>的一种典型使用。
</p>
</div>
</section>


<section id="outline-container-org64d7018" class="outline-2">
<h2 id="org64d7018"><span class="section-number-2">3</span> 配置</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgacd61ef" class="outline-3">
<h3 id="orgacd61ef"><span class="section-number-3">3.1</span> 传统的方式 xml</h3>
<div class="outline-text-3" id="text-3-1">
<p>
这种方式，充分利用了 xml 文件的优势:
</p>
<ul class="org-ul">
<li>接受度比较高，语法简单</li>
<li>表达能力比较强</li>
<li>生态比较完整，基于 xml 的校验、解析等比较完善</li>
</ul>

<p>
所以，最开始的时候，描述工厂里 bean 声明的方式，选用的就是 xml
</p>

<div class="org-src-container">
<pre class="src src-sgml"><span class="org-string">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
&lt;<span class="org-function-name">beans</span> <span class="org-variable-name">xmlns</span>=<span class="org-string">"http://www.springframework.org/schema/beans"</span>
       <span class="org-sgml-namespace">xmlns</span>:<span class="org-variable-name">xsi</span>=<span class="org-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="org-sgml-namespace">xsi</span>:<span class="org-variable-name">schemaLocation</span>=<span class="org-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;

    &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"bs1"</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.spring.BookServiceImpl"</span> /&gt;
    &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"bs2"</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.spring.BookService2Impl"</span> /&gt;

    <span class="org-comment-delimiter">&lt;!--</span><span class="org-comment">&lt;bean id="bs2" class="learning.spring.BookServiceImplImpl" /&gt;</span><span class="org-comment-delimiter">--&gt;</span>

    <span class="org-comment-delimiter">&lt;!--</span><span class="org-comment">&lt;bean id="bs3" class="learning.spring.BookServiceImplImpl" /&gt;</span><span class="org-comment-delimiter">--&gt;</span>
&lt;/<span class="org-function-name">beans</span>&gt;
</pre>
</div>

<p>
但是:
</p>
<ul class="org-ul">
<li>很多人不喜欢 xml 这种标签式的语法。写起来麻烦，看起来不舒服</li>
<li>xml 方式过于重型</li>
<li>xml 语法校验虽然强大，但不够强大</li>
<li>xml 虽然灵活，但不够灵活</li>
</ul>

<p>
所以，就产生了很多其他的叛逆的想法
</p>
</div>
</div>

<div id="outline-container-orgdaf4698" class="outline-3">
<h3 id="orgdaf4698"><span class="section-number-3">3.2</span> 基于 Java 的方式进行配置</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Configuration</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">SuibianSpringConfig</span> {

    <span class="org-comment-delimiter">// </span><span class="org-comment">&lt;bean id="bs1" class="learning.spring.BookServiceImpl" /&gt;</span>
    <span class="org-c-annotation">@Bean</span>
    <span class="org-keyword">public</span> <span class="org-type">BookService</span> <span class="org-function-name">bs1</span>() {
        <span class="org-keyword">if</span> (Math.random() &gt; 0.5) {
            <span class="org-comment-delimiter">// </span><span class="org-comment">&#26500;&#36896;&#22120;&#27880;&#20837;</span>
            <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">BookService2Impl</span>(bookDAO());
        } <span class="org-keyword">else</span> {
            <span class="org-comment-delimiter">// </span><span class="org-comment">setter &#27880;&#20837;</span>
            <span class="org-type">BookService</span> <span class="org-variable-name">bs</span> = <span class="org-keyword">new</span> <span class="org-type">BookServiceImpl</span>();
            bs.setBookDAO(bookDAO());
            <span class="org-keyword">return</span> bs;
        }
    }

    <span class="org-c-annotation">@Bean</span>
    <span class="org-keyword">public</span> <span class="org-type">BookDAO</span> <span class="org-function-name">bookDAO</span> () {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">BookDAO</span>();
    }
}

</pre>
</div>
</div>
</div>

<div id="outline-container-orgc89bd36" class="outline-3">
<h3 id="orgc89bd36"><span class="section-number-3">3.3</span> 混合双打</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Java Style 中混入 XML Style:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Configuration</span>
<span class="org-c-annotation">@ImportResource</span>(locations = <span class="org-string">"learning/spring/my-spring.xml"</span>)
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">SuibianSpringConfig</span> {

    <span class="org-comment-delimiter">// </span><span class="org-comment">&lt;bean id="bs1" class="learning.spring.BookServiceImpl" /&gt;</span>
    <span class="org-c-annotation">@Bean</span>
    <span class="org-keyword">public</span> <span class="org-type">BookService</span> <span class="org-function-name">bs1</span>() {
        System.out.println(bookDAO());
        <span class="org-keyword">if</span> (Math.random() &gt; 0.5) {
            <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">BookService2Impl</span>();
        } <span class="org-keyword">else</span> {
            <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">BookServiceImpl</span>();
        }
    }

    <span class="org-c-annotation">@Bean</span>
    <span class="org-keyword">public</span> <span class="org-type">BookDAO</span> <span class="org-function-name">bookDAO</span> () {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">BookDAO</span>();
    }
}

</pre>
</div>

<p>
XML style 中混入 Java Style:
</p>
<div class="org-src-container">
<pre class="src src-sgml"><span class="org-string">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
&lt;<span class="org-function-name">beans</span> <span class="org-variable-name">xmlns</span>=<span class="org-string">"http://www.springframework.org/schema/beans"</span>
       <span class="org-sgml-namespace">xmlns</span>:<span class="org-variable-name">xsi</span>=<span class="org-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="org-sgml-namespace">xsi</span>:<span class="org-variable-name">schemaLocation</span>=<span class="org-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd"</span>&gt;

    &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"bs2"</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.spring.BookService2Impl"</span> /&gt;
    &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.spring.configuration.SuibianSpringConfig"</span> /&gt;
&lt;/<span class="org-function-name">beans</span>&gt;
</pre>
</div>
</div>
</div>
</section>
<section id="outline-container-orgbfc911f" class="outline-2">
<h2 id="orgbfc911f"><span class="section-number-2">4</span> 装配 (Wiring)</h2>
<div class="outline-text-2" id="text-4">
<blockquote>
<p>

</p>

<p>
创建应用对象之间协作关系的行为，通常称为装配 (Wiring)。这是依赖注入 (DI) 的本质。
</p>
</blockquote>

<p>
装配的基础，是使用配置文件对 Bean 的关系进行声明。
</p>

<p>
总结起来，在 Spring 中，声明 Bean 一共有三种方式:
</p>
<ol class="org-ol">
<li>在 XML Style 的配置中，使用 <code>&lt;bean /&gt;</code> 节点</li>
<li>在 Java Style 的配置中，使用 <code>@Bean</code> 注解</li>
<li>开启 Component 扫描，然后使用相关注解: <code>@Component/@Controller/@Service/@Repository</code></li>
</ol>
</div>

<div id="outline-container-org04c06e1" class="outline-3">
<h3 id="org04c06e1"><span class="section-number-3">4.1</span> Wiring in XML</h3>
<div class="outline-text-3" id="text-4-1">
<p>
装配:
</p>
<div class="org-src-container">
<pre class="src src-sgml"><span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#26368;&#31616;&#21333;&#30340;&#22768;&#26126; </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"package.Dog"</span> /&gt; <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">Class.forName("package.Dog").newInstance(); </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"xxx"</span> <span class="org-variable-name">class</span>=<span class="org-string">"&#21253;&#21517;.&#31867;&#30340;&#21517;&#23383;"</span> /&gt;

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#23545;&#35937;&#20869;&#37096;&#24517;&#39035;&#35201;&#26377;&#25968;&#25454;&#65292;&#25152;&#20197;&#35201;&#32473;&#20182;&#25968;&#25454; </span><span class="org-comment-delimiter">--&gt;</span>

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#26500;&#36896;&#22120;&#27880;&#20837; </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">id</span>=<span class="org-string">"donkey"</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.components.Donkey"</span>&gt;
  &lt;<span class="org-function-name">constructor-arg</span> <span class="org-variable-name">index</span>=<span class="org-string">"0"</span> <span class="org-variable-name">value</span>=<span class="org-string">"&#24471;&#27700;"</span> /&gt;
  &lt;<span class="org-function-name">constructor-arg</span> <span class="org-variable-name">index</span>=<span class="org-string">"1"</span> <span class="org-variable-name">value</span>=<span class="org-string">"333"</span> /&gt;
&lt;/<span class="org-function-name">bean</span>&gt;

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#23646;&#24615;&#27880;&#20837; </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.components.Goal"</span> <span class="org-variable-name">id</span>=<span class="org-string">"goal"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"name"</span> <span class="org-variable-name">value</span>=<span class="org-string">"&#22810;&#21033;"</span> /&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"countOfLegs"</span> <span class="org-variable-name">value</span>=<span class="org-string">"4"</span> /&gt;
&lt;/<span class="org-function-name">bean</span>&gt;

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#38598;&#21512;&#30340;&#27880;&#20837; </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.components.Goal"</span> <span class="org-variable-name">id</span>=<span class="org-string">"goal"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"name"</span> <span class="org-variable-name">value</span>=<span class="org-string">"&#22810;&#21033;"</span> /&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"legs"</span>&gt;
     &lt;<span class="org-function-name">list</span>&gt; <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">map/arrary/set/prop &#21516;&#29702; </span><span class="org-comment-delimiter">--&gt;</span>
        &lt;<span class="org-function-name">value</span>&gt;leg1&lt;/<span class="org-function-name">value</span>&gt;
        &lt;<span class="org-function-name">value</span>&gt;leg2&lt;/<span class="org-function-name">value</span>&gt;
        &lt;<span class="org-function-name">value</span>&gt;leg3&lt;/<span class="org-function-name">value</span>&gt;
     &lt;/<span class="org-function-name">list</span>&gt;
  &lt;/<span class="org-function-name">property</span>&gt;
&lt;/<span class="org-function-name">bean</span>&gt;

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">Bean &#30340;&#20381;&#36182; </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.components.Goal"</span> <span class="org-variable-name">id</span>=<span class="org-string">"goal"</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"xxx"</span>&gt;
      &lt;<span class="org-function-name">ref</span> <span class="org-variable-name">bean</span>=<span class="org-string">"xxx"</span> /&gt;
  &lt;/<span class="org-function-name">property</span>&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"yyy"</span> <span class="org-variable-name">ref</span>=<span class="org-string">"yyy"</span> /&gt;
  &lt;<span class="org-function-name">property</span> <span class="org-variable-name">name</span>=<span class="org-string">"zzz"</span>&gt;
      &lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"package.Zzz"</span> /&gt;
  &lt;/<span class="org-function-name">property</span>&gt;
&lt;/<span class="org-function-name">bean</span>&gt;

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#20351;&#29992; C/P/UTIL &#21629;&#21517;&#31354;&#38388;&#31616;&#21270;&#20351;&#29992; </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.components.Goal"</span> <span class="org-variable-name">id</span>=<span class="org-string">"goal"</span>
      <span class="org-sgml-namespace">p</span>:<span class="org-variable-name">name</span>=<span class="org-string">"&#22810;&#21033;"</span> <span class="org-sgml-namespace">p</span>:<span class="org-variable-name">countOfLegs</span>=<span class="org-string">"4"</span>
      <span class="org-sgml-namespace">p</span>:<span class="org-variable-name">xxx-ref</span>=<span class="org-string">"xxx"</span> <span class="org-sgml-namespace">p</span>:<span class="org-variable-name">aliases-ref</span>=<span class="org-string">"aliaslist"</span> /&gt;

&lt;<span class="org-sgml-namespace">util</span>:<span class="org-function-name">list</span> <span class="org-variable-name">id</span>=<span class="org-string">"aliaslist"</span>&gt;
  &lt;<span class="org-function-name">value</span>&gt;kkkk1&lt;/<span class="org-function-name">value</span>&gt;
  &lt;<span class="org-function-name">value</span>&gt;kkkk2&lt;/<span class="org-function-name">value</span>&gt;
  &lt;<span class="org-function-name">value</span>&gt;kkkk3&lt;/<span class="org-function-name">value</span>&gt;
&lt;/<span class="org-sgml-namespace">util</span>:<span class="org-function-name">list</span>&gt;

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#23558;&#23454;&#20363;&#21270;&#30340;&#24037;&#20316;&#65292;&#22996;&#25176;&#32473;&#24037;&#21378; </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.components.AnimalFactory"</span> <span class="org-variable-name">id</span>=<span class="org-string">"goalmiemie"</span> <span class="org-variable-name">factory-method</span>=<span class="org-string">"xxx"</span> /&gt;
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"learning.components.AnimalFactory"</span> <span class="org-variable-name">id</span>=<span class="org-string">"deshui"</span> <span class="org-variable-name">factory-method</span>=<span class="org-string">"yyy"</span> /&gt;

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#21253;&#21547;&#20854;&#20182;&#30340;&#37197;&#32622;&#25991;&#20214;&#21040;&#36825;&#37324; </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">import</span> <span class="org-variable-name">resource</span>=<span class="org-string">"xxxxx.xml"</span> /&gt;
</pre>
</div>

<p>
另外:
</p>
<ul class="org-ul">
<li>denpend-on 定义顺序</li>
<li>parent 定义继承</li>
<li>scope 定义初始化策略</li>
<li>lazy 延迟初始化</li>
<li>alias 定义别名</li>
<li>import 引入其他的定义文件</li>
</ul>
</div>
</div>

<div id="outline-container-org4d36aa6" class="outline-3">
<h3 id="org4d36aa6"><span class="section-number-3">4.2</span> Wiring in JavaConfig</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Configuration</span>
<span class="org-c-annotation">@ComponentScan</span>(<span class="org-string">"&#21253;&#21517;"</span>)
<span class="org-c-annotation">@ImportResource</span>(<span class="org-string">"..../xxx.xml"</span>)
<span class="org-c-annotation">@Import</span>({ShiroConfig.<span class="org-keyword">class</span>, MybatisConfig.<span class="org-keyword">class</span>, ScheduleConfig.<span class="org-keyword">class</span>})
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">SpringConfig</span> {
    <span class="org-c-annotation">@Bean</span>
    <span class="org-keyword">public</span> <span class="org-type">Author</span> <span class="org-function-name">author</span> () {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">Author</span>(<span class="org-string">"luxun"</span>);
    }

    <span class="org-c-annotation">@Bean</span>
    <span class="org-keyword">public</span> <span class="org-type">Book</span> <span class="org-function-name">book1</span> (<span class="org-type">Author</span> <span class="org-variable-name">author</span>) {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">Book</span>(<span class="org-string">"&#21584;&#21898;"</span>, author);  <span class="org-comment-delimiter">// </span><span class="org-comment">&#21442;&#25968;&#27880;&#20837;</span>
    }

    <span class="org-c-annotation">@Bean</span>(name = <span class="org-string">"book3"</span>)
    <span class="org-keyword">public</span> <span class="org-type">Book</span> <span class="org-function-name">book2</span> () {
        <span class="org-keyword">return</span> <span class="org-keyword">new</span> <span class="org-type">Book</span>(<span class="org-string">"&#21584;&#21898;"</span>, author());  <span class="org-comment-delimiter">// </span><span class="org-comment">&#26041;&#27861;&#35843;&#29992;&#27880;&#20837;</span>
    }
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org580d7b1" class="outline-3">
<h3 id="org580d7b1"><span class="section-number-3">4.3</span> Wiring with Annotation</h3>
<div class="outline-text-3" id="text-4-3">
<p>
首先，需要开启 Component Scanning，即组件扫描:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-comment-delimiter">// </span><span class="org-comment">JavaConfig</span>
<span class="org-c-annotation">@Configuration</span>
<span class="org-c-annotation">@ComponentScan</span>(<span class="org-string">"xxx.components"</span>)
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">SpringConfig</span> {
    <span class="org-comment-delimiter">// </span><span class="org-comment">...</span>
}


<span class="org-comment-delimiter">// </span><span class="org-comment">XMLConfig:</span>
<span class="org-comment-delimiter">//</span>
<span class="org-comment-delimiter">// </span><span class="org-comment">&lt;context:component-scan base-package="xxx.components" /&gt;</span>
</pre>
</div>

<p>
声明 Bean 有四个注解:
</p>
<ol class="org-ol">
<li>@Component</li>
<li>@Controller</li>
<li>@Service</li>
<li>@Repository</li>
</ol>

<p>
在注解的方式中，要确定 Bean 之间的关系，需要使用下面注解进行 “注入”:
</p>
<ul class="org-ul">
<li>@Autowired</li>
<li>@Inject</li>
<li>@Resource</li>
<li>@Value</li>
</ul>

<p>
注入的注解：
</p>
<ul class="org-ul">
<li>可以放在 field 上，称作属性注入</li>
<li>可以放在 constructor 上，称作构造器注入</li>
<li>可以放在 setter 方法上，称作 setter 注入</li>
</ul>

<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Controller</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">BookController</span> {
    <span class="org-c-annotation">@Autowired</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#23646;&#24615;&#27880;&#20837;</span>
    <span class="org-type">BookDAO</span> <span class="org-variable-name">bookDAO</span>;

    <span class="org-c-annotation">@Autowired</span> <span class="org-comment-delimiter">// </span><span class="org-comment">&#26500;&#36896;&#22120;&#27880;&#20837;</span>
    <span class="org-keyword">public</span> <span class="org-function-name">BookController</span>(<span class="org-type">BookDAO</span> <span class="org-variable-name">bookDAO</span>) {
        <span class="org-keyword">this</span>.bookDAO = bookDAO;
    }

    <span class="org-c-annotation">@Autowired</span> <span class="org-comment-delimiter">// </span><span class="org-comment">setter &#27880;&#20837;</span>
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">setBookDAO</span>(<span class="org-type">BookDAO</span> <span class="org-variable-name">bookDAO</span>) {
        <span class="org-keyword">this</span>.bookDAO = bookDAO;
    }
}
</pre>
</div>

<p>
属性注入的写法是最简单的，但不建议使用。原因:
</p>
<ol class="org-ol">
<li>&#x2026;</li>
<li>&#x2026;</li>
<li>&#x2026;</li>
</ol>
</div>
</div>
</section>

<section id="outline-container-orgff8392d" class="outline-2">
<h2 id="orgff8392d"><span class="section-number-2">5</span> 生命周期 (Lifecycle)</h2>
<div class="outline-text-2" id="text-5">
<p>
如果想在 Bean 实例化过程中，做一些额外的事情，就需要了解 Bean 从产生，到使用，到最后销毁的整个过程。
</p>

<p>
也就是 Bean 的生命周期。
</p>


<figure>
<img src="img/clip_2018-12-14_01-43-10.png" alt="clip_2018-12-14_01-43-10.png" style="width: 500px">

</figure>

<p>
一个 Bean 从产生到消亡经历了这些过程:
</p>

<ol class="org-ol">
<li>Spring 对 bean 进行实例化 (<code>Instance</code>)</li>
<li>Spring 对 bean 的值或引用进行注入 (<code>Populate Properties</code>)</li>
<li>若实现了 BeanNameAware 接口，则调用 setBeanName 方法，即 <code>BeanNameAware.setBeanName()</code></li>
<li><code>BeanFactoryAware.setBeanFactory()</code></li>
<li><code>ApplicationContextAware.setApplicationContext()</code></li>
<li><code>BeanPostProcessor.postProcessBeforeInitialization()</code></li>
<li><code>InitializingBean.afterPropertiesSet()</code>。若声明了 <code>init-method</code> 方法，调用之</li>
<li><code>BeanPostProcessor.postProcessAfterInitialzation()</code></li>
<li><b>此时 bean 准备就绪，就可以使用了，直到销毁</b></li>
<li><code>DisposableBean.destroy()</code>。若 bean 声明了 destory-method 属性，调用之</li>
</ol>
</div>
</section>
<section id="outline-container-orgd96689a" class="outline-2">
<h2 id="orgd96689a"><span class="section-number-2">6</span> 面向切面编程 (AOP, Aspect Oriten Program)</h2>
<div class="outline-text-2" id="text-6">
<p>
如果对一个对象的方法进行<b>扩充</b>（不改变源码的情况之下，增加或修改行为）的话，一般使用代理模式：
</p>
<ol class="org-ol">
<li><del>静态代理（太麻烦，一般不会用）</del></li>
<li>JDK 的动态代理</li>
<li>CGLib 的动态代理</li>
</ol>

<p>
但是，直接写代理生成太麻烦了，所以，基于动态代理，产生了 AOP 的编程思想。
</p>

<blockquote>
<p>

</p>

<p>
扩充 = 功能分离。主线功能，支线功能，分开来，实现解耦。
</p>
</blockquote>

<p>
实际中，基于代理实现的 AOP 方案有很多，比如:
</p>
<ol class="org-ol">
<li>AspectJ 实现</li>
<li>Jboss AOP 实现</li>
<li>Spring AOP 实现</li>
</ol>

<p>
关于 Spring AOP:
</p>
<ul class="org-ul">
<li>默认情况下，它基于 JDK 动态代理，所以它需要有接口。</li>
<li>但是，也可以调用 CGLib 的代理方式。</li>
<li>一般情况下，要为一个类产生代理。如果它有接口，那么 Spring 会采取 JDK 动态代理方式；如果没接口，这时候它会尝试使用 CGLib 的方式产生代理</li>
<li>Spring AOP 实现，它的功能<b>相对来说</b>比较弱，只能基于方法进行织入</li>
<li>Spring AOP 压根就没有想过成为一个全能的 AOP 实现来取代 AspectJ，它主要的精力放在怎么跟容器结合起来更好用，怎么才能更好得配合企业级开发</li>
<li>Spring AOP 借鉴了 AspectJ 的非常多的特性，比如说，Spring AOP 可以使用跟 AspectJ 完全一样的注解来声明切面。当然要明白，虽然我们可以使用 @AspectJ 的注解，但后面运行的还是实打实的 Spring AOP。</li>
<li>Spring 中可以非常简单的将其他 AOP 的实现无缝整合到框架中，所以，如果你觉得 Spring AOP 的实现太逊，你完全可以将其他实现整合进来，取代 Spring AOP。</li>
</ul>
</div>
</section>


<section id="outline-container-org80086d2" class="outline-2">
<h2 id="org80086d2"><span class="section-number-2">7</span> 概念</h2>
<div class="outline-text-2" id="text-7">

<figure>
<img src="img/clip_2018-12-18_07-19-33.png" alt="clip_2018-12-18_07-19-33.png">

</figure>

<p>
基本概念:
</p>
<ul class="org-ul">
<li><b>Advice</b>: 要向目标位置加入什么</li>
<li><b>Pointcut</b>: 要加到哪些位置</li>
<li><b>Aspect</b>: 一系列 Advice + Pointcut 的集合。</li>
<li><b>Joinpoint</b>: Pointcut 中的具体某个位置</li>
</ul>

<p>
<b>织入(Weaving)</b> 是把切面应用到目标对象并创建新的代理对象的过程:
</p>
<ul class="org-ul">
<li>编译期。切面在目标类编译时被织入。这需要特殊的编译器，比如 AspectJ</li>
<li>类加载期。需要特殊的 Classloader。AspectJ 的加载时织入就支持这种方式织入切面</li>
<li>运行期。使用动态代理的方式织入。Spring AOP 就是用这种方式织入的</li>
</ul>

<p>
<b>通知类型</b>:
</p>
<ul class="org-ul">
<li>前置通知(Before advice): 在某连接点之前执行的通知，但这个通知不能阻止连接点之前的执行流程（除非它抛出一个异常）</li>
<li>后置通知(After returning advice): 在某连接点正常完成后执行的通知</li>
<li>异常通知(After throwing advice): 在方法抛出异常退出时执行的通知</li>
<li>最终通知(After (finally) advice): 当某连接点退出的时候执行的通知（不论是正常返回还是异常退出）。</li>
<li>环绕通知(Around Advice): 包围一个连接点的通知，如方法调用</li>
</ul>
</div>
</section>

<section id="outline-container-org847d884" class="outline-2">
<h2 id="org847d884"><span class="section-number-2">8</span> 使用 @AspectJ 注解</h2>
<div class="outline-text-2" id="text-8">
<p>
使用 @AspectJ 的注解，需要相关 jar 包支持:
:org.aspectj:aspectjweaver:1.8.9
</p>

<p>
而且需要在配置文件中添加:
</p>
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">aspectj-autoproxy</span>/&gt;
&lt;<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">aspectj-autoproxy</span> <span class="org-variable-name">proxy-target-class</span>=<span class="org-string">"true"</span>/&gt; <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">cglib support </span><span class="org-comment-delimiter">--&gt;</span>

<span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">or </span><span class="org-comment-delimiter">--&gt;</span>
&lt;<span class="org-function-name">bean</span> <span class="org-variable-name">class</span>=<span class="org-string">"org.springframework.aop.aspectj.annotation.AnnotationAwareAspectJAutoProxyCreator"</span>/&gt;
</pre>
</div>

<p>
如果使用 Java 配置，需要添加:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Configuration</span>
<span class="org-c-annotation">@ComponentScan</span>(basePackages = <span class="org-string">"the.aop"</span>)
<span class="org-c-annotation">@EnableAspectJAutoProxy</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">SpringConfig</span> {
}
</pre>
</div>

<p>
代码示例:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-c-annotation">@Component</span>
<span class="org-c-annotation">@Aspect</span>
<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">Audience</span> {
    <span class="org-c-annotation">@Pointcut</span>(<span class="org-string">"execution(** concert.Performance.perform(..))"</span>)
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">xxx</span>();

    <span class="org-c-annotation">@Before</span>(<span class="org-string">"xxx()"</span>)
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">silenceCellPhones</span>() {
        System.out.println(<span class="org-string">"Silencing cell phones"</span>);
    }

    <span class="org-c-annotation">@Before</span>(<span class="org-string">"execution(** concert.Performance.perform(..))"</span>)
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">takeSeats</span>() {
        System.out.println(<span class="org-string">"Taking seats"</span>);
    }

    <span class="org-c-annotation">@AfterReturning</span>(<span class="org-string">"execution(** concert.Performance.perform(..))"</span>)
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">applause</span>() {
        System.out.println(<span class="org-string">"CLAP CLAP CLAP!!!"</span>);
    }

    <span class="org-c-annotation">@AfterThrowing</span>(<span class="org-string">"execution(** concert.Performance.perform(..))"</span>)
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">demandRefund</span>() {
        System.out.println(<span class="org-string">"Demanding a refund"</span>);
    }

    <span class="org-c-annotation">@Around</span>(<span class="org-string">"xxx()"</span>)
    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">yyyy</span>(<span class="org-type">ProceedingJoinPoint</span> <span class="org-variable-name">jp</span>) {
        <span class="org-keyword">try</span> {
            System.out.println(<span class="org-string">"aaaa"</span>);
            jp.proceed();
            System.out.println(<span class="org-string">"bbb"</span>);
        } <span class="org-keyword">catch</span>(<span class="org-type">Throwable</span> <span class="org-variable-name">e</span>) {
            System.out.println(<span class="org-string">"error"</span>);
        }
    }
}
</pre>
</div>

<p>
切点表达式:
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">函数</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">execution()</td>
<td class="org-left">execution(* com.*.*(..)), 表示匹配 com 包下所有方法</td>
</tr>

<tr>
<td class="org-left">@annotation()</td>
<td class="org-left">@annotation(com.Test), 表示匹配所有标注了 @Test 的方法</td>
</tr>

<tr>
<td class="org-left">args()</td>
<td class="org-left">arg(int, int), 表示匹配所有参数为 int, int 的方法</td>
</tr>

<tr>
<td class="org-left">@args()</td>
<td class="org-left">@arg(Test), 匹配参数注解为 Test 的方法</td>
</tr>

<tr>
<td class="org-left">within()</td>
<td class="org-left">within(sss.*), 匹配 sss 包下所有的类下的所有方法</td>
</tr>

<tr>
<td class="org-left">target()</td>
<td class="org-left">target(sss.Test), 匹配所有的类及其子类</td>
</tr>

<tr>
<td class="org-left">@within()</td>
<td class="org-left">@within(sss.Test), 匹配所有使用 Test 注解的类的所有方法</td>
</tr>

<tr>
<td class="org-left">@target</td>
<td class="org-left">@target(sss.Test), 所有当前目标对象使用 Test 注解的类的所有方法</td>
</tr>

<tr>
<td class="org-left">this()</td>
<td class="org-left">this(sss.Test), 当前 AOP 对象实现了 Test 接口的所有方法</td>
</tr>
</tbody>
</table>
</div>
</section>

<section id="outline-container-orgef39585" class="outline-2">
<h2 id="orgef39585"><span class="section-number-2">9</span> 使用 XML 配置的示例</h2>
<div class="outline-text-2" id="text-9">
<div class="org-src-container">
<pre class="src src-sgml">&lt;<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">config</span>&gt;
  &lt;<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">aspect</span> <span class="org-variable-name">ref</span>=<span class="org-string">"loggingAspect"</span>&gt; <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#20999;&#38754;&#31867; </span><span class="org-comment-delimiter">--&gt;</span>
    &lt;<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">pointcut</span> <span class="org-variable-name">id</span>=<span class="org-string">"persons"</span> <span class="org-variable-name">expression</span>=<span class="org-string">"execution(* xxx.*.*(..))"</span> /&gt; <span class="org-comment-delimiter">&lt;!-- </span><span class="org-comment">&#20999;&#28857; </span><span class="org-comment-delimiter">--&gt;</span>

    &lt;<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">before</span> <span class="org-variable-name">method</span>=<span class="org-string">"beforeEat"</span> <span class="org-variable-name">pointcut-ref</span>=<span class="org-string">"persons"</span> /&gt;
    &lt;<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">after-returning</span> <span class="org-variable-name">method</span>=<span class="org-string">"endIt"</span> <span class="org-variable-name">pointcut-ref</span>=<span class="org-string">"persons"</span> /&gt;
    &lt;<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">after-throwing</span> <span class="org-variable-name">method</span>=<span class="org-string">"whenError"</span> <span class="org-variable-name">pointcut-ref</span>=<span class="org-string">"execution(** concert.Performance.perform(..))"</span> /&gt;
  &lt;/<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">aspect</span>&gt;
&lt;/<span class="org-sgml-namespace">aop</span>:<span class="org-function-name">config</span>&gt;
</pre>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: 孙悟空</p>
<p class="date">Created: 2018-12-18 Tue 07:19</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
