<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2018-11-08 Thu 03:46 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>File API</title>
<meta name="generator" content="Org mode">
<meta name="author" content="孙悟空">
<link rel='stylesheet' href='/asset/common.css' />
<script src='https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js'></script>
<script src='https://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
<script src='/asset/common.js'></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">File API</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfafb2eb">1. Simple APIs</a></li>
<li><a href="#org1443f44">2. Preview Demo</a></li>
<li><a href="#orgd1a3e7b">3. Compress and Upload with AJAX</a></li>
</ul>
</div>
</nav>
<p>
ES5 推出了一系列的 API:
</p>
<ul class="org-ul">
<li>BLOB (二进制大对象)</li>
<li>File (文件接口，基于 BLOB，但是增加了文件相关的方法，比如路径，大小)</li>
<li>FileList (借助 &lt;input type="file"&gt;，来获取硬盘文件的一个接口)</li>
<li>FileReader</li>
<li>URL</li>
</ul>

<section id="outline-container-orgfafb2eb" class="outline-2">
<h2 id="orgfafb2eb"><span class="section-number-2">1</span> Simple APIs</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">
<pre class="src src-js"><span class="org-comment-delimiter">// </span><span class="org-comment">&#31532;&#19968;&#27493;&#65292;&#33719;&#21462; input</span>
<span class="org-keyword">var</span> <span class="org-variable-name">fileInput</span> = document.getElementById(<span class="org-string">"myfile"</span>);

<span class="org-comment-delimiter">// </span><span class="org-comment">&#31532;&#20108;&#27493;&#65292;&#36890;&#36807; input &#33719;&#21462; FileList</span>
<span class="org-keyword">var</span> <span class="org-variable-name">fileList</span> = fileInput.files;

<span class="org-comment-delimiter">// </span><span class="org-comment">&#31532;&#19977;&#27493;&#65292;&#36890;&#36807; FileList &#33719;&#21462;&#26576;&#20010;&#25991;&#20214;&#30340;&#23545;&#35937;</span>
<span class="org-keyword">var</span> <span class="org-variable-name">file</span> = fileList[0];

<span class="org-comment-delimiter">// </span><span class="org-comment">&#31616;&#21333;&#26469;&#35828;&#65292;&#33719;&#21462; File &#23545;&#35937;&#23601;&#26159;:</span>
file = document.getElementById(<span class="org-string">'myfile'</span>).files[0];
</pre>
</div>


<p>
一个图片 &lt;img src="" &gt; 的 src 可以使下面三个之一:
</p>
<ol class="org-ol">
<li>文件在操作系统中的路径</li>
<li>DataURL 数据，用 Base64 编码，将二进制文件进行加密的过程，然后就可以使用这字符串来表示二进制文件了</li>
<li>ObjectURL，它是我们需要使用的文件的一个引用字符串而已，格式为 <code>blob:http://localhsot:8080/a3b05b0e-bd18-4b53-b6b8-0b345e9aebdb</code></li>
</ol>
</div>
</section>


<section id="outline-container-org1443f44" class="outline-2">
<h2 id="org1443f44"><span class="section-number-2">2</span> Preview Demo</h2>
<div class="outline-text-2" id="text-2">
<p>
使用 ObjectURL:
</p>
<div class="org-src-container">
<pre class="src src-js">myfile.onchange = <span class="org-keyword">function</span> () {
    <span class="org-keyword">var</span> <span class="org-variable-name">imgUrl</span> = URL.createObjectURL(myfile.files[0]);
    myimg.src = imgUrl;
    myimg.onload = () =&gt; URL.revokeObjectURL(imgUrl);
};
</pre>
</div>
</div>
</section>

<section id="outline-container-orgd1a3e7b" class="outline-2">
<h2 id="orgd1a3e7b"><span class="section-number-2">3</span> Compress and Upload with AJAX</h2>
<div class="outline-text-2" id="text-3">
<div class="org-src-container">
<pre class="src src-js"><span class="org-keyword">function</span> <span class="org-function-name">shangchuantupian</span>() {
    <span class="org-comment-delimiter">// </span><span class="org-comment">1. &#33719;&#21462;&#22270;&#29255;&#30340;&#25968;&#25454;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">2. &#26657;&#39564;&#22823;&#23567;&#65292;&#22914;&#26524;&#36229;&#36807;&#23610;&#23544;&#65292;&#37027;&#20040;&#23545;&#20854;&#36827;&#34892;&#21387;&#32553;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">3. &#21152;&#19978;&#20320;&#30340;&#27700;&#21360;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">4. &#35843;&#29992; ajax &#26041;&#24335;&#65292;&#23558;&#20854;&#21457;&#36865;&#21040;&#26381;&#21153;&#22120;</span>

    <span class="org-keyword">var</span> <span class="org-variable-name">canvas</span> = document.createElement(<span class="org-string">"canvas"</span>);

    <span class="org-keyword">var</span> <span class="org-variable-name">image</span> = <span class="org-keyword">new</span> <span class="org-type">Image</span>();
    <span class="org-keyword">var</span> <span class="org-variable-name">imgUrl</span> = URL.createObjectURL(myfile.files[0]);
    image.src = imgUrl;

    image.onload = () =&gt; {
        URL.revokeObjectURL(imgUrl);

        canvas.width = image.width / 2;
        canvas.height = image.height / 2;

        <span class="org-keyword">var</span> <span class="org-variable-name">ctx</span> = canvas.getContext(<span class="org-string">'2d'</span>);
        ctx.drawImage(image, 0, 0, image.width / 2, image.height / 2);
        ctx.fillText(<span class="org-string">"nf147"</span>, image.width / 2 - 20, image.height / 2 - 20);

        canvas.toBlob(<span class="org-keyword">function</span> (<span class="org-variable-name">b</span>) {
            <span class="org-keyword">var</span> <span class="org-variable-name">fd</span> = <span class="org-keyword">new</span> <span class="org-type">FormData</span>();
            fd.append(<span class="org-string">"fff"</span>, b);

            fetch(<span class="org-string">"/myupload"</span>, {
                method: <span class="org-string">'post'</span>,
                body: fd
            }).then(resp =&gt; resp.body);
        }, <span class="org-string">"image/jpeg"</span>);
    };
}
</pre>
</div>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: 孙悟空</p>
<p class="date">Created: 2018-11-08 Thu 03:46</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
