<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2018-11-22 周四 02:16 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>MySQL</title>
<meta name="generator" content="Org mode">
<meta name="author" content="孙悟空">
<link rel='stylesheet' href='/asset/common.css' />
<script src='https://cdn.bootcss.com/jquery/2.1.3/jquery.min.js'></script>
<script src='https://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js'></script>
<script src='/asset/common.js'></script>
</head>
<body>
<div id="content">
<header>
<h1 class="title">MySQL</h1>
</header><nav id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org00abba9">1. 安装与配置</a></li>
<li><a href="#orgf64d518">2. 数据库与账户</a></li>
<li><a href="#orgefe28d2">3. 用户跟权限</a></li>
<li><a href="#orgbdbc780">4. 常用命令</a></li>
<li><a href="#org2b127ea">5. 表的创建</a></li>
<li><a href="#orgd3a7bfe">6. 数据类型</a></li>
<li><a href="#org86ea108">7. 主键约束</a></li>
<li><a href="#org8e6269a">8. 表的修改</a></li>
<li><a href="#orga424e4c">9. 引擎(Engine)</a></li>
<li><a href="#org59f2415">10. 存储过程</a>
<ul>
<li><a href="#orgfda20c6">10.1. 基本语句</a></li>
<li><a href="#org5d138e5">10.2. 变量定义</a></li>
<li><a href="#org9d1d971">10.3. 参数与游标</a></li>
<li><a href="#org3a11138">10.4. JDBC 操作存储过程示例</a></li>
</ul>
</li>
<li><a href="#org71fa317">11. 优化(Optimization)</a>
<ul>
<li><a href="#orgad93eb2">11.1. 解释计划(Explain)</a></li>
<li><a href="#orgc3435f8">11.2. 索引</a></li>
</ul>
</li>
<li><a href="#org793bb8a">12. UseCases</a>
<ul>
<li><a href="#orga3f969b">12.1. 使用存储过程批量插入数据</a></li>
<li><a href="#org27d57b7">12.2. 行列转换</a></li>
</ul>
</li>
<li><a href="#orged0fb4d">13. 备份与恢复</a></li>
<li><a href="#orgd0d5d8a">14. 数据迁移示例</a>
<ul>
<li><a href="#org25b1e33">14.1. 命令行的方式</a></li>
<li><a href="#orgd450739">14.2. JDBC 的方式</a></li>
</ul>
</li>
<li><a href="#org17dc9bf">15. 数据处理示例</a>
<ul>
<li><a href="#org3801940">15.1. 数据清理</a></li>
<li><a href="#orgea93cab">15.2. 表的分离</a></li>
</ul>
</li>
<li><a href="#org77c6256">16. 省市县模式数据库设计</a></li>
<li><a href="#org65288bb">17. 查询练习</a></li>
</ul>
</div>
</nav>



<section id="outline-container-org00abba9" class="outline-2">
<h2 id="org00abba9"><span class="section-number-2">1</span> 安装与配置</h2>
<div class="outline-text-2" id="text-1">
<p>
MySQL/MariaDB:
</p>
<ul class="org-ul">
<li><a href="https://www.mysql.com/cn/">https://www.mysql.com/cn/</a></li>
<li><a href="http://mariadb.org">http://mariadb.org</a></li>
</ul>

<p>
比如，MariaDB 的下载页面:
</p>
<ul class="org-ul">
<li><a href="https://downloads.mariadb.org/mariadb/10.3.9/">https://downloads.mariadb.org/mariadb/10.3.9/</a></li>
</ul>

<p>
下载安装即可：
</p>
<ul class="org-ul">
<li>注意，要注意勾选“将utf8作为默认字符集”</li>
<li>安装过程中需要提供 root 用户的密码，需要记住</li>
<li>安装完后，需要将 bin 目录添加到环境变量中</li>
<li>可以选择将 mysqld 安装为 windows 服务，如果没有勾选，那么也可以手动创建服务</li>
</ul>

<p>
创建服务的方式:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#22914;&#26524;&#35201;&#21024;&#38500;&#30456;&#20851;&#26381;&#21153;&#65292;&#21482;&#38656;&#35201;&#22312;&#8220;&#31649;&#29702;&#21592;&#36523;&#20221;&#8221;&#30340;&#21629;&#20196;&#34892;&#31383;&#21475;&#19979;&#38754;&#36816;&#34892;:</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">sc delete &#26381;&#21153;&#21517;&#23383;</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">&#23558; MySQL &#23433;&#35013;&#20026;&#26381;&#21153;&#30340;&#26041;&#24335;:</span>
<span class="org-string">"C:\Program Files\MariaDB 10.3\bin\mysqld.exe"</span> install MyDB --defaults-file=<span class="org-string">"C:\Program Files\MariaDB 10.3\my.ini"</span>
</pre>
</div>

<p>
在连接之前，需要启动服务器守护程序，可以通过下面两种方式之一:
</p>
<ol class="org-ol">
<li>启动相关 windows 服务，比如 MySQL 服务</li>
<li>通过命令行窗口，执行 <code>mysqld --defaults-file=my.ini</code> 命令</li>
</ol>

<p>
服务启动后，就可以通过客户端访问了:
</p>
<div class="org-src-container">
<pre class="src src-sh">mysql -u root -p
mysql -uroot -proot
mysql -h 45.42.32.1 -P 9999 -uroot -p
</pre>
</div>
</div>
</section>

<section id="outline-container-orgf64d518" class="outline-2">
<h2 id="orgf64d518"><span class="section-number-2">2</span> 数据库与账户</h2>
<div class="outline-text-2" id="text-2">
<p>
MySQL 在用户登录后（默认使用 root 用户登录），需要切换到一个 <b>database</b> 才能进行表的创建等操作。所有的表和数据都隶属于某个数据库。
</p>

<p>
刚安装完之后，MySQL 中有若干内置数据库：
</p>


<figure>
<img src="img/clip_2018-09-05_07-24-23.png" alt="clip_2018-09-05_07-24-23.png">

</figure>

<p>
想要切换到某个数据库下，使用 <code>use</code> 指令:
</p>
<pre class="example">
use mysql
</pre>

<p>
我们可以为自己的业务创建单独的数据库，比如，为我们的书店项目我们创建一个单独的数据库:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> database bookstore;
<span class="org-keyword">create</span> database bookstore <span class="org-type">character</span> <span class="org-keyword">set</span> UTF8; <span class="org-comment">-- &#21019;&#24314;&#26102;&#21487;&#20197;&#25351;&#23450;&#23383;&#31526;&#38598;</span>
use bookstore;  <span class="org-comment">-- &#20999;&#25442;&#21040;&#25968;&#25454;&#24211;&#19979;</span>
</pre>
</div>

<p>
虽然 root 用户强大无比，但是使用 root 用户进行数据库操作不是一个好的行为。所以我们需要为数据库的操作创建相关的用户:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#29305;&#21035;&#38656;&#35201;&#27880;&#24847;&#65292;&#22312; MySQL &#20013;&#65292;&#36134;&#21495;&#30001;&#20004;&#37096;&#20998;&#32452;&#25104;:</span>
<span class="org-comment">-- 1. user</span>
<span class="org-comment">-- 2. host</span>
<span class="org-comment">-- &#21363;&#20351; user &#30456;&#21516;&#65292;&#21482;&#35201; host &#19981;&#21516;&#65292;&#20063;&#20250;&#34987;&#35748;&#20026;&#26159;&#19981;&#21516;&#36134;&#21495;&#12290;</span>
<span class="org-comment">-- &#36825;&#26679;&#21487;&#20197;&#38750;&#24120;&#26041;&#20415;&#23545;&#26469;&#33258;&#19981;&#21516; ip &#22320;&#22336;&#30340;&#35775;&#38382;&#36827;&#34892;&#31934;&#32454;&#30340;&#26435;&#38480;&#25511;&#21046;&#12290;</span>
<span class="org-comment">-- &#40664;&#35748;&#24773;&#20917;&#19979;&#65292;&#21019;&#24314;&#30340;&#29992;&#25143; host &#20026; '%'&#65292;&#36825;&#26159;&#19968;&#20010;&#21305;&#37197;&#31526;&#65292;&#36319;&#27169;&#31946;&#26597;&#35810;&#37324;&#30340;&#24847;&#24605;&#19968;&#26679;&#65292;&#34920;&#31034;&#21305;&#37197;&#25152;&#26377;</span>
<span class="org-keyword">create</span> <span class="org-builtin">user</span> vip identified <span class="org-keyword">by</span> <span class="org-string">'vippp'</span>;             <span class="org-comment">-- &#25152;&#26377;&#36830;&#25509;</span>
<span class="org-keyword">create</span> <span class="org-builtin">user</span> vip@<span class="org-string">'127.0.0.1'</span> identified <span class="org-keyword">by</span> <span class="org-string">'xxx'</span>;   <span class="org-comment">-- &#26412;&#22320;&#36830;&#25509;</span>
<span class="org-keyword">create</span> <span class="org-builtin">user</span> vip@<span class="org-string">'192.168.%'</span> identified <span class="org-keyword">by</span> <span class="org-string">'yyy'</span>;   <span class="org-comment">-- 192.168 &#32593;&#27573;&#30340;&#36830;&#25509;</span>
</pre>
</div>

<p>
新创建的用户没有多少权限，登录之后，只能访问操作 test 以及以 test 开头的数据库。如果想让新用户有更多权限，就需要用到授权语句(DCL)：
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">grant</span> <span class="org-keyword">all</span> <span class="org-keyword">on</span> *.* <span class="org-keyword">to</span> vip@<span class="org-string">'127.0.0.1'</span>;        <span class="org-comment">-- &#23558;&#25152;&#26377;&#25968;&#25454;&#24211;&#19978;&#30340;&#25152;&#26377;&#26435;&#21033;&#37117;&#25480;&#20104;&#36890;&#36807;&#26412;&#26426;&#36830;&#25509;&#30340; vip &#29992;&#25143;&#65281;</span>
<span class="org-keyword">grant</span> <span class="org-keyword">all</span> <span class="org-keyword">privileges</span> <span class="org-keyword">on</span> lagou.* <span class="org-keyword">to</span> vip@<span class="org-string">'%'</span>; <span class="org-comment">-- &#23558;&#25968;&#25454;&#24211; lagou &#19978;&#30340;&#25152;&#26377;&#26435;&#21033;&#37117;&#25480;&#20104;&#25152;&#26377;&#36830;&#25509;&#30340; vip &#29992;&#25143;!</span>
<span class="org-keyword">grant</span> <span class="org-keyword">select</span> <span class="org-keyword">on</span> lagou.<span class="org-keyword">position</span> <span class="org-keyword">to</span> vip@<span class="org-string">'%'</span>;  <span class="org-comment">-- &#23558; lagou &#25968;&#25454;&#24211;&#19978;&#30340; position &#34920;&#30340;&#35775;&#38382;&#26435;&#38480;&#24320;&#25918;&#32473;&#25152;&#26377; vip &#29992;&#25143;&#12290;</span>
</pre>
</div>

<p>
如果想查看某个用户拥有的权限，只需要:
</p>
<div class="org-src-container">
<pre class="src src-sql">show grants <span class="org-keyword">for</span> vip@<span class="org-string">'%'</span>;
</pre>
</div>
</div>
</section>

<section id="outline-container-orgefe28d2" class="outline-2">
<h2 id="orgefe28d2"><span class="section-number-2">3</span> 用户跟权限</h2>
<div class="outline-text-2" id="text-3">
<p>
用户跟权限的相关信息，都是保存在下面表中：
</p>
<ul class="org-ul">
<li>mysql.user</li>
<li>mysql.db/host/table/priv&#x2026;</li>
</ul>

<p>
<code>mysql.user</code> 是一个非常重要非常特殊的表，它保存了所有的账号信息，以及保存了账号的权限信息。
</p>

<p>
如果要操作用户和权限，有两种方式:
</p>
<ol class="org-ol">
<li>使用相关的授权语句</li>
<li>直接修改 mysql.user 表</li>
</ol>

<p>
<b>第一种方式</b>:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#26597;&#30475;&#29992;&#25143;</span>
<span class="org-keyword">select</span> <span class="org-builtin">current_user</span>(), <span class="org-builtin">user</span>();
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> mysql.<span class="org-builtin">user</span>;

<span class="org-comment">-- &#21019;&#24314;&#19982;&#25480;&#26435;</span>
<span class="org-keyword">create</span> <span class="org-builtin">user</span> <span class="org-string">'xxx'</span>@<span class="org-string">'host'</span> identified <span class="org-keyword">by</span> <span class="org-string">'&#23494;&#30721;'</span>;
<span class="org-keyword">grant</span> <span class="org-keyword">all</span> <span class="org-keyword">on</span> ttt.* <span class="org-keyword">to</span> <span class="org-string">'user'</span>@<span class="org-string">'host'</span> <span class="org-keyword">with</span> <span class="org-keyword">grant</span> <span class="org-keyword">options</span>;

<span class="org-comment">-- &#26597;&#30475;&#25480;&#26435;&#24773;&#20917;</span>
show grants <span class="org-keyword">for</span> <span class="org-string">'user'</span>@<span class="org-string">'host'</span>;

<span class="org-comment">-- &#29992;&#25143;&#30340;&#31649;&#29702;&#65292;&#21024;&#38500;&#23494;&#30721;&#31561;</span>
<span class="org-keyword">set</span> password <span class="org-keyword">for</span> <span class="org-string">'user'</span>@<span class="org-string">'host'</span> = password(<span class="org-string">'&#26032;&#23494;&#30721;'</span>);
<span class="org-keyword">drop</span> <span class="org-builtin">user</span> vip;

<span class="org-comment">-- &#25480;&#26435;&#30340;&#30456;&#23545;&#23436;&#25972;&#35821;&#27861;&#20026;:</span>
<span class="org-keyword">grant</span> <span class="org-keyword">all</span>/<span class="org-keyword">alter</span>/<span class="org-keyword">create</span>/<span class="org-keyword">drop</span>/<span class="org-keyword">select</span>/<span class="org-keyword">update</span>/<span class="org-keyword">delete</span>
      <span class="org-keyword">on</span> *.* <span class="org-comment">-- db.*/db.table</span>
      <span class="org-keyword">to</span> <span class="org-string">'user'</span>@<span class="org-string">'host'</span>
      identified <span class="org-keyword">by</span> <span class="org-string">'&#23494;&#30721;'</span>
      <span class="org-keyword">with</span> max_user_connections 2
           max_connections_pser_hour 5;
</pre>
</div>


<p>
<b>第二种方式</b>:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#22686;&#21152;&#29992;&#25143;</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> mysql.<span class="org-builtin">user</span>(<span class="org-keyword">host</span>, <span class="org-builtin">user</span>, password) <span class="org-keyword">values</span> (xx, yy, zz);

<span class="org-comment">-- &#20462;&#25913;&#23494;&#30721;</span>
<span class="org-keyword">update</span> mysql.<span class="org-builtin">user</span> <span class="org-keyword">set</span> password=password(<span class="org-string">'&#26032;&#23494;&#30721;'</span>) <span class="org-keyword">where</span> <span class="org-builtin">user</span>=<span class="org-string">'vip'</span> <span class="org-keyword">and</span> <span class="org-keyword">host</span>=<span class="org-string">'%'</span>;

<span class="org-comment">-- &#20462;&#25913;&#26435;&#38480;</span>
<span class="org-keyword">update</span> mysql.<span class="org-builtin">user</span> <span class="org-keyword">set</span> event_priv=<span class="org-string">'Y'</span> <span class="org-keyword">where</span> <span class="org-builtin">user</span>=<span class="org-string">'vip'</span> <span class="org-keyword">and</span> <span class="org-keyword">host</span>=<span class="org-string">'%'</span>;

<span class="org-comment">-- &#27880;&#24847;&#65292;&#20351;&#29992; sql &#35821;&#21477;&#20462;&#25913;&#29992;&#25143;&#36319;&#26435;&#38480;&#20043;&#21518;&#65292;&#38656;&#35201;&#25163;&#21160;&#21047;&#26032;&#26435;&#38480;&#34920;</span>
flush <span class="org-keyword">privileges</span>;
</pre>
</div>
</div>
</section>
<section id="outline-container-orgbdbc780" class="outline-2">
<h2 id="orgbdbc780"><span class="section-number-2">4</span> 常用命令</h2>
<div class="outline-text-2" id="text-4">
<p>
基本命令:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#26597;&#35810;&#24403;&#21069;&#26085;&#26399;</span>
<span class="org-keyword">select</span> now(), <span class="org-builtin">current_date</span>, <span class="org-builtin">current_time</span>;

<span class="org-comment">-- &#26597;&#35810;&#24403;&#21069;&#29992;&#25143;</span>
<span class="org-keyword">select</span> <span class="org-builtin">user</span>(), <span class="org-builtin">current_user</span>();

<span class="org-comment">-- &#25968;&#25454;&#24211;</span>
show databases;
use test;
</pre>
</div>

<p>
更多命令：
</p>
<div class="org-src-container">
<pre class="src src-sql">show engines; <span class="org-comment">-- &#25152;&#26377;&#24341;&#25806;</span>
show plugins; <span class="org-comment">-- &#25152;&#26377;&#25554;&#20214;</span>
show variables; <span class="org-comment">-- &#25152;&#26377;&#31995;&#32479;&#21464;&#37327;</span>
show variables <span class="org-keyword">like</span> <span class="org-string">'%char%'</span>; <span class="org-comment">-- &#21487;&#20197;&#20351;&#29992; like &#36827;&#34892;&#36807;&#28388;, &#27880;&#24847; % _ &#30340;&#20351;&#29992;</span>
<span class="org-keyword">set</span> <span class="org-keyword">names</span> utf8; <span class="org-comment">-- &#19968;&#20010;&#24555;&#25463;&#26041;&#24335;&#65292;&#29992;&#26469;&#24555;&#36895;&#25209;&#37327;&#35774;&#32622;&#23383;&#31526;&#38598;</span>

show <span class="org-keyword">full</span> processlist;
kill 109;
</pre>
</div>
</div>
</section>

<section id="outline-container-org2b127ea" class="outline-2">
<h2 id="org2b127ea"><span class="section-number-2">5</span> 表的创建</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book1</span> (
   bookid <span class="org-type">int</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>
);
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book2</span> (
   bookid <span class="org-type">int</span>,
   <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (bookid)
);
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book3</span> (
   bookid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>
);
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book4</span> (
   bookid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
   <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
   price <span class="org-type">float</span> <span class="org-keyword">check</span> (price &gt;= 0)
);
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book5</span> (
   bookid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
   <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
   price <span class="org-type">float</span> <span class="org-keyword">check</span> (price &gt;= 0),
   press <span class="org-type">varchar</span>(50),
   authorid <span class="org-type">int</span> <span class="org-keyword">references</span> author (authorid)
   <span class="org-comment">-- foreign  key(author) references author(authorid),</span>
);
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book6</span> (
   bookid <span class="org-type">int</span> auto_increment,
   <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
   price <span class="org-type">float</span> <span class="org-keyword">check</span> (price &gt;= 0),
   press <span class="org-type">varchar</span>(50),
   authorid <span class="org-type">int</span>,

   <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (bookid),
   <span class="org-keyword">foreign</span> <span class="org-keyword">key</span> (authorid) <span class="org-keyword">references</span> author (authorid)
);
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book7</span> (
   bookid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
   <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
   price <span class="org-type">float</span> <span class="org-keyword">check</span> (price &gt;= 0),
   press <span class="org-type">varchar</span>(50),
   authorid <span class="org-type">int</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">author</span> (
  authorid <span class="org-type">int</span> auto_increment,
  <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
  tel <span class="org-type">varchar</span>(20),
  birth <span class="org-type">date</span>,
  <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (authorid)
);



<span class="org-comment">-- &#23454;&#38469;&#30340;&#23548;&#20837;&#24773;&#20917;&#65292;&#39318;&#20808;&#21019;&#24314;&#34920;&#65292;&#20808;&#19981;&#28155;&#21152;&#20219;&#20309;&#22806;&#38190;&#32422;&#26463;</span>
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">book</span> (
   bookid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
   <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
   price <span class="org-type">float</span> <span class="org-keyword">check</span> (price &gt;= 0),
   press <span class="org-type">varchar</span>(50),
   authorid <span class="org-type">int</span>,
   publish_at datetime,
   created_at <span class="org-type">timestamp</span>
);
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">author</span> (
  authorid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
  <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
  tel <span class="org-type">varchar</span>(20),
  birth <span class="org-type">date</span>
);
<span class="org-comment">-- &#22312;&#36825;&#37324;&#65292;&#25191;&#34892;&#25152;&#26377;&#30340;&#25968;&#25454;&#25554;&#20837;&#25805;&#20316;</span>
<span class="org-comment">-- insert into book ...</span>
<span class="org-comment">-- insert into author ...</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">book</span> 
   <span class="org-keyword">add</span> <span class="org-keyword">constraint</span> fk_authorid
   <span class="org-keyword">foreign</span> <span class="org-keyword">key</span> (authorid)
   <span class="org-keyword">references</span> author (authorid);
<span class="org-comment">-- &#22914;&#26524;&#38656;&#35201;&#28155;&#21152;&#20027;&#38190;&#30340;&#35805;&#65292;&#35821;&#27861;&#22914;&#19979;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">book</span>
   <span class="org-keyword">add</span> <span class="org-keyword">constraint</span> pk_bookid
   <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (bookid);
<span class="org-comment">-- &#22914;&#26524;&#24819;&#21024;&#38500;&#25481;&#30340;&#35805;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">book</span>
   <span class="org-keyword">drop</span> <span class="org-keyword">foreign</span> <span class="org-keyword">key</span> fk_authorid;
</pre>
</div>


<p>
其他:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">xxx</span> if <span class="org-keyword">not</span> <span class="org-keyword">exists</span> (id <span class="org-type">int</span>);

<span class="org-keyword">create</span> <span class="org-keyword">temporary</span> <span class="org-keyword">table</span> <span class="org-function-name">yyy</span> (id <span class="org-type">int</span>);

<span class="org-keyword">create</span> <span class="org-keyword">temporary</span> <span class="org-keyword">table</span> if <span class="org-keyword">not</span> <span class="org-keyword">exists</span> <span class="org-function-name">yyy</span> (
       id bigint auto_increment,
       <span class="org-keyword">name</span> <span class="org-type">varchar</span>(20) <span class="org-keyword">not</span> <span class="org-keyword">null</span> <span class="org-keyword">unique</span>, <span class="org-comment">-- &#21807;&#19968;&#65292;&#19981;&#37325;&#22797;&#30340;</span>
       birth datetime,
       gender enum(<span class="org-string">'f'</span>, <span class="org-string">'m'</span>), <span class="org-comment">-- Female Male</span>
       minzu <span class="org-keyword">set</span>(<span class="org-string">'&#27721;'</span>, <span class="org-string">'&#20420;&#32599;&#26031;'</span>),
       created_at <span class="org-type">timestamp</span>,
       <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (id)
);


<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">aaa</span> (id <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>, <span class="org-keyword">name</span> <span class="org-type">varchar</span>(20))
   <span class="org-keyword">default</span> charset = gbk
   engine = InnoDB
   auto_increment = 7
   comment = `&#36825;&#21482;&#26159;&#19968;&#20010;&#27979;&#35797;&#34920;&#32780;&#24050;`;

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">gbk_test2</span> (vvv <span class="org-type">varchar</span>(4)) <span class="org-keyword">default</span> charset = gbk;
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">gbk_test3</span> (vvv <span class="org-type">varchar</span>(4)) <span class="org-keyword">default</span> charset = utf8;
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> gbk_test2 <span class="org-keyword">values</span> (<span class="org-string">'&#20013;&#22269;'</span>);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> gbk_test3 <span class="org-keyword">values</span> (<span class="org-string">'&#20013;&#22269;'</span>);
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> gbk_test2;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> gbk_test3;
<span class="org-keyword">select</span> <span class="org-keyword">length</span>(vvv) <span class="org-keyword">from</span> gbk_test2;
<span class="org-keyword">select</span> <span class="org-keyword">length</span>(vvv) <span class="org-keyword">from</span> gbk_test3;
<span class="org-keyword">select</span> <span class="org-builtin">char_length</span>(vvv) <span class="org-keyword">from</span> gbk_test2;
<span class="org-keyword">select</span> <span class="org-builtin">char_length</span>(vvv) <span class="org-keyword">from</span> gbk_test3;
</pre>
</div>

<p>
一致性，完整性
</p>

<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">id</th>
<th scope="col" class="org-left">名字</th>
<th scope="col" class="org-right">xxx</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">Java</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">太极剑法</td>
<td class="org-right">1</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">MySQL指南</td>
<td class="org-right">22</td>
</tr>
</tbody>
</table>


<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">id</th>
<th scope="col" class="org-left">名字</th>
<th scope="col" class="org-left">生日</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">1</td>
<td class="org-left">张三丰</td>
<td class="org-left">x</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">我</td>
<td class="org-left">y</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">你妹</td>
<td class="org-left">z</td>
</tr>
</tbody>
</table>
</div>
</section>

<section id="outline-container-orgd3a7bfe" class="outline-2">
<h2 id="orgd3a7bfe"><span class="section-number-2">6</span> 数据类型</h2>
<div class="outline-text-2" id="text-6">
<p>
大致分为 <b>6</b> 类:
</p>
<ol class="org-ol">
<li><b>整数</b>: bit / bool / tinyint / smallint / mediumint / int / bitint</li>
<li><b>浮点数</b>: float / double / decimal</li>
<li><b>字符串</b>: char / varchar / tinytext / text / mediumtext / longtext</li>
<li><b>BLOB(Binary Large Object)</b>: tinyblob / blob / mediumblob / longblob</li>
<li><b>日期</b>: date(2018-9-6) / time (03:33:49) / datetime(2018-9-6 03:34:08) / timestamp</li>
<li><b>其他</b>: binary / varbinary / enum / set / geometry / point / LineString &#x2026;</li>
</ol>

<p>
问题:
</p>
<ol class="org-ol">
<li>char 跟 varchar 有什么区别？</li>
<li>varchar 最多存储的长度是多少？</li>
<li>varchar 跟 text 类型有什么区别？</li>
<li>set/enum 该怎么去使用？</li>
</ol>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">char_demo</span> 
(
  aaa <span class="org-type">char</span>(40),
  bbb <span class="org-type">varchar</span>(40),
  ccc text(40)
);

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> char_demo <span class="org-keyword">values</span> (<span class="org-string">'123'</span>, <span class="org-string">'123'</span>, <span class="org-string">'123'</span>);

<span class="org-keyword">select</span> <span class="org-keyword">length</span>(aaa), <span class="org-keyword">length</span>(bbb), <span class="org-keyword">length</span>(ccc) <span class="org-keyword">from</span> char_demo;

<span class="org-keyword">SET</span> sql_mode = <span class="org-string">'PAD_CHAR_TO_FULL_LENGTH'</span>;

<span class="org-keyword">select</span> <span class="org-keyword">length</span>(aaa), <span class="org-keyword">length</span>(bbb), <span class="org-keyword">length</span>(ccc) <span class="org-keyword">from</span> char_demo;
</pre>
</div>

<p>
总结 Char vs Varchar vs Text:
</p>
<ol class="org-ol">
<li>char(n) 和 varchar(n) 中间的 n 代表字符的个数，不是字节的个数</li>
<li>如果数据超过 n 的限制，那么数据将会被截断</li>
<li>char 是固定宽度，如果数据长度不满足 n，那么将会在右边用空格补齐；varchar 是变长宽度</li>
<li>varchar 是标准类型；text 不是标准类型</li>
<li>varchar 跟 text 都最大保存 65535 字节长度的数据。但是 text 还有 mediumtext/longtext 它可以支持存储更多的内容</li>
<li>varchar 的存储格式是 stored-inline, text 的存储格式是 off-record。一般情况来说，varchar 的速度要比 text 快</li>
</ol>

<p>
BLOB 类型，可以存储大字段。
</p>

<p>
ENUM 跟 SET 是两种比较特殊的字符串类型，他们对字段进行了一定约束:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> (
       id <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
       <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
       gender <span class="org-type">char</span>(2) <span class="org-comment">-- &#38480;&#21046;&#65292;&#21482;&#26377; &#30007;&#12289;&#22899;&#12289;&#26410;&#30693;</span>
);


<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> (
       id <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
       <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
       gender enum(<span class="org-string">'&#30007;'</span>, <span class="org-string">'&#22899;'</span>, <span class="org-string">'&#26410;&#30693;'</span>) <span class="org-comment">-- &#38480;&#21046;&#65292;&#21482;&#26377; &#30007;&#12289;&#22899;&#12289;&#26410;&#30693;</span>
);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">person2</span> (
       id <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
       <span class="org-keyword">name</span> <span class="org-type">varchar</span>(30) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
       gender enum(<span class="org-string">'&#30007;'</span>, <span class="org-string">'&#22899;'</span>, <span class="org-string">'&#26410;&#30693;'</span>), <span class="org-comment">-- &#38480;&#21046;&#65292;&#21482;&#26377; &#30007;&#12289;&#22899;&#12289;&#26410;&#30693;</span>
       country <span class="org-keyword">set</span>(<span class="org-string">'&#20013;&#22269;'</span>, <span class="org-string">'&#32654;&#22269;'</span>, <span class="org-string">'&#21335;&#38750;'</span>)
);

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> person3 (<span class="org-keyword">name</span>, gender, country) <span class="org-keyword">values</span> (<span class="org-string">'&#28781;&#32477;'</span>, <span class="org-string">'&#22899;'</span>, <span class="org-string">'&#32654;&#22269;,&#21335;&#38750;'</span>);
</pre>
</div>
</div>
</section>

<section id="outline-container-org86ea108" class="outline-2">
<h2 id="org86ea108"><span class="section-number-2">7</span> 主键约束</h2>
<div class="outline-text-2" id="text-7">
<p>
主键，primary key，从性能和实际出发，应该遵循下面几点:
</p>
<ol class="org-ol">
<li>尽量短，避免占用太多空间</li>
<li>唯一，不能跟其他行的数据重复</li>
<li>不会改变</li>
<li>代理键</li>
</ol>

<p>
所谓<b>代理键</b>是指跟业务无关的字段:
</p>
<ul class="org-ul">
<li>因为和业务无关，所以可以使用 int 等类型尽量短</li>
<li>因为和业务无关，所以可以避免因为业务变动引起的主键变化</li>
<li><b>不要相信自己的直觉，因为在直觉上感觉不会变的东西，往往都是经不起实践考验的</b></li>
</ul>
</div>
</section>

<section id="outline-container-org8e6269a" class="outline-2">
<h2 id="org8e6269a"><span class="section-number-2">8</span> 表的修改</h2>
<div class="outline-text-2" id="text-8">
<p>
基本语法:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">ALTER</span> [ONLINE|OFFLINE] [<span class="org-keyword">IGNORE</span>] <span class="org-keyword">TABLE</span> tbl_name
    [alter_specification [, alter_specification] ...]
    [partition_options]

alter_specification:
    table_options
  | <span class="org-keyword">ADD</span> [<span class="org-keyword">COLUMN</span>] col_name column_definition
        [<span class="org-keyword">FIRST</span> | <span class="org-keyword">AFTER</span> col_name]
  | <span class="org-keyword">ADD</span> [<span class="org-keyword">COLUMN</span>] (col_name column_definition,...)

  | <span class="org-keyword">ADD</span> {INDEX|<span class="org-keyword">KEY</span>} [index_name]
        [index_type] (key_part,...) [index_option] ...
  | <span class="org-keyword">ADD</span> [<span class="org-keyword">CONSTRAINT</span> [symbol]] <span class="org-keyword">PRIMARY</span> <span class="org-keyword">KEY</span>
        [index_type] (key_part,...) [index_option] ...
  | <span class="org-keyword">ADD</span> [<span class="org-keyword">CONSTRAINT</span> [symbol]]
        <span class="org-keyword">UNIQUE</span> [INDEX|<span class="org-keyword">KEY</span>] [index_name]
        [index_type] (key_part,...) [index_option] ...
  | <span class="org-keyword">ADD</span> FULLTEXT [INDEX|<span class="org-keyword">KEY</span>] [index_name]
        (key_part,...) [index_option] ...
  | <span class="org-keyword">ADD</span> SPATIAL [INDEX|<span class="org-keyword">KEY</span>] [index_name]
        (key_part,...) [index_option] ...
  | <span class="org-keyword">ADD</span> [<span class="org-keyword">CONSTRAINT</span> [symbol]]
        <span class="org-keyword">FOREIGN</span> <span class="org-keyword">KEY</span> [index_name] (col_name,...)
        reference_definition
  | ALGORITHM [=] {<span class="org-keyword">DEFAULT</span>|INPLACE|COPY}
  | <span class="org-keyword">ALTER</span> [<span class="org-keyword">COLUMN</span>] col_name {<span class="org-keyword">SET</span> <span class="org-keyword">DEFAULT</span> literal | <span class="org-keyword">DROP</span> <span class="org-keyword">DEFAULT</span>}
  | CHANGE [<span class="org-keyword">COLUMN</span>] old_col_name new_col_name column_definition
        [<span class="org-keyword">FIRST</span>|<span class="org-keyword">AFTER</span> col_name]
  | [<span class="org-keyword">DEFAULT</span>] <span class="org-type">CHARACTER</span> <span class="org-keyword">SET</span> [=] charset_name [<span class="org-keyword">COLLATE</span> [=] <span class="org-keyword">collation_name</span>]
  | <span class="org-builtin">CONVERT</span> <span class="org-keyword">TO</span> <span class="org-type">CHARACTER</span> <span class="org-keyword">SET</span> charset_name [<span class="org-keyword">COLLATE</span> <span class="org-keyword">collation_name</span>]
  | {DISABLE|ENABLE} KEYS
  | {DISCARD|IMPORT} TABLESPACE

  | <span class="org-keyword">DROP</span> [<span class="org-keyword">COLUMN</span>] col_name
  | <span class="org-keyword">DROP</span> {INDEX|<span class="org-keyword">KEY</span>} index_name
  | <span class="org-keyword">DROP</span> <span class="org-keyword">PRIMARY</span> <span class="org-keyword">KEY</span>
  | <span class="org-keyword">DROP</span> <span class="org-keyword">FOREIGN</span> <span class="org-keyword">KEY</span> fk_symbol

  | FORCE
  | LOCK [=] {<span class="org-keyword">DEFAULT</span>|<span class="org-keyword">NONE</span>|SHARED|EXCLUSIVE}
  | <span class="org-keyword">MODIFY</span> [<span class="org-keyword">COLUMN</span>] col_name column_definition
        [<span class="org-keyword">FIRST</span> | <span class="org-keyword">AFTER</span> col_name]
  | <span class="org-keyword">ORDER</span> <span class="org-keyword">BY</span> col_name [, col_name] ...
  | RENAME [<span class="org-keyword">TO</span>|<span class="org-keyword">AS</span>] new_tbl_name
  | <span class="org-keyword">ADD</span> PARTITION (partition_definition)
  | <span class="org-keyword">DROP</span> PARTITION partition_names
  | TRUNCATE PARTITION {partition_names | <span class="org-keyword">ALL</span>}
  | <span class="org-builtin">COALESCE</span> PARTITION <span class="org-keyword">number</span>
  | REORGANIZE PARTITION partition_names <span class="org-keyword">INTO</span> (partition_definitions)
  | EXCHANGE PARTITION partition_name <span class="org-keyword">WITH</span> <span class="org-keyword">TABLE</span> tbl_name
  | ANALYZE PARTITION {partition_names | <span class="org-keyword">ALL</span>}
  | <span class="org-keyword">CHECK</span> PARTITION {partition_names | <span class="org-keyword">ALL</span>}
  | OPTIMIZE PARTITION {partition_names | <span class="org-keyword">ALL</span>}
  | REBUILD PARTITION {partition_names | <span class="org-keyword">ALL</span>}
  | REPAIR PARTITION {partition_names | <span class="org-keyword">ALL</span>}
  | REMOVE PARTITIONING

key_part:
    col_name [(<span class="org-keyword">length</span>)] [<span class="org-keyword">ASC</span> | <span class="org-keyword">DESC</span>]

index_type:
    <span class="org-keyword">USING</span> {BTREE | HASH}

index_option:
    KEY_BLOCK_SIZE [=] <span class="org-keyword">value</span>
  | index_type
  | <span class="org-keyword">WITH</span> PARSER parser_name
  | COMMENT <span class="org-string">'string'</span>

table_options:
    table_option [[,] table_option] ...

table_option:
    AUTO_INCREMENT [=] <span class="org-keyword">value</span>
  | AVG_ROW_LENGTH [=] <span class="org-keyword">value</span>
  | [<span class="org-keyword">DEFAULT</span>] <span class="org-type">CHARACTER</span> <span class="org-keyword">SET</span> [=] charset_name
  | CHECKSUM [=] {0 | 1}
  | [<span class="org-keyword">DEFAULT</span>] <span class="org-keyword">COLLATE</span> [=] <span class="org-keyword">collation_name</span>
  | COMMENT [=] <span class="org-string">'string'</span>
  | <span class="org-keyword">CONNECTION</span> [=] <span class="org-string">'connect_string'</span>
  | {<span class="org-keyword">DATA</span>|INDEX} DIRECTORY [=] <span class="org-string">'absolute path to directory'</span>
  | DELAY_KEY_WRITE [=] {0 | 1}
  | ENGINE [=] engine_name
  | INSERT_METHOD [=] { <span class="org-keyword">NO</span> | <span class="org-keyword">FIRST</span> | <span class="org-keyword">LAST</span> }
  | KEY_BLOCK_SIZE [=] <span class="org-keyword">value</span>
  | MAX_ROWS [=] <span class="org-keyword">value</span>
  | MIN_ROWS [=] <span class="org-keyword">value</span>
  | PACK_KEYS [=] {0 | 1 | <span class="org-keyword">DEFAULT</span>}
  | PASSWORD [=] <span class="org-string">'string'</span>
  | ROW_FORMAT [=] {<span class="org-keyword">DEFAULT</span>|<span class="org-keyword">DYNAMIC</span>|FIXED|COMPRESSED|REDUNDANT|COMPACT}
  | STATS_AUTO_RECALC [=] {<span class="org-keyword">DEFAULT</span>|0|1}
  | STATS_PERSISTENT [=] {<span class="org-keyword">DEFAULT</span>|0|1}
  | STATS_SAMPLE_PAGES [=] <span class="org-keyword">value</span>
  | TABLESPACE tablespace_name [STORAGE {DISK|MEMORY|<span class="org-keyword">DEFAULT</span>}]
  | <span class="org-keyword">UNION</span> [=] (tbl_name[,tbl_name]...)
</pre>
</div>

<p>
基本示例:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#28155;&#21152;&#21015;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> <span class="org-keyword">add</span> <span class="org-keyword">column</span> qq <span class="org-type">varchar</span>(20);
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> <span class="org-keyword">add</span> qq <span class="org-type">varchar</span>(20); <span class="org-comment">-- &#21487;&#20197;&#21435;&#25481; column &#20851;&#38190;&#35789;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> <span class="org-keyword">add</span> tel <span class="org-type">varchar</span>(20) <span class="org-keyword">after</span> gender; <span class="org-comment">-- &#25351;&#23450;&#20301;&#32622;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> <span class="org-keyword">add</span> (xxx <span class="org-type">int</span>, yyy <span class="org-type">int</span>);

<span class="org-comment">-- &#20462;&#25913;&#21015;</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">t2</span> <span class="org-keyword">MODIFY</span> a TINYINT <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>, CHANGE b c <span class="org-type">CHAR</span>(20);


<span class="org-comment">-- &#21024;&#38500;&#20027;&#38190;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> change id id <span class="org-type">int</span>; <span class="org-comment">-- &#38656;&#35201;&#23558; auto_increment &#21435;&#25481;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> <span class="org-keyword">drop</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span>;

<span class="org-comment">-- &#22686;&#21152;&#20027;&#38190;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">person</span> <span class="org-keyword">add</span> <span class="org-keyword">primary</span> <span class="org-keyword">key</span> (id);
<span class="org-comment">-- &#22686;&#21152;/&#21024;&#38500;&#22806;&#38190;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">book</span> 
   <span class="org-keyword">add</span> <span class="org-keyword">constraint</span> fk_authorid
   <span class="org-keyword">foreign</span> <span class="org-keyword">key</span> (authorid)
   <span class="org-keyword">references</span> author (authorid);
<span class="org-comment">-- &#22686;&#21152;/&#21024;&#38500;&#32034;&#24341;</span>
<span class="org-keyword">ALTER</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">t2</span> <span class="org-keyword">ADD</span> INDEX (d), <span class="org-keyword">ADD</span> <span class="org-keyword">UNIQUE</span> (a);
<span class="org-comment">-- &#37325;&#21629;&#21517;</span>
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">rename</span> <span class="org-keyword">to</span> people;
</pre>
</div>
</div>
</section>

<section id="outline-container-orga424e4c" class="outline-2">
<h2 id="orga424e4c"><span class="section-number-2">9</span> 引擎(Engine)</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li><p>
MySQL 为了满足各种需求，提供了不同的引擎实现，比如 MyISAM/InnoDB 等。
</p>
<pre class="example">
show engines
</pre></li>
<li>可以为数据库指定默认引擎，只需要在 my.ini 配置文件中增加 <code>default-storage-engine=InnoDB</code> 就可以了</li>
<li><p>
也可以在创建表的时候，手动指定使用的引擎:
</p>
<pre class="example">
create table xxx (id int) engine=MyISAM;
</pre></li>
<li>在早期(&lt;5.0)MySQL 的默认引擎是 MyISAM，它的特点是快，它的缺点是功能简单，不支持事务包括外键等功能</li>
<li>目前(&gt;5)默认引擎是 InnoDB，它为数据库提供了事务支持、外键支持、锁的支持等特性</li>
</ul>

<p>
事务相关的语法有:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">start</span> <span class="org-keyword">transaction</span>; <span class="org-comment">-- begin;</span>
<span class="org-keyword">savepoint</span> xxx;     <span class="org-comment">-- &#23384;&#26723;</span>
<span class="org-keyword">rollback</span>;          <span class="org-comment">-- &#22238;&#28378;</span>
<span class="org-keyword">rollback</span> <span class="org-keyword">to</span> xxx;   <span class="org-comment">-- &#22238;&#26723;&#21040;&#26576;&#20010;&#20445;&#23384;&#28857;</span>
<span class="org-keyword">commit</span>;            <span class="org-comment">-- &#25552;&#20132;&#20107;&#21153;</span>


<span class="org-comment">-- &#21019;&#34920;</span>
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">xxx_inno</span> (id <span class="org-type">int</span>) engine=InnoDB;
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">xxx_isam</span> (id <span class="org-type">int</span>) engine=MyISAM;
<span class="org-comment">-- &#26597;&#30475;</span>
show <span class="org-keyword">create</span> <span class="org-keyword">table</span> xxx_inno;
show <span class="org-keyword">create</span> <span class="org-keyword">table</span> xxx_isam;



<span class="org-comment">-- &#26597;&#30475; xxx_inno &#30340;&#20107;&#21153;&#25903;&#25345;&#24773;&#20917;</span>
<span class="org-comment">-- &#39318;&#20808;&#65292;&#24320;&#21551;&#20107;&#21153;</span>
<span class="org-keyword">start</span> <span class="org-keyword">transaction</span>;
<span class="org-comment">-- &#28982;&#21518;&#65292;&#25554;&#20837;&#25968;&#25454;</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> xxx_inno <span class="org-keyword">values</span> (111);
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> xxx_inno <span class="org-keyword">values</span> (222);
<span class="org-comment">-- &#29616;&#22312;&#65292;&#22312;&#20854;&#20182;&#30340;&#36830;&#25509;&#20013;&#65292;&#26159;&#26597;&#35810;&#19981;&#21040;&#36825;&#25968;&#25454;&#30340;</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> xxx_inno;
<span class="org-comment">-- &#24314;&#31435;&#20445;&#23384;&#28857;(&#23384;&#26723;)</span>
<span class="org-keyword">savepoint</span> s1;
<span class="org-comment">-- &#20877;&#25554;&#20837;&#26356;&#22810;&#25968;&#25454;</span>
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> xxx_inno <span class="org-keyword">values</span> (333);
<span class="org-comment">-- &#29616;&#22312;&#65292;&#22312;&#24403;&#21069;&#20107;&#21153;&#20013;&#65292;&#21487;&#20197;&#26597;&#21040;3&#26465;&#25968;&#25454;</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> xxx_inno;
<span class="org-comment">-- &#20351;&#29992; rollback &#22238;&#26723;&#65292;&#23558;&#22238;&#21040;&#25554;&#20837; 333 &#21069;&#30340;&#29366;&#24577;</span>
<span class="org-keyword">rollback</span> <span class="org-keyword">to</span> s1;
<span class="org-comment">-- &#25552;&#20132;&#20107;&#21153;</span>
<span class="org-keyword">commit</span>;  
<span class="org-comment">-- &#29616;&#22312;&#65292;&#22312;&#20854;&#20182;&#30340;&#36830;&#25509;&#20013;&#65292;&#23601;&#33021;&#26597;&#35810;&#21040;&#36825;&#20123;&#25968;&#25454;&#20102;</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> xxx_inno;



<span class="org-comment">-- &#26597;&#30475; xxx_isam &#30340;&#20107;&#21153;&#25903;&#25345;&#24773;&#20917;</span>
<span class="org-keyword">start</span> <span class="org-keyword">transaction</span>;
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> xxx_isam <span class="org-keyword">values</span> (666);
<span class="org-comment">-- &#22312;&#27809;&#26377; commit &#30340;&#26102;&#20505;&#65292;&#22312;&#20854;&#20182;&#36830;&#25509;&#20013;&#31455;&#28982;&#33021;&#26597;&#35810;&#36825;&#25968;&#25454;</span>
<span class="org-comment">-- &#35828;&#26126; MyISAM &#26159;&#19981;&#25903;&#25345;&#20107;&#21153;&#30340;</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> xxx_isam;
</pre>
</div>
</div>
</section>

<section id="outline-container-org59f2415" class="outline-2">
<h2 id="org59f2415"><span class="section-number-2">10</span> 存储过程</h2>
<div class="outline-text-2" id="text-10">
<p>
[WARNNING] 存储过程不建议使用:
</p>
<ol class="org-ol">
<li>难以调试，难以维护</li>
<li>业务逻辑跟数据库耦合度过高，不便于迁移</li>
<li>对数据库的压力过大，需要分拆</li>
<li>MySQL 对存储过程的支持有些弱鸡</li>
</ol>
</div>

<div id="outline-container-orgfda20c6" class="outline-3">
<h3 id="orgfda20c6"><span class="section-number-3">10.1</span> 基本语句</h3>
<div class="outline-text-3" id="text-10-1">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#23384;&#20648;&#36807;&#31243;&#30340;&#23450;&#20041;</span>
delimiter //                   <span class="org-comment">-- &#20351;&#29992; delimiter &#25351;&#20196;&#65292;&#23558;&#40664;&#35748;&#30340;&#20998;&#38548;&#31526;(;)&#25442;&#20026;&#25105;&#20204;&#33258;&#23450;&#20041;&#30340;&#20998;&#38548;&#31526;</span>
<span class="org-keyword">create</span> <span class="org-keyword">procedure</span> <span class="org-function-name">ppx1</span> (p <span class="org-type">int</span>)  <span class="org-comment">-- &#21019;&#24314;&#23384;&#20648;&#36807;&#31243;&#65292;&#21517;&#23383; ppx1, &#19968;&#20010;&#20837;&#21442; int &#31867;&#22411;&#30340; p</span>
<span class="org-keyword">begin</span>                          <span class="org-comment">-- &#20351;&#29992; begin &#36319; end &#23558;&#25152;&#26377;&#35821;&#21477;&#21253;&#25324;&#36215;&#26469;&#65292;&#30456;&#24403;&#20110; {}</span>
    <span class="org-keyword">set</span> @x = 0;                <span class="org-comment">-- set &#26159;&#29992;&#26469;&#23450;&#20041;&#25110;&#32773;&#35774;&#32622;&#21464;&#37327;&#30340;&#20540;&#30340;&#65292;&#29992;&#25143;&#32423;&#21035;&#30340;&#21464;&#37327;&#65292;&#38656;&#35201;&#20351;&#29992; @ &#20316;&#20026;&#21069;&#32512;</span>

    repeat                     <span class="org-comment">-- repeat .. until .. end repeat &#36825;&#26159;&#20351;&#29992;&#24490;&#29615;&#30340;&#20854;&#20013;&#19968;&#31181;&#26041;&#24335;</span>
      <span class="org-keyword">set</span> @x = @x + 1;         <span class="org-comment">-- &#22312;&#24490;&#29615;&#20307;&#20013;&#65292;&#25105;&#20204;&#23601;&#21487;&#20197;&#36827;&#34892;&#25105;&#20204;&#19981;&#26029;&#37325;&#22797;&#30340;&#19994;&#21153;&#12289;&#20107;&#24773;&#20102;</span>
    until @x &gt; p <span class="org-keyword">end</span> repeat;   <span class="org-comment">-- &#20351;&#29992; until &#34920;&#31034;&#24490;&#29615;&#32467;&#26463;&#30340;&#26465;&#20214;&#12290;&#31867;&#20284;&#20110; while &#24490;&#29615;&#20013;&#30340; break</span>
<span class="org-keyword">end</span>
delimiter ;                    <span class="org-comment">-- &#36807;&#31243;&#23450;&#20041;&#23436;&#25104;&#21518;&#65292;&#38656;&#35201;&#23558;&#20998;&#38548;&#31526;&#36824;&#21407;&#20026;&#40664;&#35748;(;)</span>

<span class="org-comment">-- &#35843;&#29992;&#23384;&#20648;&#36807;&#31243;</span>
<span class="org-keyword">call</span> ppx1(100);

<span class="org-comment">-- &#26597;&#30475;&#29992;&#25143;&#23450;&#20041;&#21464;&#37327;&#30340;&#20540;</span>
<span class="org-keyword">select</span> @x;
</pre>
</div>

<p>
求和 1-n:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">procedure</span> <span class="org-function-name">sum2</span> (y <span class="org-type">int</span>)
<span class="org-keyword">begin</span>
  <span class="org-keyword">declare</span> x <span class="org-type">int</span>;  <span class="org-comment">-- &#22768;&#26126;&#23616;&#37096;&#21464;&#37327;</span>
  <span class="org-keyword">set</span> x = 0;      <span class="org-comment">-- &#20026;&#23616;&#37096;&#21464;&#37327;&#36171;&#20540;</span>
  <span class="org-keyword">set</span> @<span class="org-builtin">sum</span> = 0;
  repeat
  <span class="org-keyword">set</span> x = x + 1;
  <span class="org-keyword">set</span> @<span class="org-builtin">sum</span> = @<span class="org-builtin">sum</span> + x;
  until x &gt;= y <span class="org-keyword">end</span> repeat;
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5d138e5" class="outline-3">
<h3 id="org5d138e5"><span class="section-number-3">10.2</span> 变量定义</h3>
<div class="outline-text-3" id="text-10-2">
<p>
变量分类：
</p>
<ol class="org-ol">
<li>局部变量，使用在存储过程或函数中，这样的变量使用 declare 进行声明，使用 set 进行赋值。作用域是过程中。</li>
<li>用户变量，定义 set @xxx = 333; select @xxx := 333;  需要用 @ 符号进行修饰</li>
<li>系统变量，系统自带的，内建的变量
<ul class="org-ul">
<li>可以通过命令行的方式进行设置 mysqld &#x2013;default_storage_engine=MyISAM</li>
<li>可以在 my.ini 配置文件中进行配置 default_storage_engine=MyISAM</li>
<li>可以通过 set 的方式进行动态设置</li>
<li>系统变量，分为两类:
<ol class="org-ol">
<li><p>
全局的(global)
</p>
<div class="org-src-container">
<pre class="src src-sql">show <span class="org-keyword">global</span> variables;
<span class="org-keyword">set</span> <span class="org-keyword">global</span> default_storage_engine=MyISAM;
<span class="org-keyword">set</span> @@<span class="org-keyword">global</span>.default_storage_engine=MyISAM;
</pre>
</div></li>

<li><p>
会话的(session)
</p>
<div class="org-src-container">
<pre class="src src-sql">show <span class="org-keyword">session</span> variables;
show <span class="org-keyword">local</span> variables;
show variables;
<span class="org-keyword">set</span> <span class="org-keyword">session</span> default_storage_engine=MyISAM;
<span class="org-keyword">set</span> <span class="org-keyword">local</span>   default_storage_engine=MyISAM;
<span class="org-keyword">set</span> @@<span class="org-keyword">session</span>.default_storage_engine=MyISAM;
<span class="org-keyword">set</span> @@<span class="org-keyword">local</span>.default_storage_engine=MyISAM;
<span class="org-keyword">set</span> default_storage_engine=MyISAM;
<span class="org-keyword">set</span> @@default_storage_engine=MyISAM;
</pre>
</div></li>
</ol></li>
</ul></li>
</ol>
</div>
</div>

<div id="outline-container-org9d1d971" class="outline-3">
<h3 id="org9d1d971"><span class="section-number-3">10.3</span> 参数与游标</h3>
<div class="outline-text-3" id="text-10-3">
<p>
如果让存储过程跟外边进行数据交互，需要用到参数
</p>

<p>
第一种，在过程内部使用用户变量 @xxx
</p>
<div class="org-src-container">
<pre class="src src-sql">delimiter //
<span class="org-keyword">create</span> <span class="org-keyword">procedure</span> <span class="org-function-name">pp1</span> ()
  <span class="org-keyword">begin</span>
    <span class="org-keyword">declare</span> v1 <span class="org-type">int</span> <span class="org-keyword">default</span> 100;

    <span class="org-keyword">set</span> @aaa = v1*101;
  <span class="org-keyword">end</span> //
delimiter ;

<span class="org-comment">-- &#35843;&#29992;</span>
<span class="org-keyword">call</span> pp1();
<span class="org-keyword">select</span> @aaa;
</pre>
</div>

<p>
另外，可以将表中查询到的数据赋予参数:
</p>
<div class="org-src-container">
<pre class="src src-sql">delimiter //
<span class="org-keyword">drop</span> <span class="org-keyword">procedure</span> <span class="org-function-name">if</span> <span class="org-keyword">exists</span> pp2;
<span class="org-keyword">create</span> <span class="org-keyword">procedure</span> <span class="org-function-name">pp2</span> ()
  <span class="org-keyword">begin</span>
    <span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">into</span> @bbb <span class="org-keyword">from</span> t_person;
    <span class="org-keyword">select</span> weixin <span class="org-keyword">into</span> @ccc <span class="org-keyword">from</span> t_person <span class="org-keyword">limit</span> 1;
  <span class="org-keyword">end</span> //
delimiter ;

<span class="org-comment">-- &#35843;&#29992;</span>
<span class="org-keyword">call</span> pp2();
<span class="org-keyword">select</span> @bbb, @ccc;
</pre>
</div>

<p>
使用过程内部定义用户变量的方式，容易在调用的时候产生冲突、混淆，所以最好使用外部定义，结合 out/inout 类型参数:
</p>
<div class="org-src-container">
<pre class="src src-sql">delimiter //
<span class="org-keyword">drop</span> <span class="org-keyword">procedure</span> <span class="org-function-name">if</span> <span class="org-keyword">exists</span> pp3;
<span class="org-keyword">create</span> <span class="org-keyword">procedure</span> <span class="org-function-name">pp3</span> (<span class="org-keyword">inout</span> bbb <span class="org-type">varchar</span>(30), <span class="org-keyword">inout</span> ccc <span class="org-type">varchar</span>(20)) <span class="org-comment">-- in out in out</span>
  <span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> t_person (<span class="org-keyword">name</span>, weixin) <span class="org-keyword">value</span> (bbb, ccc);

    <span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">into</span> bbb <span class="org-keyword">from</span> t_person;
    <span class="org-keyword">select</span> weixin <span class="org-keyword">into</span> ccc <span class="org-keyword">from</span> t_person <span class="org-keyword">limit</span> 1;
  <span class="org-keyword">end</span> //
delimiter ;

<span class="org-comment">-- &#35843;&#29992;</span>
<span class="org-keyword">set</span> @ddd = <span class="org-string">'3333'</span>;
<span class="org-keyword">set</span> @eee = <span class="org-string">'sdfsfsd'</span>;
<span class="org-keyword">call</span> pp3(@ddd, @eee);
<span class="org-keyword">select</span> @ddd, @eee;
</pre>
</div>

<p>
如果需要处理表中的多行数据，就需要用到游标(Cursor):
</p>
<div class="org-src-container">
<pre class="src src-sql">delimiter //
<span class="org-keyword">drop</span> <span class="org-keyword">procedure</span> <span class="org-function-name">if</span> <span class="org-keyword">exists</span> pp4;
<span class="org-keyword">create</span> <span class="org-keyword">procedure</span> <span class="org-function-name">pp4</span> (<span class="org-keyword">out</span> <span class="org-builtin">sum</span> bigint)
  <span class="org-keyword">begin</span>
    <span class="org-keyword">declare</span> iii <span class="org-type">int</span>;
    <span class="org-keyword">declare</span> done <span class="org-type">int</span> <span class="org-keyword">default</span> 0;

    <span class="org-keyword">declare</span> c_person <span class="org-keyword">cursor</span> <span class="org-keyword">for</span> <span class="org-keyword">select</span> weixin <span class="org-keyword">from</span> t_person; <span class="org-comment">-- 1. &#28216;&#26631;&#30340;&#23450;&#20041;</span>
    <span class="org-keyword">declare</span> <span class="org-keyword">continue</span> handler <span class="org-keyword">for</span> <span class="org-keyword">not</span> <span class="org-keyword">found</span> <span class="org-keyword">set</span> done = 1;     <span class="org-comment">-- &#25429;&#33719;&#31995;&#32479;&#25243;&#20986;&#30340; not found &#38169;&#35823;&#65292;&#22914;&#26524;&#25429;&#33719;&#21040;&#65292;&#23558; done &#35774;&#32622;&#20026; 1</span>

    <span class="org-keyword">set</span> <span class="org-builtin">sum</span> = 0;
    <span class="org-keyword">open</span> c_person; <span class="org-comment">-- 2. &#25171;&#24320;&#28216;&#26631;</span>

    xxx:loop
      <span class="org-keyword">fetch</span> c_person <span class="org-keyword">into</span> iii; <span class="org-comment">-- 3. &#20351;&#29992;&#28216;&#26631;</span>
      if done = 1 <span class="org-keyword">then</span>   <span class="org-comment">-- 4. &#35774;&#23450;&#36864;&#20986;&#26465;&#20214;</span>
        leave xxx;
      <span class="org-keyword">end</span> if;
      <span class="org-keyword">set</span> <span class="org-builtin">sum</span> = <span class="org-builtin">sum</span> + iii;
    <span class="org-keyword">end</span> loop;

    <span class="org-keyword">close</span> c_person; <span class="org-comment">-- 5. &#20851;&#38381;&#28216;&#26631;</span>
  <span class="org-keyword">end</span> //
delimiter ;

<span class="org-comment">-- &#35843;&#29992;</span>
<span class="org-keyword">set</span> @<span class="org-builtin">sum</span> = 0;
<span class="org-keyword">call</span> pp4(@<span class="org-builtin">sum</span>);
<span class="org-keyword">select</span> @<span class="org-builtin">sum</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org3a11138" class="outline-3">
<h3 id="org3a11138"><span class="section-number-3">10.4</span> JDBC 操作存储过程示例</h3>
<div class="outline-text-3" id="text-10-4">
<p>
存储过程示例:
</p>
<div class="org-src-container">
<pre class="src src-sql">delimiter //
<span class="org-keyword">drop</span> <span class="org-keyword">procedure</span> <span class="org-function-name">if</span> <span class="org-keyword">exists</span> pp6;
<span class="org-keyword">create</span> <span class="org-keyword">procedure</span> <span class="org-function-name">pp6</span> (<span class="org-keyword">inout</span> bbb <span class="org-type">varchar</span>(30), <span class="org-keyword">inout</span> ccc <span class="org-type">varchar</span>(20)) <span class="org-comment">-- in out in out</span>
  <span class="org-keyword">begin</span>
    <span class="org-keyword">insert</span> <span class="org-keyword">into</span> t_person (<span class="org-keyword">name</span>, weixin) <span class="org-keyword">value</span> (bbb, ccc);

    <span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">into</span> bbb <span class="org-keyword">from</span> t_person;
    <span class="org-keyword">select</span> weixin <span class="org-keyword">into</span> ccc <span class="org-keyword">from</span> t_person <span class="org-keyword">limit</span> 1;

    <span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_city <span class="org-keyword">where</span> province=<span class="org-string">'&#24191;&#19996;&#30465;'</span>;
    <span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_pos <span class="org-keyword">order</span> <span class="org-keyword">by</span> salary_min <span class="org-keyword">desc</span> <span class="org-keyword">limit</span> 10;
  <span class="org-keyword">end</span> //
delimiter ;
</pre>
</div>

<p>
JDBC代码:
</p>
<div class="org-src-container">
<pre class="src src-java"> <span class="org-comment-delimiter">// </span><span class="org-comment">Statement PrepareStatement CallableStatement</span>

 <span class="org-keyword">public</span> <span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">main</span>(<span class="org-type">String</span>[] <span class="org-variable-name">args</span>) {
    <span class="org-type">Connection</span> <span class="org-variable-name">connection</span> = <span class="org-constant">null</span>;
    <span class="org-type">CallableStatement</span> <span class="org-variable-name">ps</span> = <span class="org-constant">null</span>;
    <span class="org-type">ResultSet</span> <span class="org-variable-name">rs</span> = <span class="org-constant">null</span>;


    <span class="org-keyword">try</span> {
        connection = DBUtil.getMySQLConnection();
        ps = connection.prepareCall(<span class="org-string">"call pp6(?, ?)"</span>);
        ps.setString(1, <span class="org-string">"dfasd"</span>);
        ps.setString(2, <span class="org-string">"16463"</span>);

        ps.registerOutParameter(1, <span class="org-constant">Types</span>.VARCHAR);
        ps.registerOutParameter(2, <span class="org-constant">Types</span>.VARCHAR);

        <span class="org-type">boolean</span> <span class="org-variable-name">hasMore</span> = ps.execute();

        <span class="org-keyword">while</span> (hasMore) {
            rs = ps.getResultSet();
            <span class="org-keyword">while</span> (rs.next()) {
                System.out.println(rs.getObject(1) + <span class="org-string">"/"</span> + rs.getObject(2));
            }
            rs.close();

            hasMore = ps.getMoreResults();
        }

        System.out.println(ps.getObject(1));
        System.out.println(ps.getObject(2));
    } <span class="org-keyword">catch</span> (<span class="org-type">Exception</span> <span class="org-variable-name">e</span>) {
        e.printStackTrace();
    } <span class="org-keyword">finally</span> {
        DBUtil.tryRelease(connection, ps, rs);
    }
}
</pre>
</div>
</div>
</div>
</section>

<section id="outline-container-org71fa317" class="outline-2">
<h2 id="org71fa317"><span class="section-number-2">11</span> 优化(Optimization)</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-orgad93eb2" class="outline-3">
<h3 id="orgad93eb2"><span class="section-number-3">11.1</span> 解释计划(Explain)</h3>
<div class="outline-text-3" id="text-11-1">
<p>
可以查看数据内部是怎么分析执行相关语句的，根据这些可以对语句进行优化
</p>

<div class="org-src-container">
<pre class="src src-sql">explain <span class="org-keyword">select</span> c.city <span class="org-keyword">as</span> city2, p.* <span class="org-keyword">from</span> lagou_pos p
        <span class="org-keyword">join</span> lagou_city c <span class="org-keyword">on</span> p.city = c.cid
        <span class="org-keyword">where</span> c.province = <span class="org-string">'&#24191;&#19996;&#30465;'</span>
    <span class="org-keyword">order</span> <span class="org-keyword">by</span> salary_min <span class="org-keyword">desc</span> <span class="org-keyword">limit</span> 10;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc3435f8" class="outline-3">
<h3 id="orgc3435f8"><span class="section-number-3">11.2</span> 索引</h3>
<div class="outline-text-3" id="text-11-2">
<p>
索引是跟引擎相关的，索引的主要分类有:
</p>
<ul class="org-ul">
<li>B-Tree 索引，这是默认的索引形式，是最普遍的方式</li>
<li>R-Tree 索引，主要用于空间数据库字段上</li>
<li>Hash 索引，只用在 Memory 引擎上，使用场景比较简单</li>
</ul>

<p>
MySQL 不支持函数索引，但是可以支持前缀索引:
</p>

<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#21019;&#24314;</span>

<span class="org-keyword">create</span> index idx_pos_city_01 <span class="org-keyword">on</span> lagou_pos(city);  <span class="org-comment">-- &#26222;&#36890;&#32034;&#24341;</span>
<span class="org-keyword">create</span> <span class="org-keyword">unique</span> index skdfjks <span class="org-keyword">on</span> lagou_pos(pid);    <span class="org-comment">-- &#21807;&#19968;&#32034;&#24341;</span>

<span class="org-keyword">create</span> index idex_city_p01 <span class="org-keyword">on</span> lagou_city (province(2));     <span class="org-comment">-- &#21069;&#32512;&#32034;&#24341;</span>
<span class="org-keyword">create</span> index idex_city_p01 <span class="org-keyword">on</span> lagou_city (province, city);  <span class="org-comment">-- &#32452;&#21512;&#32034;&#24341;</span>

<span class="org-comment">-- &#32034;&#24341;&#30340;&#21019;&#24314;&#21407;&#21017;:</span>
<span class="org-comment">-- 1. &#39057;&#32321;&#35835;&#21462;&#30340;&#23383;&#27573;&#65292;&#36866;&#21512;&#21019;&#24314;</span>
<span class="org-comment">-- 2. &#26356;&#26032;&#39057;&#32321;&#30340;&#23383;&#27573;&#65292;&#19981;&#36866;&#21512;</span>
<span class="org-comment">-- 3. &#25968;&#25454;&#24046;&#24322;&#24615;&#22823;&#30340;&#23383;&#27573;&#25165;&#36866;&#21512;&#65292;&#27604;&#22914;&#24615;&#21035;&#23601;&#19981;&#36866;&#21512;</span>
<span class="org-comment">-- 4. &#32034;&#24341;&#35201;&#36866;&#24403;&#65292;&#22240;&#20026;&#32034;&#24341;&#20250;&#21344;&#29992;&#26356;&#22810;&#31354;&#38388;&#65292;&#24182;&#35753;&#26597;&#35810;&#30340;&#36807;&#31243;&#21464;&#24471;&#22797;&#26434;&#12290;&#22914;&#26524;&#19981;&#24688;&#24403;&#20351;&#29992;&#65292;&#38750;&#20294;&#19981;&#33021;&#22686;&#21152;&#25928;&#29575;&#65292;&#21453;&#32780;&#20250;&#25302;&#32047;&#25928;&#29575;</span>

<span class="org-comment">-- &#21024;&#38500;</span>

<span class="org-keyword">drop</span> index idx_pos_city_01 <span class="org-keyword">on</span> lagou_pos;
<span class="org-keyword">alter</span> <span class="org-keyword">table</span> <span class="org-function-name">lagou_pos</span> <span class="org-keyword">drop</span> index  idx_pos_city_01;

<span class="org-comment">-- &#26597;&#30475;&#34920;&#19978;&#30340;&#25152;&#26377;&#32034;&#24341;</span>
show index <span class="org-keyword">from</span> lagou_pos;
</pre>
</div>
</div>
</div>
</section>

<section id="outline-container-org793bb8a" class="outline-2">
<h2 id="org793bb8a"><span class="section-number-2">12</span> UseCases</h2>
<div class="outline-text-2" id="text-12">
</div>
<div id="outline-container-orga3f969b" class="outline-3">
<h3 id="orga3f969b"><span class="section-number-3">12.1</span> 使用存储过程批量插入数据</h3>
<div class="outline-text-3" id="text-12-1">
<blockquote>
<p>

</p>

<p>
创建表，使用存储过程插入 10w 条数据
</p>
</blockquote>

<p>
首先，创建表，比如:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">t_person</span> (
  pid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
  <span class="org-keyword">name</span> <span class="org-type">varchar</span>(20) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
  weixin <span class="org-type">varchar</span>(20) <span class="org-keyword">not</span> <span class="org-keyword">null</span>
);
</pre>
</div>

<p>
其次，编写函数，求取随机字符串。将求取随机字符串的方法提取出来的目的是为了复用，这也是函数的目的:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">function</span> <span class="org-function-name">if</span> <span class="org-keyword">exists</span> rand_str;
delimiter $$
<span class="org-keyword">create</span> <span class="org-keyword">function</span> <span class="org-function-name">rand_str</span>(<span class="org-keyword">size</span> <span class="org-type">int</span>, <span class="org-keyword">type</span> <span class="org-type">int</span>)
  <span class="org-keyword">returns</span> <span class="org-type">varchar</span>(255)
  <span class="org-keyword">begin</span>
    <span class="org-keyword">declare</span> seed <span class="org-type">varchar</span>(255);
    <span class="org-keyword">declare</span> seed_no <span class="org-type">varchar</span>(255) <span class="org-keyword">default</span> <span class="org-string">'1234567890'</span>;
    <span class="org-keyword">declare</span> seed_en <span class="org-type">varchar</span>(255) <span class="org-keyword">default</span> <span class="org-string">'qwertryuiopasdfghjklzxcvbnm'</span>;

    <span class="org-keyword">declare</span> ret <span class="org-type">varchar</span>(255) <span class="org-keyword">default</span> <span class="org-string">''</span>;
    <span class="org-keyword">declare</span> i <span class="org-type">int</span> <span class="org-keyword">default</span> 0;

    <span class="org-keyword">set</span> seed = <span class="org-keyword">case</span> <span class="org-keyword">type</span>    <span class="org-comment">-- if .. else / case when</span>
               <span class="org-keyword">when</span> 1 <span class="org-keyword">then</span> seed_en
               <span class="org-keyword">when</span> 2 <span class="org-keyword">then</span> seed_no
               <span class="org-keyword">else</span> concat(seed_en, seed_no) <span class="org-keyword">end</span>;

    while i &lt; <span class="org-keyword">size</span> do
      <span class="org-keyword">set</span> ret = concat(ret, <span class="org-builtin">substring</span>(seed, floor(<span class="org-keyword">length</span>(seed) * rand() + 1), 1));
      <span class="org-keyword">set</span> i = i + 1;
    <span class="org-keyword">end</span> while;

    <span class="org-keyword">return</span> ret;
  <span class="org-keyword">end</span>$$
delimiter ;

<span class="org-comment">-- &#35843;&#29992;</span>
<span class="org-keyword">select</span> rand_str(5, 1);

<span class="org-comment">-- &#26681;&#25454;&#19978;&#36848;&#20989;&#25968;&#65292;&#27714;&#21462; 5 &#21040; 12 &#20301;&#38271;&#24230;&#30340;&#19968;&#20010;&#38543;&#26426;&#23383;&#31526;&#20018;</span>

<span class="org-comment">-- &#24605;&#36335;&#19968;</span>
<span class="org-comment">-- &#31532;&#19968;&#27493;&#65292;&#27714;&#21462; 0-9 &#20043;&#38388;&#30340;&#19968;&#20010;&#38543;&#26426;&#25968;&#23383;</span>
<span class="org-keyword">select</span> rand_str(1, 2);
<span class="org-comment">-- &#31532;&#20108;&#27493;&#65292;&#23558;&#36825;&#20010;&#38543;&#26426;&#25968;&#23383;&#21152;&#19978; 5 &#65292;&#24471;&#21040;&#30340;&#32467;&#26524;&#23601;&#26159; 5 &#21040; 14 &#20043;&#38388;&#30340;&#19968;&#20010;&#38543;&#26426;&#25968;&#23383;</span>
<span class="org-keyword">select</span> rand_str(1, 2) + 5;
<span class="org-comment">-- &#31532;&#19977;&#27493;&#65292;&#27714;&#21462; 5 &#21040; 14 &#20301;&#38271;&#24230;&#30340;&#19968;&#20010;&#38543;&#26426;&#25968;&#23383;</span>
<span class="org-keyword">select</span> rand_str(rand_str(1, 2) + 5, 1);
<span class="org-comment">-- &#31532;&#22235;&#27493;&#65292;&#23558;&#19978;&#36848;&#23383;&#31526;&#20018;&#65292;&#36229;&#36807;&#38271;&#24230;&#30340;&#37096;&#20998;&#65292;&#25130;&#21462;&#25481;&#65292;&#35753;&#20854;&#26368;&#38271;&#30340;&#38271;&#24230;&#26159; 12&#12290;&#20219;&#21153;&#23436;&#25104;</span>
<span class="org-keyword">select</span> <span class="org-keyword">left</span>(rand_str(rand_str(1, 2) + 5, 1), 12);

<span class="org-comment">-- &#24605;&#36335;&#20108;</span>
<span class="org-comment">-- &#31532;&#19968;&#27493;&#65292;&#24471;&#21040;&#19968;&#20010;&#38543;&#26426;&#23383;&#31526;&#20018;&#65292;&#38271;&#24230;&#20026; 5</span>
<span class="org-keyword">select</span> rand_str(5, 1);
<span class="org-comment">-- &#31532;&#20108;&#27493;&#65292;&#24471;&#21040;&#19968;&#20010;&#38543;&#26426;&#23383;&#31526;&#20018;&#65292;&#38271;&#24230;&#20026; 0 &#21040; 9 &#20043;&#38388;</span>
<span class="org-keyword">select</span> rand_str(rand_str(1, 2), 1);
<span class="org-comment">-- &#31532;&#19977;&#27493;&#65292;&#23558;&#20004;&#20010;&#23383;&#31526;&#20018;&#25340;&#25509;&#65292;&#37027;&#20040;&#38271;&#24230;&#26159; 5 &#21040; 14 &#20043;&#38388;</span>
<span class="org-keyword">select</span> concat(rand_str(5, 1), rand_str(rand_str(1, 2), 1));
<span class="org-comment">-- &#26368;&#21518;&#19968;&#27493;&#65292;&#25130;&#26029;</span>
<span class="org-keyword">select</span> <span class="org-keyword">left</span>(concat(rand_str(5, 1), rand_str(rand_str(1, 2), 1)), 12);

<span class="org-comment">-- &#24605;&#36335;&#19977;</span>
<span class="org-keyword">select</span> concat(rand_str(5, 1), <span class="org-keyword">left</span>(rand_str(rand_str(1, 2), 1), 7));

<span class="org-comment">-- TODO &#39064;&#30446;</span>
<span class="org-comment">-- &#23553;&#35013;&#19968;&#20010;&#20989;&#25968; rand_str2(m, n)</span>
<span class="org-comment">-- &#20256;&#20837;&#20004;&#20010;&#25968;&#23383;&#65292;&#36820;&#22238;&#19968;&#20010; m~n &#38271;&#24230;&#30340;&#38543;&#26426;&#23383;&#31526;&#20018;</span>
<span class="org-comment">-- &#22312;&#23454;&#29616;&#20013;&#65292;&#23613;&#37327;&#20351;&#29992;&#21018;&#25165;&#23553;&#35013;&#22909;&#30340; rand_str &#20989;&#25968;</span>
</pre>
</div>

<p>
然后，编写存储过程，实现数据的插入:
</p>
<div class="org-src-container">
<pre class="src src-sql">delimiter //
<span class="org-keyword">drop</span> <span class="org-keyword">procedure</span> <span class="org-function-name">if</span> <span class="org-keyword">exists</span> proc_person_data;
<span class="org-keyword">create</span> <span class="org-keyword">procedure</span> <span class="org-function-name">proc_person_data</span> (num <span class="org-type">int</span>)
  <span class="org-keyword">begin</span>
    <span class="org-keyword">declare</span> ii <span class="org-type">int</span> <span class="org-keyword">default</span> 0;

    <span class="org-comment">-- while .. end while</span>
    <span class="org-comment">-- repeat .. until .. end repeat</span>
    <span class="org-comment">-- loop_label:loop ... leave loop_label .. end loop;</span>

    <span class="org-keyword">set</span> autocommit = 0;

    while ii &lt; num do
      <span class="org-keyword">insert</span> <span class="org-keyword">into</span> t_person (<span class="org-keyword">name</span>, weixin) <span class="org-keyword">values</span> (concat(<span class="org-string">'user_'</span>, rand_str(6, 1)), rand_str(8, 2));
      <span class="org-keyword">set</span> ii = ii + 1;

      if ii % 100000 = 1 <span class="org-keyword">then</span> <span class="org-keyword">commit</span> ; <span class="org-keyword">end</span> if;
    <span class="org-keyword">end</span> while;

    <span class="org-keyword">commit</span> ;
    <span class="org-keyword">set</span> autocommit = 1;
  <span class="org-keyword">end</span>;
//
</pre>
</div>
</div>
</div>

<div id="outline-container-org27d57b7" class="outline-3">
<h3 id="org27d57b7"><span class="section-number-3">12.2</span> 行列转换</h3>
<div class="outline-text-3" id="text-12-2">
<p>
表中的数据是这样的:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> `t_score` <span class="org-keyword">VALUES</span>
    (<span class="org-string">'&#29579;&#28023;'</span>, <span class="org-string">'&#35821;&#25991;'</span>, <span class="org-string">'86'</span>),
    (<span class="org-string">'&#29579;&#28023;'</span>, <span class="org-string">'&#25968;&#23398;'</span>, <span class="org-string">'83'</span>),
    (<span class="org-string">'&#29579;&#28023;'</span>, <span class="org-string">'&#33521;&#35821;'</span>, <span class="org-string">'93'</span>),
    (<span class="org-string">'&#38518;&#20426;'</span>, <span class="org-string">'&#35821;&#25991;'</span>, <span class="org-string">'88'</span>),
    (<span class="org-string">'&#38518;&#20426;'</span>, <span class="org-string">'&#25968;&#23398;'</span>, <span class="org-string">'84'</span>),
    (<span class="org-string">'&#38518;&#20426;'</span>, <span class="org-string">'&#33521;&#35821;'</span>, <span class="org-string">'94'</span>),
    (<span class="org-string">'&#21016;&#21487;'</span>, <span class="org-string">'&#35821;&#25991;'</span>, <span class="org-string">'80'</span>),
    (<span class="org-string">'&#21016;&#21487;'</span>, <span class="org-string">'&#25968;&#23398;'</span>, <span class="org-string">'86'</span>),
    (<span class="org-string">'&#21016;&#21487;'</span>, <span class="org-string">'&#33521;&#35821;'</span>, <span class="org-string">'88'</span>),
    (<span class="org-string">'&#26446;&#26149;'</span>, <span class="org-string">'&#35821;&#25991;'</span>, <span class="org-string">'89'</span>),
    (<span class="org-string">'&#26446;&#26149;'</span>, <span class="org-string">'&#25968;&#23398;'</span>, <span class="org-string">'80'</span>),
    (<span class="org-string">'&#26446;&#26149;'</span>, <span class="org-string">'&#33521;&#35821;'</span>, <span class="org-string">'87'</span>);
</pre>
</div>

<p>
要求查询的结果是这样:
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Name</th>
<th scope="col" class="org-right">Chinese</th>
<th scope="col" class="org-right">Math</th>
<th scope="col" class="org-right">English</th>
<th scope="col" class="org-right">score</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">刘可</td>
<td class="org-right">80</td>
<td class="org-right">86</td>
<td class="org-right">88</td>
<td class="org-right">254</td>
</tr>

<tr>
<td class="org-left">李春</td>
<td class="org-right">89</td>
<td class="org-right">80</td>
<td class="org-right">87</td>
<td class="org-right">256</td>
</tr>

<tr>
<td class="org-left">王海</td>
<td class="org-right">86</td>
<td class="org-right">83</td>
<td class="org-right">93</td>
<td class="org-right">262</td>
</tr>

<tr>
<td class="org-left">陶俊</td>
<td class="org-right">88</td>
<td class="org-right">84</td>
<td class="org-right">94</td>
<td class="org-right">266</td>
</tr>

<tr>
<td class="org-left">TOTAL</td>
<td class="org-right">343</td>
<td class="org-right">333</td>
<td class="org-right">362</td>
<td class="org-right">1038</td>
</tr>
</tbody>
</table>

<p>
方法不拘，但是要思考，要实现。
</p>

<p>
实现方法:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- 1</span>
<span class="org-keyword">select</span> <span class="org-keyword">name</span>,
       <span class="org-builtin">max</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#25968;&#23398;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>) Math,
       <span class="org-builtin">max</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#35821;&#25991;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>) Chinese,
       <span class="org-builtin">max</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#33521;&#35821;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>) English,
       <span class="org-builtin">sum</span>(score) score
<span class="org-keyword">from</span> t_score <span class="org-keyword">group</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span>
<span class="org-keyword">union</span> <span class="org-keyword">all</span>
<span class="org-keyword">select</span> <span class="org-string">'TOTAL'</span>,
       <span class="org-builtin">sum</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#25968;&#23398;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>),
       <span class="org-builtin">sum</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#35821;&#25991;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>),
       <span class="org-builtin">sum</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#33521;&#35821;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>),
       <span class="org-builtin">sum</span>(score)
<span class="org-keyword">from</span> t_score;

<span class="org-comment">-- 2</span>
<span class="org-keyword">select</span>
       IFNULL(<span class="org-keyword">NAME</span>,<span class="org-string">'TOTAL'</span>) <span class="org-keyword">name</span>, <span class="org-comment">-- name or 'TOTAL'</span>
       <span class="org-builtin">SUM</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#25968;&#23398;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>) Math,
       <span class="org-builtin">SUM</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#35821;&#25991;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>) Chinese,
       <span class="org-builtin">SUM</span>(<span class="org-keyword">case</span> subject <span class="org-keyword">when</span> <span class="org-string">'&#33521;&#35821;'</span> <span class="org-keyword">then</span> score <span class="org-keyword">else</span> 0 <span class="org-keyword">end</span>) English,
       <span class="org-builtin">sum</span>(score) score
<span class="org-keyword">from</span> t_score <span class="org-keyword">group</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span> <span class="org-keyword">WITH</span> <span class="org-keyword">ROLLUP</span>;

<span class="org-comment">-- 3</span>
<span class="org-keyword">select</span>
       IFNULL(<span class="org-keyword">NAME</span>,<span class="org-string">'TOTAL'</span>) <span class="org-keyword">name</span>, <span class="org-comment">-- name or 'TOTAL'</span>
       <span class="org-builtin">SUM</span>(if (subject = <span class="org-string">'&#25968;&#23398;'</span>,score, 0) ) Math,
       <span class="org-builtin">SUM</span>(if (subject = <span class="org-string">'&#35821;&#25991;'</span>,score, 0) ) Chinese,
       <span class="org-builtin">SUM</span>(if (subject = <span class="org-string">'&#33521;&#35821;'</span>,score, 0) ) English,
       <span class="org-builtin">sum</span>(score) score
<span class="org-keyword">from</span> t_score <span class="org-keyword">group</span> <span class="org-keyword">by</span> <span class="org-keyword">name</span> <span class="org-keyword">WITH</span> <span class="org-keyword">ROLLUP</span>;
</pre>
</div>
</div>
</div>
</section>

<section id="outline-container-orged0fb4d" class="outline-2">
<h2 id="orged0fb4d"><span class="section-number-2">13</span> 备份与恢复</h2>
<div class="outline-text-2" id="text-13">
<p>
各种灾难防不胜防:
</p>
<ul class="org-ul">
<li>操作系统崩溃</li>
<li>突然的断电</li>
<li>文件系统损坏</li>
<li>硬盘故障</li>
</ul>

<p>
所以需要多种不同的数据备份策略:
</p>
<ul class="org-ul">
<li>热备份、冷备份</li>
<li>全量备份、增量备份</li>
<li>多机备份，灾后重建</li>
</ul>

<p>
不仅为了灾难，数据的迁移，也需要掌握相关的备份、恢复技巧。
</p>

<p>
在 MySQL 中:
</p>
<ul class="org-ul">
<li>不同引擎的备份机制是不一样的</li>
<li>最常用的备份方式是 mysqldump 命令</li>
</ul>

<p>
基本的导入、导出:
</p>
<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">&#25968;&#25454;&#24211;&#22791;&#20221;</span>
mysqldump -uroot -proot &gt; ~/xxx.sql  <span class="org-comment-delimiter"># </span><span class="org-comment">&gt; &#21644; &lt; &#26159;&#31649;&#36947;&#35821;&#21477;</span>
mysqldump --all-databases --master-data --single-transaction &gt; ~/xxx.sql
mysqldump -uroot -proot --databases lagou test &gt; ~/lagou.sql

<span class="org-comment-delimiter"># </span><span class="org-comment">&#25968;&#25454;&#24211;&#24674;&#22797;</span>
mysql -uroot -proot &lt; ~/xxx.sql
mysql&gt; source ~/xxx.sql
</pre>
</div>

<p>
在 InnoDB 引擎下，为了提高 source 导入效率，需要：
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">set</span> <span class="org-keyword">names</span> utf8;       <span class="org-comment">-- &#38656;&#35201;&#27491;&#30830;&#30340;&#23458;&#25143;&#31471;&#32534;&#30721;</span>

<span class="org-keyword">SET</span> autocommit=0;     <span class="org-comment">-- &#23558;&#33258;&#21160;&#25552;&#20132;&#20851;&#38381;&#65292;&#36991;&#20813;&#27599;&#19968;&#26465;&#35821;&#21477;&#37117;&#20250;&#20986;&#21457;&#26085;&#24535;&#20889;&#20837;&#25805;&#20316;</span>
<span class="org-keyword">SET</span> unique_checks=0;  <span class="org-comment">-- &#23558;&#21807;&#19968;&#32422;&#26463;&#26816;&#26597;&#20851;&#38381;</span>
<span class="org-keyword">SET</span> foreign_key_checks=0; <span class="org-comment">-- &#23558;&#22806;&#38190;&#32422;&#26463;&#26816;&#26597;&#20851;&#38381;</span>


... <span class="org-keyword">SQL</span> import statements ...
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> yourtable <span class="org-keyword">VALUES</span> (1,2), (5,5), ...; <span class="org-comment">-- &#23613;&#37327;&#20351;&#29992;&#36825;&#31181;&#26041;&#24335;&#30340;&#23548;&#20837;&#35821;&#21477;</span>


<span class="org-keyword">COMMIT</span>;             <span class="org-comment">-- &#25552;&#20132;&#20107;&#21153;</span>

<span class="org-comment">-- &#24674;&#22797;&#35774;&#32622;</span>
<span class="org-keyword">set</span> autocommit=1;
<span class="org-keyword">SET</span> unique_checks=1;
<span class="org-keyword">SET</span> foreign_key_checks=1;
</pre>
</div>

<p>
<a href="https://dev.mysql.com/doc/refman/5.6/en/optimizing-innodb-bulk-data-loading.html">https://dev.mysql.com/doc/refman/5.6/en/optimizing-innodb-bulk-data-loading.html</a>
</p>
</div>
</section>

<section id="outline-container-orgd0d5d8a" class="outline-2">
<h2 id="orgd0d5d8a"><span class="section-number-2">14</span> 数据迁移示例</h2>
<div class="outline-text-2" id="text-14">
<p>
将 sqlite3 格式的 lagou.db 中的数据迁移到 MySQL 中
</p>
</div>

<div id="outline-container-org25b1e33" class="outline-3">
<h3 id="org25b1e33"><span class="section-number-3">14.1</span> 命令行的方式</h3>
<div class="outline-text-3" id="text-14-1">
<p>
首先，从 sqlite 中导出:
</p>
<div class="org-src-container">
<pre class="src src-sh">sqlite3 lagou.db

&gt; .output d:/data/lagou.sql
&gt; .dump
</pre>
</div>

<p>
然后，修改 lagou.sql 文件，让其兼容 MySQL 数据库。
</p>

<p>
之后就可以连接 MySQL 进行导入了:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">if</span> <span class="org-keyword">exists</span> lagou_position;

<span class="org-keyword">set</span> <span class="org-keyword">names</span> utf8;
<span class="org-keyword">set</span> autocommit=0;
<span class="org-keyword">source</span> d:/<span class="org-keyword">data</span>/lagou.<span class="org-keyword">sql</span>
<span class="org-keyword">commit</span>;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> lagou_position;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd450739" class="outline-3">
<h3 id="orgd450739"><span class="section-number-3">14.2</span> JDBC 的方式</h3>
<div class="outline-text-3" id="text-14-2">
<p>
需要注意的问题:
</p>
<ul class="org-ul">
<li>如何使用 jdbc 同时连接操作两个数据库</li>
<li>如何在 jdbc 中合理释放资源</li>
<li>异常的捕获与抛出，如何正确处理异常逻辑</li>
<li>jdbc 中批量导入数据的方式</li>
<li>MySQL 驱动中的 <code>rewriteBatchedStatements</code> 参数</li>
<li>代码的格式与规范问题</li>
</ul>

<p>
代码示例:
</p>
<div class="org-src-container">
<pre class="src src-java"><span class="org-keyword">import</span> <span class="org-constant">java</span>.<span class="org-constant">sql</span>.*;

<span class="org-keyword">public</span> <span class="org-keyword">class</span> <span class="org-type">DataMigrateFromSQLiteToMySQL</span> {

    <span class="org-comment-delimiter">// </span><span class="org-comment">create table lagou_p1 as select * from lagou_position limit 0;</span>

    <span class="org-keyword">public</span> <span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">main</span>(<span class="org-type">String</span>[] <span class="org-variable-name">args</span>) {
        <span class="org-type">DataMigrateFromSQLiteToMySQL</span> <span class="org-variable-name">migrate</span> = <span class="org-keyword">new</span> <span class="org-type">DataMigrateFromSQLiteToMySQL</span>();
        migrate.doMigrate();
    }

    <span class="org-keyword">public</span> <span class="org-type">void</span> <span class="org-function-name">doMigrate</span>() {
        <span class="org-comment-delimiter">// </span><span class="org-comment">&#25968;&#25454;&#20174;&#21738;&#37324;&#26469;&#65311;</span>
        <span class="org-type">Connection</span> <span class="org-variable-name">liteConn</span> = <span class="org-constant">null</span>;
        <span class="org-type">Statement</span> <span class="org-variable-name">liteSt</span> = <span class="org-constant">null</span>;
        <span class="org-type">ResultSet</span> <span class="org-variable-name">liteRs</span> = <span class="org-constant">null</span>;

        <span class="org-comment-delimiter">// </span><span class="org-comment">&#25968;&#25454;&#21040;&#21738;&#37324;&#21435;&#65311;</span>
        <span class="org-type">Connection</span> <span class="org-variable-name">mysqlConn</span> = <span class="org-constant">null</span>;
        <span class="org-type">PreparedStatement</span> <span class="org-variable-name">mysqlPs</span> = <span class="org-constant">null</span>;

        <span class="org-keyword">try</span> {
            <span class="org-comment-delimiter">// </span><span class="org-comment">&#25968;&#25454;&#20174;&#36825;&#37324;&#26469;</span>
            liteConn = <span class="org-keyword">this</span>.getSQLiteConnection();
            liteSt = liteConn.createStatement();
            liteRs = liteSt.executeQuery(<span class="org-string">"select * from lagou_position"</span>);

            <span class="org-comment-delimiter">// </span><span class="org-comment">&#25968;&#25454;&#21040;&#36825;&#37324;&#21435;</span>
            mysqlConn = <span class="org-keyword">this</span>.getMySQLConnection();
            mysqlPs = mysqlConn.prepareStatement(<span class="org-string">"insert into lagou_p1 values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)"</span>);

            <span class="org-comment-delimiter">// </span><span class="org-comment">&#20851;&#38381;&#33258;&#21160;&#25552;&#20132;&#65292;&#20063;&#23601;&#26159;&#24320;&#21551;&#20107;&#21153;</span>
            mysqlConn.setAutoCommit(<span class="org-constant">false</span>);

            <span class="org-type">int</span> <span class="org-variable-name">i</span> = 0;
            <span class="org-type">long</span> <span class="org-variable-name">startTime</span> = System.currentTimeMillis(); <span class="org-comment-delimiter">// </span><span class="org-comment">&#35745;&#26102;&#24320;&#22987;</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">&#26469;&#21543;&#65292;&#36801;&#31227;&#21543;&#65281;</span>
            <span class="org-keyword">while</span>(liteRs.next()) {
                <span class="org-keyword">for</span> (<span class="org-type">int</span> <span class="org-variable-name">j</span> = 1; j &lt; 20; j++) {
                    mysqlPs.setObject(j, liteRs.getObject(j));
                }
                mysqlPs.addBatch();

                <span class="org-comment-delimiter">// </span><span class="org-comment">&#27599; 10000 &#26465;&#65292;&#21521;&#25968;&#25454;&#24211;&#21457;&#36865;&#19968;&#27425;&#25191;&#34892;&#35831;&#27714;</span>
                <span class="org-keyword">if</span> (i++ % 10000 == 0) {
                    mysqlPs.executeBatch();
                }
            }

            mysqlPs.executeBatch();
            mysqlConn.commit();  <span class="org-comment-delimiter">// </span><span class="org-comment">&#25552;&#20132;&#20107;&#21153;</span>

            <span class="org-type">long</span> <span class="org-variable-name">stopTime</span> = System.currentTimeMillis(); <span class="org-comment-delimiter">// </span><span class="org-comment">&#35745;&#26102;&#32467;&#26463;</span>

            <span class="org-comment-delimiter">// </span><span class="org-comment">&#36755;&#20986;&#32467;&#26524;</span>
            System.out.println(<span class="org-string">"&#24635;&#20849;&#22810;&#23569;&#25968;&#25454;:"</span> + i);
            System.out.println(<span class="org-string">"&#19968;&#20849;&#33457;&#36153; "</span> + (stopTime - startTime) / 1000.0 + <span class="org-string">" &#31186;"</span>);

        } <span class="org-keyword">catch</span> (<span class="org-type">Exception</span> <span class="org-variable-name">e</span>) {
            DBUtil.tryRollback(mysqlConn);
        } <span class="org-keyword">finally</span> {
            DBUtil.tryRelease(liteConn, liteSt, liteRs);
            DBUtil.tryRelease(mysqlConn, mysqlPs, <span class="org-constant">null</span>);
        }
    }

    <span class="org-keyword">private</span> <span class="org-type">Connection</span> <span class="org-function-name">getSQLiteConnection</span>() <span class="org-keyword">throws</span> <span class="org-type">Exception</span> {
        Class.forName(<span class="org-string">"org.sqlite.JDBC"</span>);
        <span class="org-keyword">return</span> DriverManager.getConnection(<span class="org-string">"jdbc:sqlite:d:/data/lagou.db"</span>);
    }

    <span class="org-keyword">private</span> <span class="org-type">Connection</span> <span class="org-function-name">getMySQLConnection</span>() <span class="org-keyword">throws</span> <span class="org-type">Exception</span> {
        Class.forName(<span class="org-string">"org.mariadb.jdbc.Driver"</span>); <span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#24847; rewriteBatchedStatements &#21442;&#25968;&#65281;</span>
        <span class="org-keyword">return</span> DriverManager.getConnection(<span class="org-string">"jdbc:mariadb://127.0.0.1:3306/lagou?rewriteBatchedStatements=true"</span>, <span class="org-string">"root"</span>, <span class="org-string">"xxx"</span>);
    }
}

<span class="org-keyword">class</span> <span class="org-type">DBUtil</span> {

    <span class="org-comment-delimiter">// </span><span class="org-comment">&#37322;&#25918;&#36164;&#28304;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#24847;&#20851;&#38381;&#39034;&#24207;</span>
    <span class="org-comment-delimiter">// </span><span class="org-comment">&#27880;&#24847;&#24322;&#24120;&#22788;&#29702;&#26041;&#24335;</span>
    <span class="org-keyword">public</span> <span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">tryRelease</span>(<span class="org-type">Connection</span> <span class="org-variable-name">conn</span>, <span class="org-type">Statement</span> <span class="org-variable-name">st</span>, <span class="org-type">ResultSet</span> <span class="org-variable-name">rs</span>) {
        <span class="org-keyword">if</span> (rs != <span class="org-constant">null</span>) {
            <span class="org-keyword">try</span> {
                rs.close();
            } <span class="org-keyword">catch</span> (<span class="org-type">SQLException</span> <span class="org-variable-name">ignored</span>) {
            }
        }
        <span class="org-keyword">if</span> (st != <span class="org-constant">null</span>) {
            <span class="org-keyword">try</span> {
                st.close();
            } <span class="org-keyword">catch</span> (<span class="org-type">SQLException</span> <span class="org-variable-name">ignored</span>) {
            }
        }
        <span class="org-keyword">if</span> (conn != <span class="org-constant">null</span>) {
            <span class="org-keyword">try</span> {
                conn.close();
            } <span class="org-keyword">catch</span> (<span class="org-type">SQLException</span> <span class="org-variable-name">ignored</span>) {
            }
        }
    }

    <span class="org-comment-delimiter">// </span><span class="org-comment">&#23581;&#35797;&#22238;&#28378;</span>
    <span class="org-keyword">public</span> <span class="org-keyword">static</span> <span class="org-type">void</span> <span class="org-function-name">tryRollback</span>(<span class="org-type">Connection</span> <span class="org-variable-name">conn</span>) {
        <span class="org-keyword">try</span> {
            <span class="org-keyword">if</span> (conn != <span class="org-constant">null</span>) {
                conn.rollback();
            }
        } <span class="org-keyword">catch</span> (<span class="org-type">SQLException</span> <span class="org-variable-name">ignored</span>) {
        }
    }
}
</pre>
</div>
</div>
</div>
</section>

<section id="outline-container-org17dc9bf" class="outline-2">
<h2 id="org17dc9bf"><span class="section-number-2">15</span> 数据处理示例</h2>
<div class="outline-text-2" id="text-15">
</div>
<div id="outline-container-org3801940" class="outline-3">
<h3 id="org3801940"><span class="section-number-3">15.1</span> 数据清理</h3>
<div class="outline-text-3" id="text-15-1">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">lagou_position_result</span> <span class="org-keyword">as</span>
  <span class="org-keyword">select</span> <span class="org-keyword">distinct</span> *
  <span class="org-keyword">from</span> lagou_position
  <span class="org-keyword">where</span> pid <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> city <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> <span class="org-keyword">position</span> <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> field <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> salary_min <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> salary_max <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> workyear <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> education <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> ptype <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> pnature <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> advantage <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> company_id <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> company_short_name <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> company_full_name <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> company_size <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>
    <span class="org-keyword">and</span> financestage <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgea93cab" class="outline-3">
<h3 id="orgea93cab"><span class="section-number-3">15.2</span> 表的分离</h3>
<div class="outline-text-3" id="text-15-2">
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#28304;&#25968;&#25454;</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> china_city <span class="org-keyword">limit</span> 4;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_position_bk <span class="org-keyword">limit</span> 2; <span class="org-comment">-- lagou_position_bk (&#24037;&#20316;&#20449;&#24687;&#65292;&#22320;&#21306;&#20449;&#24687;&#65292;&#20998;&#31867;&#20449;&#24687;&#65292;&#20844;&#21496;&#20449;&#24687;)</span>


<span class="org-comment">-- &#35201;&#27714;&#65292;&#21019;&#24314;&#19977;&#24352;&#34920;</span>
<span class="org-comment">-- lagou_city (cityid, province, city, district)  # &#20840;&#22269;&#30340;&#30465;&#24066;&#21439;&#20449;&#24687;&#65292;&#38656;&#35201;&#20174; china_city &#34920;&#20013;&#25552;&#21462;&#20986;&#26469;</span>
<span class="org-comment">-- lagou_company (cid, name, short_name, size, financestage) # &#25152;&#26377;&#30340;&#20844;&#21496;&#34920;&#65292;&#20174; lagou_position_bk &#20013;&#20998;&#31163;&#20986;&#26469;</span>
<span class="org-comment">-- lagou_position (pid, cityid, cid, position, field, salary_min, salary_max, workyear, education, ptype, pnature, advantage, published_at, updated_at)</span>
</pre>
</div>

<p>
lagou_city 创建过程:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- 373 &#24066; 3341 &#21439; &#24635;&#21644; 3714</span>
<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> china_city <span class="org-keyword">where</span> <span class="org-keyword">depth</span>=2;
<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> china_city <span class="org-keyword">where</span> <span class="org-keyword">depth</span>=3;

<span class="org-comment">-- &#20998;&#27493;&#21019;&#24314;</span>

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">lagou_city01</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> d.id, p.cityName <span class="org-keyword">as</span> province, c.cityName <span class="org-keyword">as</span> city, d.cityName <span class="org-keyword">as</span> district <span class="org-keyword">from</span>
  (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> china_city <span class="org-keyword">where</span> <span class="org-keyword">depth</span>=3) d
    <span class="org-keyword">join</span> china_city c <span class="org-keyword">on</span> d.parentId = c.id <span class="org-keyword">and</span> c.<span class="org-keyword">depth</span>=2
    <span class="org-keyword">join</span> china_city p <span class="org-keyword">on</span> c.parentId = p.id <span class="org-keyword">and</span> p.<span class="org-keyword">depth</span>=1;

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> lagou_city01
<span class="org-keyword">select</span> c.id, p.cityName <span class="org-keyword">as</span> province, c.cityName <span class="org-keyword">as</span> city, <span class="org-keyword">null</span> <span class="org-keyword">as</span> district <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> china_city <span class="org-keyword">where</span> <span class="org-keyword">depth</span>=2) c
  <span class="org-keyword">join</span> china_city p <span class="org-keyword">on</span> c.parentId = p.id <span class="org-keyword">and</span> p.<span class="org-keyword">depth</span> = 1;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> lagou_city01;

<span class="org-comment">-- &#25110;&#32773;&#20351;&#29992; union &#35821;&#21477;</span>

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">lagou_city</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> d.id, p.cityName <span class="org-keyword">as</span> province, c.cityName <span class="org-keyword">as</span> city, d.cityName <span class="org-keyword">as</span> district <span class="org-keyword">from</span>
  (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> china_city <span class="org-keyword">where</span> <span class="org-keyword">depth</span>=3) d
    <span class="org-keyword">join</span> china_city c <span class="org-keyword">on</span> d.parentId = c.id <span class="org-keyword">and</span> c.<span class="org-keyword">depth</span>=2
    <span class="org-keyword">join</span> china_city p <span class="org-keyword">on</span> c.parentId = p.id <span class="org-keyword">and</span> p.<span class="org-keyword">depth</span>=1
<span class="org-keyword">union</span>
<span class="org-keyword">select</span> c.id, p.cityName <span class="org-keyword">as</span> province, c.cityName <span class="org-keyword">as</span> city, <span class="org-keyword">null</span> <span class="org-keyword">as</span> district <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> china_city <span class="org-keyword">where</span> <span class="org-keyword">depth</span>=2) c
  <span class="org-keyword">join</span> china_city p <span class="org-keyword">on</span> c.parentId = p.id <span class="org-keyword">and</span> p.<span class="org-keyword">depth</span> = 1;

</pre>
</div>

<p>
lagou_company 公司分离:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">drop</span> <span class="org-keyword">table</span> <span class="org-function-name">if</span> <span class="org-keyword">exists</span> lagou_company;
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">lagou_company</span> <span class="org-keyword">as</span>
  <span class="org-keyword">select</span> <span class="org-keyword">distinct</span> t.company_id         <span class="org-keyword">as</span> cid,
                  t.company_short_name <span class="org-keyword">as</span> short_name,
                  t.company_full_name  <span class="org-keyword">as</span> full_name,
                  t.company_size       <span class="org-keyword">as</span> <span class="org-keyword">size</span>,
                  t.financestage
  <span class="org-keyword">from</span> lagou_position_bk t;
</pre>
</div>

<p>
将公司、城市信息从主表分离出去:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">lagou_position</span>
<span class="org-keyword">as</span>
<span class="org-keyword">select</span> pid, cid <span class="org-keyword">as</span> city, company_id <span class="org-keyword">as</span> company, <span class="org-keyword">position</span>, field, salary_min, salary_max, workyear, education, ptype, pnature, advantage, published_at, updated_at <span class="org-keyword">from</span>
(
  <span class="org-comment">-- position &#34920;&#20013; district &#20026;&#31354;&#30340;&#25968;&#25454;</span>
  <span class="org-keyword">select</span> p.*, c.cid <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_position_bk <span class="org-keyword">where</span> district <span class="org-keyword">is</span> <span class="org-keyword">null</span>) p
     <span class="org-keyword">join</span> lagou_city c <span class="org-keyword">on</span> c.city <span class="org-keyword">like</span> concat(p.city, <span class="org-string">'%'</span>) <span class="org-keyword">and</span> c.district <span class="org-keyword">is</span> <span class="org-keyword">null</span>

  <span class="org-keyword">union</span> <span class="org-keyword">all</span>

  <span class="org-comment">-- position &#34920;&#20013; district &#19981;&#20026;&#31354;&#30340;&#25968;&#25454;</span>
  <span class="org-keyword">select</span> p.*, c.cid <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_position_bk <span class="org-keyword">where</span> district <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>) p
    <span class="org-keyword">join</span> lagou_city c <span class="org-keyword">on</span> c.city <span class="org-keyword">like</span> concat(p.city, <span class="org-string">'%'</span>) <span class="org-keyword">and</span> c.district <span class="org-keyword">like</span> concat(p.district, <span class="org-string">'%'</span>)

) <span class="org-keyword">as</span> ppp;


<span class="org-comment">-- &#20063;&#21487;&#20197;&#20998;&#27493;&#36827;&#34892;&#12290;&#20351;&#29992; union &#35821;&#21477;&#34429;&#28982;&#20250;&#31616;&#21270;&#35821;&#21477;&#65292;&#20294;&#25928;&#29575;&#20250;&#27604;&#36739;&#20302;</span>
<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">lagou_position</span> <span class="org-keyword">as</span>
<span class="org-keyword">select</span> pid, cid <span class="org-keyword">as</span> city, company_id <span class="org-keyword">as</span> company, <span class="org-keyword">position</span>, field, salary_min, salary_max, workyear, education, ptype, pnature, advantage, published_at, updated_at
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_position_bk <span class="org-keyword">where</span> district <span class="org-keyword">is</span> <span class="org-keyword">null</span>) p
  <span class="org-keyword">join</span> lagou_city c <span class="org-keyword">on</span> c.city <span class="org-keyword">like</span> concat(p.city, <span class="org-string">'%'</span>) <span class="org-keyword">and</span> c.district <span class="org-keyword">is</span> <span class="org-keyword">null</span>;

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> lagou_position
<span class="org-keyword">select</span> pid, cid <span class="org-keyword">as</span> city, company_id <span class="org-keyword">as</span> company, <span class="org-keyword">position</span>, field, salary_min, salary_max, workyear, education, ptype, pnature, advantage, published_at, updated_at
<span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_position_bk <span class="org-keyword">where</span> district <span class="org-keyword">is</span> <span class="org-keyword">not</span> <span class="org-keyword">null</span>) p
  <span class="org-keyword">join</span> lagou_city c <span class="org-keyword">on</span> c.city <span class="org-keyword">like</span> concat(p.city, <span class="org-string">'%'</span>) <span class="org-keyword">and</span> c.district <span class="org-keyword">like</span> concat(p.district, <span class="org-string">'%'</span>);
</pre>
</div>

<p>
注意:
</p>
<ul class="org-ul">
<li>分表过程中、分完的表，需要添加主键或索引，否则关联查询会特别特别慢</li>
<li>使用 create as 语句分表会比较简单，但这个过程存在数据的复制，会比较占用硬盘存储</li>
<li>除了 create as 语句，也可以在基表上进行数据操作（删改）。但是注意数据的备份，当心不慎操作导致的数据永久丢失</li>
<li>备份迁移需要在系统停机的情况下进行</li>
</ul>
</div>
</div>
</section>

<section id="outline-container-org77c6256" class="outline-2">
<h2 id="org77c6256"><span class="section-number-2">16</span> 省市县模式数据库设计</h2>
<div class="outline-text-2" id="text-16">
<p>
最朴素的实现方式:
</p>
<div class="org-src-container">
<pre class="src src-sql">  <span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">area_demo1</span> (
    area_id <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>,
    sheng <span class="org-type">varchar</span>(20) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
    shi <span class="org-type">varchar</span>(20) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
    xian <span class="org-type">varchar</span>(20) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
    quhao <span class="org-type">varchar</span>(20) <span class="org-keyword">not</span> <span class="org-keyword">null</span>,
    youbian <span class="org-type">varchar</span>(20),
    jingdu <span class="org-type">decimal</span>(10, 10),
    weidu <span class="org-type">decimal</span>(10, 10)
  );

<span class="org-keyword">insert</span> <span class="org-keyword">into</span> area_demo1 (sheng, shi, xian, quhao) <span class="org-keyword">values</span>
  (<span class="org-string">'&#24191;&#19996;&#30465;'</span>, <span class="org-string">'&#29664;&#28023;&#24066;'</span>, <span class="org-string">'&#26007;&#38376;&#21306;'</span>, <span class="org-string">'22323'</span>),
  (<span class="org-string">'&#24191;&#19996;&#30465;'</span>, <span class="org-string">'&#29664;&#28023;&#24066;'</span>, <span class="org-string">'&#39321;&#27954;&#21306;'</span>, <span class="org-string">'22324'</span>),
  (<span class="org-string">'&#24191;&#19996;&#30465;'</span>, <span class="org-string">'&#29664;&#28023;&#24066;'</span>, <span class="org-string">'&#37329;&#28286;&#21306;'</span>, <span class="org-string">'22325'</span>),
  (<span class="org-string">'&#24191;&#19996;&#30465;'</span>, <span class="org-string">'&#24191;&#24030;&#24066;'</span>, <span class="org-string">'&#22825;&#27827;&#21306;'</span>, <span class="org-string">'11155'</span>),
  (<span class="org-string">'&#24191;&#19996;&#30465;'</span>, <span class="org-string">'&#24191;&#24030;&#24066;'</span>, <span class="org-string">'&#36234;&#31168;&#21306;'</span>, <span class="org-string">'11156'</span>),
  (<span class="org-string">'&#24191;&#19996;&#30465;'</span>, <span class="org-string">'&#24191;&#24030;&#24066;'</span>, <span class="org-string">'&#30333;&#20113;&#21306;'</span>, <span class="org-string">'11157'</span>);

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> area_demo1 <span class="org-keyword">where</span> shi=<span class="org-string">'&#29664;&#28023;&#24066;'</span> <span class="org-keyword">or</span> shi=<span class="org-string">'&#24191;&#24030;&#24066;'</span>;

<span class="org-keyword">select</span> <span class="org-keyword">distinct</span> shi <span class="org-keyword">from</span> area_demo1 <span class="org-keyword">where</span> sheng=<span class="org-string">'&#24191;&#19996;&#30465;'</span>;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> area_demo1;
</pre>
</div>

<p>
按照范式，需要分表:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">s_sheng</span> (pid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>, p_name <span class="org-type">varchar</span>(20));
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> s_sheng (p_name) <span class="org-keyword">values</span> (<span class="org-string">'&#24191;&#19996;&#30465;'</span>), (<span class="org-string">'&#23665;&#19996;&#30465;'</span>), (<span class="org-string">'&#24191;&#35199;&#30465;'</span>), (<span class="org-string">'&#28246;&#21335;&#30465;'</span>);

<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">s_shi</span> (sid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>, s_name <span class="org-type">varchar</span>(20), sheng <span class="org-type">int</span> <span class="org-keyword">references</span> s_sheng(id));
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> s_shi (s_name, sheng) <span class="org-keyword">values</span>
  (<span class="org-string">'&#29664;&#28023;&#24066;'</span>, 1), (<span class="org-string">'&#24191;&#24030;&#24066;'</span>, 1), (<span class="org-string">'&#28251;&#27743;'</span>, 1),
  (<span class="org-string">'&#26690;&#26519;&#24066;'</span>, 3), (<span class="org-string">'&#21335;&#23425;&#24066;'</span>, 3), (<span class="org-string">'&#26611;&#24030;'</span>, 3);


<span class="org-keyword">create</span> <span class="org-keyword">table</span> <span class="org-function-name">s_xian</span> (xid <span class="org-type">int</span> auto_increment <span class="org-keyword">primary</span> <span class="org-keyword">key</span>, x_name <span class="org-type">varchar</span>(20), shi <span class="org-type">int</span> <span class="org-keyword">references</span> s_shi(id), youbian <span class="org-type">varchar</span>(20), jingdu <span class="org-type">varchar</span>(20), weidu  <span class="org-type">varchar</span>(20));
<span class="org-keyword">insert</span> <span class="org-keyword">into</span> s_xian (x_name, shi) <span class="org-keyword">values</span>
  (<span class="org-string">'&#26007;&#38376;&#21306;'</span>,  1), (<span class="org-string">'&#37329;&#28286;&#21306;'</span>, 1), (<span class="org-string">'&#39321;&#27954;&#21306;'</span>, 1),
  (<span class="org-string">'&#30333;&#20113;&#21306;'</span>, 2), (<span class="org-string">'&#36234;&#31168;&#21306;'</span>, 2), (<span class="org-string">'&#22825;&#27827;&#21306;'</span>, 2),
  (<span class="org-string">'&#38182;&#32483;&#21306;'</span>, 5), (<span class="org-string">'&#39118;&#26223;&#21306;'</span>, 5);

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_sheng;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_xian;

<span class="org-keyword">delete</span> <span class="org-keyword">from</span> s_xian <span class="org-keyword">where</span> xid &gt; 8;
</pre>
</div>

<p>
查询，以及语句:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#20840;&#36830;&#25509;&#65292;&#31515;&#21345;&#23572;&#31215;</span>
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi <span class="org-keyword">full</span> <span class="org-keyword">join</span> s_sheng;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi <span class="org-keyword">inner</span> <span class="org-keyword">join</span> s_sheng <span class="org-keyword">on</span> s_shi.sheng = s_sheng.id;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi s <span class="org-keyword">inner</span> <span class="org-keyword">join</span> s_sheng t <span class="org-keyword">on</span> s.sheng = t.id;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi s <span class="org-keyword">inner</span> <span class="org-keyword">join</span> s_sheng t <span class="org-keyword">on</span> s.sheng = t.id) w <span class="org-keyword">where</span> w.<span class="org-keyword">name</span> = <span class="org-string">'&#24191;&#19996;&#30465;'</span>;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> (<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi s <span class="org-keyword">inner</span> <span class="org-keyword">join</span> s_sheng t <span class="org-keyword">on</span> s.sheng = t.pid) w <span class="org-keyword">where</span> w.p_name = <span class="org-string">'&#24191;&#19996;&#30465;'</span>;


<span class="org-keyword">select</span> sid, s_name <span class="org-keyword">from</span> (
<span class="org-keyword">select</span> s.sid, s.s_name, p.p_name <span class="org-keyword">from</span> s_shi s <span class="org-keyword">join</span> s_sheng p <span class="org-keyword">on</span> s.sheng = p.pid
) a <span class="org-keyword">where</span> p_name = <span class="org-string">'&#24191;&#19996;&#30465;'</span>;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_xian x
       <span class="org-keyword">inner</span> <span class="org-keyword">join</span> s_shi s <span class="org-keyword">on</span> x.shi = s.sid
       <span class="org-keyword">inner</span> <span class="org-keyword">join</span> s_sheng sh <span class="org-keyword">on</span> s.sheng = sh.pid
<span class="org-keyword">where</span> sh.p_name = <span class="org-string">'&#24191;&#19996;&#30465;'</span>;

<span class="org-keyword">select</span> x.* <span class="org-keyword">from</span> s_xian x
       <span class="org-keyword">join</span> s_shi <span class="org-keyword">on</span> s_shi.sid = x.shi
       <span class="org-keyword">join</span> s_sheng <span class="org-keyword">on</span> s_shi.sheng = s_sheng.pid
    <span class="org-keyword">where</span> p_name = <span class="org-string">'&#24191;&#35199;&#30465;'</span>;

<span class="org-keyword">select</span> x.* <span class="org-keyword">from</span> s_xian x
       <span class="org-keyword">join</span> s_shi <span class="org-keyword">on</span> s_shi.sid = x.shi
       <span class="org-keyword">where</span> s_name = <span class="org-string">'&#29664;&#28023;&#24066;'</span>;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_sheng;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_xian;

<span class="org-keyword">select</span> x.* <span class="org-keyword">from</span> s_xian x, s_shi s, s_sheng p
   <span class="org-keyword">where</span> x.shi = s.sid
         <span class="org-keyword">and</span> s.sheng = p.pid
         <span class="org-keyword">and</span> p.p_name = <span class="org-string">'&#24191;&#35199;&#30465;'</span>;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi s
  <span class="org-keyword">left</span> <span class="org-keyword">join</span> s_sheng p <span class="org-keyword">on</span> s.sheng = p.pid;


<span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_position_result <span class="org-keyword">limit</span> 5;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> company_result <span class="org-keyword">limit</span> 5;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_provinces <span class="org-keyword">limit</span> 5;

<span class="org-keyword">select</span> <span class="org-builtin">count</span>(*) <span class="org-keyword">from</span> lagou_position_result;


<span class="org-keyword">desc</span> s_provinces;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_sheng <span class="org-keyword">limit</span> 1;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_shi <span class="org-keyword">limit</span> 1;
<span class="org-keyword">select</span> * <span class="org-keyword">from</span> s_provinces <span class="org-keyword">limit</span> 5;

<span class="org-keyword">select</span> * <span class="org-keyword">from</span> lagou_position_result <span class="org-keyword">order</span> <span class="org-keyword">by</span> salary_min <span class="org-keyword">desc</span> <span class="org-keyword">limit</span> 10;
</pre>
</div>

<p>
合并为一张表的方式，连接自己:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CREATE</span> <span class="org-keyword">TABLE</span> `s_provinces` (
  `id` <span class="org-type">int</span>(11) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `cityName` <span class="org-type">varchar</span>(30) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `parentId` <span class="org-type">int</span>(11) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `shortName` <span class="org-type">varchar</span>(30) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `<span class="org-keyword">depth</span>` <span class="org-type">int</span>(1) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `cityCode` <span class="org-type">varchar</span>(4) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `zipCode` <span class="org-type">varchar</span>(6) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `mergerName` <span class="org-type">varchar</span>(50) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `longitude` <span class="org-type">varchar</span>(16) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `latitude` <span class="org-type">varchar</span>(16) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `pinyin` <span class="org-type">varchar</span>(30) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  `isUse` <span class="org-type">int</span>(1) unsigned zerofill <span class="org-keyword">DEFAULT</span> <span class="org-keyword">NULL</span>
) ENGINE=InnoDB <span class="org-keyword">DEFAULT</span> CHARSET=utf8
</pre>
</div>

<p>
查询广东省所有县市:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#25152;&#26377;&#21439;</span>
<span class="org-keyword">select</span> x.id, p.cityName, s.cityName, x.cityName
<span class="org-keyword">from</span> s_provinces x
       <span class="org-keyword">join</span> s_provinces s <span class="org-keyword">on</span> x.parentId = s.id
       <span class="org-keyword">join</span> s_provinces p <span class="org-keyword">on</span> s.parentId = p.id
<span class="org-keyword">where</span> p.cityName = <span class="org-string">'&#24191;&#19996;&#30465;'</span>;

<span class="org-comment">-- &#25152;&#26377;&#24066;</span>
<span class="org-keyword">select</span> x.id, p.cityName, s.cityName, x.cityName
<span class="org-keyword">from</span> s_provinces x
       <span class="org-keyword">join</span> s_provinces s <span class="org-keyword">on</span> x.parentId = s.id
       <span class="org-keyword">join</span> s_provinces p <span class="org-keyword">on</span> s.parentId = p.id
<span class="org-keyword">where</span> p.cityName = <span class="org-string">'&#24191;&#19996;&#30465;'</span>
<span class="org-keyword">union</span> <span class="org-keyword">all</span>
<span class="org-keyword">select</span> s.id, p.cityName, s.cityName, <span class="org-keyword">null</span> <span class="org-keyword">from</span> s_provinces s
       <span class="org-keyword">join</span> s_provinces p <span class="org-keyword">on</span> s.parentId = p.id
<span class="org-keyword">where</span> p.cityName = <span class="org-string">'&#24191;&#19996;&#30465;'</span>;
</pre>
</div>

<p>
请总结各种方式的优劣。
</p>
</div>
</section>

<section id="outline-container-org65288bb" class="outline-2">
<h2 id="org65288bb"><span class="section-number-2">17</span> 查询练习</h2>
<div class="outline-text-2" id="text-17">
<p>
创建表:
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">DROP</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">IF</span> <span class="org-keyword">EXISTS</span> emp;

<span class="org-keyword">CREATE</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">emp</span> (
  empno <span class="org-type">decimal</span>(4,0) <span class="org-keyword">NOT</span> <span class="org-keyword">NULL</span>,
  ename <span class="org-type">varchar</span>(10) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>,
  job <span class="org-type">varchar</span>(9) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>,
  mgr <span class="org-type">decimal</span>(4,0) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>,
  hiredate <span class="org-type">date</span> <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>,
  sal <span class="org-type">decimal</span>(7,2) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>,
  comm <span class="org-type">decimal</span>(7,2) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>,
  deptno <span class="org-type">decimal</span>(2,0) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>
);

<span class="org-keyword">DROP</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">IF</span> <span class="org-keyword">EXISTS</span> dept;

<span class="org-keyword">CREATE</span> <span class="org-keyword">TABLE</span> <span class="org-function-name">dept</span> (
  deptno <span class="org-type">decimal</span>(2,0) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>,
  dname <span class="org-type">varchar</span>(14) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>,
  loc <span class="org-type">varchar</span>(13) <span class="org-keyword">default</span> <span class="org-keyword">NULL</span>
);

<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7369'</span>,<span class="org-string">'SMITH'</span>,<span class="org-string">'CLERK'</span>,<span class="org-string">'7902'</span>,<span class="org-string">'1980-12-17'</span>,<span class="org-string">'800.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'20'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7499'</span>,<span class="org-string">'ALLEN'</span>,<span class="org-string">'SALESMAN'</span>,<span class="org-string">'7698'</span>,<span class="org-string">'1981-02-20'</span>,<span class="org-string">'1600.00'</span>,<span class="org-string">'300.00'</span>,<span class="org-string">'30'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7521'</span>,<span class="org-string">'WARD'</span>,<span class="org-string">'SALESMAN'</span>,<span class="org-string">'7698'</span>,<span class="org-string">'1981-02-22'</span>,<span class="org-string">'1250.00'</span>,<span class="org-string">'500.00'</span>,<span class="org-string">'30'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7566'</span>,<span class="org-string">'JONES'</span>,<span class="org-string">'MANAGER'</span>,<span class="org-string">'7839'</span>,<span class="org-string">'1981-04-02'</span>,<span class="org-string">'2975.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'20'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7654'</span>,<span class="org-string">'MARTIN'</span>,<span class="org-string">'SALESMAN'</span>,<span class="org-string">'7698'</span>,<span class="org-string">'1981-09-28'</span>,<span class="org-string">'1250.00'</span>,<span class="org-string">'1400.00'</span>,<span class="org-string">'30'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7698'</span>,<span class="org-string">'BLAKE'</span>,<span class="org-string">'MANAGER'</span>,<span class="org-string">'7839'</span>,<span class="org-string">'1981-05-01'</span>,<span class="org-string">'2850.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'30'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7782'</span>,<span class="org-string">'CLARK'</span>,<span class="org-string">'MANAGER'</span>,<span class="org-string">'7839'</span>,<span class="org-string">'1981-06-09'</span>,<span class="org-string">'2450.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'10'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7788'</span>,<span class="org-string">'SCOTT'</span>,<span class="org-string">'ANALYST'</span>,<span class="org-string">'7566'</span>,<span class="org-string">'1982-12-09'</span>,<span class="org-string">'3000.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'20'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7839'</span>,<span class="org-string">'KING'</span>,<span class="org-string">'PRESIDENT'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'1981-11-17'</span>,<span class="org-string">'5000.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'10'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7844'</span>,<span class="org-string">'TURNER'</span>,<span class="org-string">'SALESMAN'</span>,<span class="org-string">'7698'</span>,<span class="org-string">'1981-09-08'</span>,<span class="org-string">'1500.00'</span>,<span class="org-string">'0.00'</span>,<span class="org-string">'30'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7876'</span>,<span class="org-string">'ADAMS'</span>,<span class="org-string">'CLERK'</span>,<span class="org-string">'7788'</span>,<span class="org-string">'1983-01-12'</span>,<span class="org-string">'1100.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'20'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7900'</span>,<span class="org-string">'JAMES'</span>,<span class="org-string">'CLERK'</span>,<span class="org-string">'7698'</span>,<span class="org-string">'1981-12-03'</span>,<span class="org-string">'950.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'30'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7902'</span>,<span class="org-string">'FORD'</span>,<span class="org-string">'ANALYST'</span>,<span class="org-string">'7566'</span>,<span class="org-string">'1981-12-03'</span>,<span class="org-string">'3000.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'20'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> emp <span class="org-keyword">VALUES</span> (<span class="org-string">'7934'</span>,<span class="org-string">'MILLER'</span>,<span class="org-string">'CLERK'</span>,<span class="org-string">'7782'</span>,<span class="org-string">'1982-01-23'</span>,<span class="org-string">'1300.00'</span>,<span class="org-keyword">NULL</span>,<span class="org-string">'10'</span>);

<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> dept <span class="org-keyword">VALUES</span> (<span class="org-string">'10'</span>,<span class="org-string">'ACCOUNTING'</span>,<span class="org-string">'NEW YORK'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> dept <span class="org-keyword">VALUES</span> (<span class="org-string">'20'</span>,<span class="org-string">'RESEARCH'</span>,<span class="org-string">'DALLAS'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> dept <span class="org-keyword">VALUES</span> (<span class="org-string">'30'</span>,<span class="org-string">'SALES'</span>,<span class="org-string">'CHICAGO'</span>);
<span class="org-keyword">INSERT</span> <span class="org-keyword">INTO</span> dept <span class="org-keyword">VALUES</span> (<span class="org-string">'40'</span>,<span class="org-string">'OPERATIONS'</span>,<span class="org-string">'BOSTON'</span>);
</pre>
</div>

<p>
1:
</p>
<ul class="org-ul">
<li>在芝加哥工作的人中，谁的工资最高</li>
<li>查询每个部门下有多少员工</li>
<li>查询除去 salesman 所有平均工资超过 1500 的部门</li>
<li>查询在 new york 工作的所有员工的姓名，部门名称和工资信息</li>
<li>查询姓名为 King 的员工的编号，名称跟部门</li>
<li>查询各种工作的最低工资</li>
<li>查询工龄大于10年的所有员工信息</li>
<li>查询每个部门员工数量，平均工资和平均工作年限</li>
<li>统计各部门每个工种的人数，平均工资。</li>
<li>查询从事同一种工作但不属于同一部门的员工信息。</li>
<li>查询所有员工工资都大于1000的部门的信息及员工信息</li>
<li>查询入职日期早于其直接上级的所有员工信息。</li>
<li>列出雇员中（除去mgr为空的人)工资第二高的人。</li>
<li>列出1981年来公司所有员工的总收入（包括sal和comm）</li>
</ul>

<p>
2:
</p>
<ul class="org-ul">
<li>查询工资为 2500 到 4000 的人的数量（用不同方式查询）</li>
<li>查询部门编号为 10 和 30 的所有人（用不同方式查询）</li>
<li>查询部门编号为 10 和 30 中名字中不含有 ‘C’ 的所有人</li>
<li>查询部门编号为 10 和 30 中名字首字母之外不含有 ‘C’ 的所有人</li>
<li>查询部门编号为 10 和 30 中所有的经理以及名字首字母之外不含有 ‘C’ 的所有人</li>
<li>查询纽约和芝加哥地区所有的经理以及名字首字母之外不含有 ‘C’ 的所有人</li>
<li>查询纽约和芝加哥地区所有的经理以及顶头上司名字的首字母之外不含有 ‘C’ 的所有人</li>
<li>查询每个人的工资等级</li>
<li>查询每个部门的平均工资的等级</li>
</ul>

<p>
3:
</p>
<ul class="org-ul">
<li>查询每个组最高工资的那些人</li>
<li><p>
有下面一个表，写一条 sql 语句计算男女之差
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">gender</th>
<th scope="col" class="org-right">number</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">男</td>
<td class="org-right">46</td>
</tr>

<tr>
<td class="org-left">女</td>
<td class="org-right">10</td>
</tr>
</tbody>
</table></li>
<li><p>
给 emp 中的人加工资，请写出相关语句:
</p>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">条件</th>
<th scope="col" class="org-right">加多少</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">1000元以下</td>
<td class="org-right">50%</td>
</tr>

<tr>
<td class="org-left">2000元以下</td>
<td class="org-right">30%</td>
</tr>

<tr>
<td class="org-left">3000元以下</td>
<td class="org-right">20%</td>
</tr>

<tr>
<td class="org-left">其他</td>
<td class="org-right">5%</td>
</tr>
</tbody>
</table></li>
<li>给 emp 中的人加工资，如上。但 1981/5/1 之后来的所有人，只加 2%, 请写出语句。</li>
<li>计算你们从入学到现在过了多少个周末</li>
<li>计算你们从现在到毕业还有多少天，还有多少个周末</li>
<li>计算你们在学校的时间内，每天花费多少钱</li>
</ul>
</div>
</section>
</div>
<div id="postamble" class="status">
<p class="author">Author: 孙悟空</p>
<p class="date">Created: 2018-11-22 周四 02:16</p>
<p class="validation">Go ahead, never stop.</p>
</div>
</body>
</html>
